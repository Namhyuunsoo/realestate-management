/* -----------------------------------------
 * main.js  (ë¡œê·¸ì¸ í™”ë©´ + ë„¤ì´ë²„ ì§€ë„ + í•„í„°/ë¦¬ìŠ¤íŠ¸ + ìƒë‹¨ ê°€ë¡œ í•„í„°)
 * -----------------------------------------
 * - UI: ë¡œê·¸ì¸ ìŠ¤í¬ë¦° / ì•± í™”ë©´ ì „í™˜
 * - ì‚¬ìš©ì: ì„¸ì…˜(/api/me) + ì„ì‹œ ì´ë©”ì¼(localStorage)
 * - ì§€ë„: ë„¤ì´ë²„ ì§€ë„ SDK, ë§ˆì»¤ í‘œì‹œ
 * - ë°ì´í„°: /api/listings (X-User í—¤ë”)
 * - í•„í„°: ê³ ê° ê¸°ë³¸ í•„í„° + ìƒë‹¨ í•„í„°(ìš°ì„ ) + (ê¸°ì¡´ ì¢Œì¸¡ í•„í„° ìœ ì§€)
 * - ì •ë ¬/íƒœê·¸/ê±°ë¦¬ ê³„ì‚°
 * - íŒ¨ë„: ê³ ê° ìƒì„¸/ì‹ ê·œë“±ë¡(2ì°¨ ì‚¬ì´ë“œë°”), ì „ì²´ë³´ê¸° íŒ¨ë„(ë¶€ë¶„ ì˜¤ë²„ë ˆì´)
 * - ìƒ‰ì¸(í•€): ì¤€ë¹„(ë¡œì»¬ìŠ¤í† ë¦¬ì§€) - ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„
 * ----------------------------------------- */

/*******************************
 * ===== main.js - ë‚˜ë¨¸ì§€ ê¸°ëŠ¥ë“¤ =====
 *******************************/
// ì „ì—­ ë³€ìˆ˜ë“¤ì€ globals.jsì—ì„œ ì´ë¯¸ ì„ ì–¸ë¨
let BRIEFING_FILTERS = {
  normal: true,
  pending: true,
  completed: true,
  onhold: true
};

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ì€ utils.jsì—ì„œ ì´ë¯¸ ì •ì˜ë¨

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ì€ utils.jsì—ì„œ ì´ë¯¸ ì •ì˜ë¨

/**************************************
 * ===== ë¸Œë¦¬í•‘ ìƒíƒœ ê´€ë¦¬ =====
 **************************************/
function loadBriefingStates(customerId) {
  if (!customerId) {
    CURRENT_BRIEFING_STATES = {};
    return;
  }
  
  try {
    const stored = localStorage.getItem(`briefing_${customerId}`);
    CURRENT_BRIEFING_STATES = stored ? JSON.parse(stored) : {};
  } catch (e) {
    console.error('ë¸Œë¦¬í•‘ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', e);
    CURRENT_BRIEFING_STATES = {};
  }
}

function saveBriefingStates(customerId) {
  if (!customerId) return;
  
  try {
    localStorage.setItem(`briefing_${customerId}`, JSON.stringify(CURRENT_BRIEFING_STATES));
  } catch (e) {
    console.error('ë¸Œë¦¬í•‘ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', e);
  }
}

function getBriefingStatus(listingId) {
  return CURRENT_BRIEFING_STATES[listingId] || BRIEFING_STATUS.NORMAL;
}

function setBriefingStatus(listingId, status) {
  if (status === BRIEFING_STATUS.NORMAL) {
    delete CURRENT_BRIEFING_STATES[listingId];
  } else {
    CURRENT_BRIEFING_STATES[listingId] = status;
  }
  
  // í˜„ì¬ ì„ íƒëœ ê³ ê°ì´ ìˆìœ¼ë©´ ì €ì¥
  if (window.selectedCustomer && window.selectedCustomer.id) {
    saveBriefingStates(window.selectedCustomer.id);
  }
  
  // UI ì—…ë°ì´íŠ¸
  updateBriefingStatusUI(listingId, status);
  updateMarkerBriefingStatus(listingId, status);
}

function updateBriefingStatusUI(listingId, status) {
  // ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  const listItem = document.querySelector(`#listingList li[data-id="${listingId}"]`);
  if (listItem) {
    updateListingItemBriefingStatus(listItem, status);
  }
  
  // í´ëŸ¬ìŠ¤í„° ëª©ë¡ ì—…ë°ì´íŠ¸
  const clusterItem = document.querySelector(`#clusterItemList li[data-id="${listingId}"]`);
  if (clusterItem) {
    updateListingItemBriefingStatus(clusterItem, status);
  }
  
  // ë§¤ë¬¼ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
  if (SELECTED_MARKER_ID === listingId) {
    updateDetailPanelBriefingStatus(status);
  }
}

function updateListingItemBriefingStatus(listItem, status) {
  let indicator = listItem.querySelector('.briefing-status-indicator');
  
  if (!indicator) {
    indicator = document.createElement('div');
    indicator.className = 'briefing-status-indicator';
    listItem.style.position = 'relative';
    listItem.appendChild(indicator);
  }
  
  // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
  indicator.className = 'briefing-status-indicator';
  indicator.classList.add(`briefing-${status}`);
  
  // í´ë¦­ ì´ë²¤íŠ¸
  indicator.onclick = (e) => {
    e.stopPropagation();
    cycleBriefingStatus(listItem.dataset.id);
  };
}

function updateDetailPanelBriefingStatus(status) {
  const detailPanel = document.getElementById('viewListingDetail');
  if (!detailPanel) return;
  
  let statusElement = detailPanel.querySelector('.listing-detail-briefing-status');
  
  if (!statusElement) {
    // ì£¼ì†Œ ì •ë³´ ë‹¤ìŒì— ìƒíƒœ í‘œì‹œ ì¶”ê°€
    const addrElement = detailPanel.querySelector('.detail-row');
    if (addrElement) {
      statusElement = document.createElement('span');
      statusElement.className = 'listing-detail-briefing-status';
      statusElement.onclick = () => cycleBriefingStatus(SELECTED_MARKER_ID);
      addrElement.appendChild(statusElement);
    }
  }
  
  if (statusElement) {
    statusElement.className = 'listing-detail-briefing-status';
    statusElement.classList.add(`briefing-${status}`);
    statusElement.textContent = getBriefingStatusText(status);
  }
}
function updateMarkerBriefingStatus(listingId, status) {
  const marker = MARKERS.find(m => m._listingId === listingId);
  if (!marker) return;
  
  const color = STATUS_COLORS[LISTINGS.find(x => x.id === listingId)?.status_raw] || "#007AFF";
  const isActive = (marker._listingId === SELECTED_MARKER_ID);
  
  marker.setIcon({ 
    content: createMarkerIcon(color, isActive, status)
  });
  
  // í´ëŸ¬ìŠ¤í„° ë²„ë¸”ë„ ì—…ë°ì´íŠ¸
  updateClusterBubbles();
}

function updateClusterBubbles() {
  if (!CLUSTERER || !CLUSTERER._clusters) return;
  
  CLUSTERER._clusters.forEach(cluster => {
    const clusterMarker = cluster._clusterMarker;
    if (!clusterMarker || !cluster.getClusterMember) return;
    
    const clusterMembers = cluster.getClusterMember();
    if (!clusterMembers) return;
    
    const count = clusterMembers.length;
    let cls = "cluster-small";
    if (count >= 50)      cls = "cluster-big";
    else if (count >= 10) cls = "cluster-mid";

    // í´ëŸ¬ìŠ¤í„° ë‚´ ë§¤ë¬¼ë“¤ì˜ ë¸Œë¦¬í•‘ ìƒíƒœ ë¶„ì„
    const briefingStats = {
      normal: 0,
      pending: 0,
      completed: 0,
      onhold: 0
    };
    
    clusterMembers.forEach(marker => {
      if (marker && marker._listingId) {
        const status = getBriefingStatus(marker._listingId);
        briefingStats[status]++;
      }
    });
    
    // ë¸Œë¦¬í•‘ ìƒíƒœì— ë”°ë¥¸ ë²„ë¸” ìŠ¤íƒ€ì¼ ê²°ì •
    let bubbleStyle = "";
    let bubbleContent = count;
    
    // ë¸Œë¦¬í•‘ ìƒíƒœê°€ ìˆëŠ” ë§¤ë¬¼ì´ ìˆìœ¼ë©´ ìƒ‰ìƒ ë³€ê²½
    const hasBriefingItems = briefingStats.pending > 0 || briefingStats.completed > 0 || briefingStats.onhold > 0;
    
    if (hasBriefingItems) {
      // ì£¼ìš” ë¸Œë¦¬í•‘ ìƒíƒœ ê²°ì • (ìš°ì„ ìˆœìœ„: ì™„ë£Œ > ì˜ˆì • > ë³´ë¥˜)
      let primaryStatus = BRIEFING_STATUS.NORMAL;
      if (briefingStats.completed > 0) {
        primaryStatus = BRIEFING_STATUS.COMPLETED;
      } else if (briefingStats.pending > 0) {
        primaryStatus = BRIEFING_STATUS.PENDING;
      } else if (briefingStats.onhold > 0) {
        primaryStatus = BRIEFING_STATUS.ONHOLD;
      }
      
      // ë¸Œë¦¬í•‘ ìƒíƒœë³„ ìƒ‰ìƒ
      const statusColors = {
        [BRIEFING_STATUS.NORMAL]: '#007AFF',
        [BRIEFING_STATUS.PENDING]: '#FF3B30',
        [BRIEFING_STATUS.COMPLETED]: '#34C759',
        [BRIEFING_STATUS.ONHOLD]: '#AF52DE'
      };
      
      bubbleStyle = `background-color: ${statusColors[primaryStatus]} !important; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);`;
    }

    const bubbleHtml = `<div class="cluster-bubble ${cls}" style="${bubbleStyle}">${bubbleContent}</div>`;
    const wrapper = clusterMarker.getElement();
    if (wrapper) {
      wrapper.innerHTML = bubbleHtml;
    }
  });
}

function cycleBriefingStatus(listingId) {
  const currentStatus = getBriefingStatus(listingId);
  const statusOrder = [BRIEFING_STATUS.NORMAL, BRIEFING_STATUS.PENDING, BRIEFING_STATUS.COMPLETED, BRIEFING_STATUS.ONHOLD];
  const currentIndex = statusOrder.indexOf(currentStatus);
  const nextIndex = (currentIndex + 1) % statusOrder.length;
  const nextStatus = statusOrder[nextIndex];
  
  setBriefingStatus(listingId, nextStatus);
}

function getBriefingStatusText(status) {
  const statusTexts = {
    [BRIEFING_STATUS.NORMAL]: 'ì¼ë°˜',
    [BRIEFING_STATUS.PENDING]: 'ì˜ˆì •',
    [BRIEFING_STATUS.COMPLETED]: 'ì™„ë£Œ',
    [BRIEFING_STATUS.ONHOLD]: 'ë³´ë¥˜'
  };
  return statusTexts[status] || 'ì¼ë°˜';
}

function applyBriefingFilters() {
  console.log('applyBriefingFilters í˜¸ì¶œë¨');
  console.log('í˜„ì¬ ë¸Œë¦¬í•‘ í•„í„° ìƒíƒœ:', BRIEFING_FILTERS);
  
  // ë¸Œë¦¬í•‘ í•„í„°ê°€ ì²´í¬ëœ ìƒíƒœë“¤ í™•ì¸
  const checkedStatuses = Object.keys(BRIEFING_FILTERS).filter(status => BRIEFING_FILTERS[status]);
  console.log('ì²´í¬ëœ ë¸Œë¦¬í•‘ ìƒíƒœë“¤:', checkedStatuses);
  
  let listingsToShow;
  
  if (checkedStatuses.length > 0) {
    // ì²´í¬ëœ ë¸Œë¦¬í•‘ ìƒíƒœì˜ ë§¤ë¬¼ë“¤ë§Œ í‘œì‹œ
    listingsToShow = FILTERED_LISTINGS.filter(item => {
      const status = getBriefingStatus(item.id);
      const shouldShow = checkedStatuses.includes(status);
      console.log(`ë§¤ë¬¼ ${item.id}: ë¸Œë¦¬í•‘ ìƒíƒœ=${status}, í‘œì‹œ=${shouldShow}`);
      return shouldShow;
    });
  } else {
    // ì•„ë¬´ê²ƒë„ ì²´í¬ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëª¨ë“  ë§¤ë¬¼ í‘œì‹œ
    listingsToShow = [...FILTERED_LISTINGS];
  }
  
  console.log(`í•„í„°ë§ ê²°ê³¼: ${FILTERED_LISTINGS.length}ê°œ â†’ ${listingsToShow.length}ê°œ`);
  
  placeMarkers(listingsToShow);
  
  // ë¸Œë¦¬í•‘ë¦¬ìŠ¤íŠ¸ ëª¨ë“œì¼ ë•ŒëŠ” ë¸Œë¦¬í•‘ë¦¬ìŠ¤íŠ¸ë¥¼ ë Œë”ë§, ì•„ë‹ˆë©´ ì¼ë°˜ ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸
  if (UI_STATE.isBriefingListMode) {
    renderBriefingList();
  } else {
    renderListingList(listingsToShow);
  }
  
  updateCountsDisplay(FILTERED_LISTINGS.length, listingsToShow.length);
}

function initializeBriefingFilters() {
  const filterIds = ['filterNormal', 'filterPending', 'filterCompleted', 'filterOnHold'];
  const filterKeys = ['normal', 'pending', 'completed', 'onhold'];
  
  filterIds.forEach((id, index) => {
    const checkbox = document.getElementById(id);
    if (checkbox) {
      checkbox.checked = BRIEFING_FILTERS[filterKeys[index]];
      checkbox.addEventListener('change', (e) => {
        BRIEFING_FILTERS[filterKeys[index]] = e.target.checked;
        applyBriefingFilters();
      });
    }
  });
} 

/**************************************
 * ===== ë¡œê·¸ì¸ í™”ë©´ í† ê¸€ =====
 **************************************/
function showLoginScreen(msg = "") {
  console.log("ğŸ” showLoginScreen í˜¸ì¶œë¨:", msg);
  
  const login   = document.getElementById("loginScreen");
  const appRoot = document.getElementById("appRoot");
  
  if (login) {
    login.classList.remove("hidden");
    login.style.display = "block";
    console.log("âœ… ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ");
  }
  
  if (appRoot) {
    appRoot.classList.add("hidden");
    appRoot.style.display = "none";
    console.log("âœ… ì•± í™”ë©´ ìˆ¨ê¹€");
  }

  const m = document.getElementById("loginErrorMsg");
  if (m) m.textContent = msg || "";
}

function hideLoginScreen() {
  console.log("ğŸ” hideLoginScreen í˜¸ì¶œë¨");
  
  const login   = document.getElementById("loginScreen");
  const appRoot = document.getElementById("appRoot");
  
  if (login) {
    login.classList.add("hidden");
    login.style.display = "none";
    console.log("âœ… ë¡œê·¸ì¸ í™”ë©´ ìˆ¨ê¹€");
  }
  
  if (appRoot) {
    appRoot.classList.remove("hidden");
    appRoot.style.display = "block";
    console.log("âœ… ì•± í™”ë©´ í‘œì‹œ");
  }

  toggleLoginLogoutUI(!!currentUser);
  fixMapLayoutAfterShow();
}

/**************************************
 * ===== ì‚¬ìš©ì(ì„¸ì…˜/ìˆ˜ë™) ì²˜ë¦¬ =====
 **************************************/
function setCurrentUser(email) {
  currentUser = email;
  localStorage.setItem("X-USER", email);
  const stat = document.getElementById("userStatus");
  if (stat) stat.textContent = email ? `ì‚¬ìš©ì: ${email}` : "ì‚¬ìš©ì ì—†ìŒ";
  toggleLoginLogoutUI(!!email);
}

function loadUserFromStorage() {
  const u = localStorage.getItem("X-USER");
  if (u) setCurrentUser(u);
}

function toggleLoginLogoutUI(isLoggedIn) {
  const loginBtn = document.getElementById("naverLoginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const manualWrap = document.getElementById("manualUserWrap");

  if (loginBtn)  loginBtn.classList.toggle("hidden", isLoggedIn);
  if (logoutBtn) logoutBtn.classList.toggle("hidden", !isLoggedIn);
  if (manualWrap) manualWrap.classList.toggle("hidden", isLoggedIn);
}

function applyUser() {
  console.log("ğŸ” applyUser í•¨ìˆ˜ í˜¸ì¶œë¨");
  
  const loginInp  = document.getElementById("loginEmail");
  const manualInp = document.getElementById("userEmail");

  let email = "";
  if (loginInp && loginInp.value.trim()) {
    email = loginInp.value.trim();
    console.log("ğŸ” ë¡œê·¸ì¸ ì´ë©”ì¼ ì…ë ¥:", email);
  } else if (manualInp && manualInp.value.trim()) {
    email = manualInp.value.trim();
    console.log("ğŸ” ìˆ˜ë™ ì´ë©”ì¼ ì…ë ¥:", email);
  }

  if (!email) {
    const m = document.getElementById("loginErrorMsg");
    if (m) m.textContent = "ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.";
    console.log("âŒ ì´ë©”ì¼ì´ ì…ë ¥ë˜ì§€ ì•ŠìŒ");
    return;
  }

  const EMAIL_RE = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
  if (!EMAIL_RE.test(email)) {
    const m = document.getElementById("loginErrorMsg");
    if (m) m.textContent = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.";
    console.log("âŒ ì´ë©”ì¼ í˜•ì‹ ì˜¤ë¥˜:", email);
    return;
  }

  console.log("âœ… ì´ë©”ì¼ ê²€ì¦ í†µê³¼:", email);
  
  // ì‚¬ìš©ì ì„¤ì •
  setCurrentUser(email);
  
  // ë¡œê·¸ì¸ í™”ë©´ ê°•ì œ ìˆ¨ê¹€
  const loginScreen = document.getElementById("loginScreen");
  const appRoot = document.getElementById("appRoot");
  
  if (loginScreen) {
    loginScreen.classList.add("hidden");
    loginScreen.style.display = "none";
    console.log("âœ… ë¡œê·¸ì¸ í™”ë©´ ìˆ¨ê¹€");
  }
  
  if (appRoot) {
    appRoot.classList.remove("hidden");
    appRoot.style.display = "block";
    console.log("âœ… ì•± í™”ë©´ í‘œì‹œ");
  }

  // ë§¤ë¬¼ ë°ì´í„° ë¡œë“œ
  runAfterMapReady(() => {
    // ì¬ë¡œê·¸ì¸ ì‹œì—ëŠ” í•­ìƒ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œ
    FETCH_CALLED_ONCE = true;
    fetchListings();
    console.log("âœ… ë§¤ë¬¼ ë°ì´í„° ë¡œë“œ ì‹œì‘");
  });
  
  console.log("âœ… ë¡œê·¸ì¸ ì™„ë£Œ:", email);
}

function handleLogoutClick(e) {
  e.preventDefault();
  console.log("ğŸ” ë¡œê·¸ì•„ì›ƒ ì‹œì‘");

  try {
    localStorage.removeItem("X-USER");
    currentUser = null;
    console.log("âœ… localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ì œê±°");
  } catch (err) {
    console.error("localStorage ì œê±° ì‹¤íŒ¨", err);
  }

  // ì „ì—­ ìƒíƒœ ì´ˆê¸°í™”
  FETCH_CALLED_ONCE = false;
  ORIGINAL_LIST = [];
  LISTINGS = [];
  
  // ì§€ë„ ë§ˆì»¤ë“¤ ì œê±°
  if (MAP && MARKERS) {
    MARKERS.forEach(marker => {
      if (marker && marker.setMap) {
        marker.setMap(null);
      }
    });
    MARKERS = [];
    console.log("âœ… ì§€ë„ ë§ˆì»¤ë“¤ ì œê±°");
  }
  
  // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”
  if (CLUSTER_GROUP && typeof CLUSTER_GROUP.clear === 'function') {
    CLUSTER_GROUP.clear();
    console.log("âœ… í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”");
  }
  
  // ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
  const ul = document.getElementById("listingList");
  if (ul) {
    ul.innerHTML = "";
    console.log("âœ… ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”");
  }
  
  // ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
  updateCountsDisplay(0, 0);
  
  // ëª¨ë“  íŒ¨ë„ ìˆ¨ê¸°ê¸°
  const panels = ["fullBriefingListPanel", "fullListPanel", "secondaryPanel"];
  panels.forEach(panelId => {
    const panel = document.getElementById(panelId);
    if (panel) {
      panel.classList.add("hidden");
      panel.style.display = "none";
    }
  });
  
  // UI ìƒíƒœ ì´ˆê¸°í™”
  UI_STATE.showFullBriefingList = false;
  UI_STATE.showFullList = false;
  UI_STATE.isBriefingListMode = false;

  showLoginScreen("");

  fetch("/auth/logout", { method: "GET", credentials: "include" })
    .finally(() => {
      console.log("âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
    });
}

function applyCustomerInputs() {
  const nameInp = document.getElementById("customerName");
  const phoneInp = document.getElementById("customerPhone");
  CURRENT_CUSTOMER.name  = nameInp ? nameInp.value.trim() : "";
  CURRENT_CUSTOMER.phone = phoneInp ? phoneInp.value.trim() : "";
  dbg("CURRENT_CUSTOMER", CURRENT_CUSTOMER);
}

function updateCountsDisplay(total, filtered) {
  const totalEl    = document.getElementById("countTotal");
  const filteredEl = document.getElementById("countFiltered");
  if (totalEl)    totalEl.textContent    = total;
  if (filteredEl) filteredEl.textContent = filtered;
} 

/**************************************
 * ===== ì„œë²„ì—ì„œ ë§¤ë¬¼ ë¡œë“œ =====
 **************************************/
async function fetchListings() {
  if (!currentUser) return;

  console.log("ğŸ” fetchListings ì‹œì‘ - ì‚¬ìš©ì:", currentUser);

  // ê¸°ì¡´ ë§ˆì»¤ë“¤ ì œê±°
  if (MARKERS && MARKERS.length > 0) {
    MARKERS.forEach(marker => {
      if (marker && marker.setMap) {
        marker.setMap(null);
      }
    });
    MARKERS = [];
    console.log("âœ… ê¸°ì¡´ ë§ˆì»¤ë“¤ ì œê±°");
  }

  // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”
  if (CLUSTER_GROUP && typeof CLUSTER_GROUP.clear === 'function') {
    CLUSTER_GROUP.clear();
    console.log("âœ… í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”");
  }

  const ul = document.getElementById("listingList");
  if (ul) ul.innerHTML = "<li>ë¡œë”©...</li>";
  updateCountsDisplay(0, 0);

  const label = "fetchListings";
  timeStart(label);
  try {
    const qs = `limit=100000&status_raw=${encodeURIComponent(FIXED_STATUS)}`;
    dbg(`${label} start`, { user: currentUser });

    const res = await fetch(`/api/listings?${qs}`, {
      headers: { "X-User": currentUser }
    });
    if (!res.ok) throw new Error(`API ì‹¤íŒ¨: ${res.status}`);

    const data = await res.json();
    ORIGINAL_LIST = data.items || [];
    LISTINGS = ORIGINAL_LIST.map(x => ({ ...x }));



    assignTempCoords();
    computeDistancesIfNeeded();

    applyAllFilters();
  } catch (e) {
    if (ul) ul.innerHTML = `<li style="color:red;">ì—ëŸ¬: ${escapeHtml(e.message)}</li>`;
    console.error("âŒ fetchListings ì˜¤ë¥˜:", e);
  } finally {
    timeEnd(label, { count: LISTINGS.length });
  }
}

/**************************************
 * ===== í•„í„° ì²˜ë¦¬ =====
 **************************************/
function readTopFilterInputs() {
  const gv = id => (document.getElementById(id)?.value.trim() || "");
  TOP_FILTERS.region   = gv("tf_region");
  TOP_FILTERS.jibun    = gv("tf_jibun");
  TOP_FILTERS.building = gv("tf_building");
  TOP_FILTERS.floor    = gv("tf_floor");
  TOP_FILTERS.store    = gv("tf_store");
  TOP_FILTERS.area_sale = gv("tf_area_sale");
  TOP_FILTERS.area_real = gv("tf_area_real");
  TOP_FILTERS.deposit   = gv("tf_deposit");
  TOP_FILTERS.rent      = gv("tf_rent");
  TOP_FILTERS.premium   = gv("tf_premium");
  TOP_FILTERS.note      = gv("tf_note");
  TOP_FILTERS.manager   = gv("tf_manager");
  TOP_FILTERS.region2   = gv("tf_region2");
  TOP_FILTERS.phone     = gv("tf_phone");
  TOP_FILTERS.client    = gv("tf_client");
  TOP_FILTERS.note3     = gv("tf_note3");
}

function buildEffectiveFilters() {
  Object.keys(EFFECTIVE_FILTERS).forEach(k => {
    delete EFFECTIVE_FILTERS[k];
  });
  
  // 1. ê³ ê° í•„í„°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
  Object.assign(EFFECTIVE_FILTERS, CUSTOMER_FILTERS);
  
  // 2. ìƒë‹¨ í•„í„°ê°€ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ê³ ê° í•„í„°ë¥¼ ë®ì–´ì”€
  Object.keys(TOP_FILTERS).forEach(k => {
    const v = TOP_FILTERS[k];
    if (v && v.trim() !== "") {
      EFFECTIVE_FILTERS[k] = v.trim();
    }
  });
}
function applyAllFilters() {
  dbg("applyAllFilters start");

  readTopFilterInputs();
  buildEffectiveFilters();
  
  // í•„í„° ì ìš© ì‹œ ì •ë ¬ ìƒíƒœ ì´ˆê¸°í™”
  resetSortCycles();
  
  // ë””ë²„ê¹…: í˜„ì¬ ì ìš©ëœ í•„í„° í™•ì¸
  // console.log('í˜„ì¬ ì ìš©ëœ í•„í„°:', EFFECTIVE_FILTERS);
  // console.log('ì´ ë§¤ë¬¼ ìˆ˜:', LISTINGS.length);
  
  // ë””ë²„ê¹…: ì§€ì—­ëª… í™•ì¸ (ì§€ì—­ + ì§€ì—­2)
  const allRegions = [...new Set(LISTINGS.map(item => item.fields?.ì§€ì—­ || '').filter(r => r))];
  const allRegions2 = [...new Set(LISTINGS.map(item => item.fields?.ì§€ì—­2 || '').filter(r => r))];
  // console.log('ì „ì²´ ì§€ì—­ëª… ëª©ë¡ (ì§€ì—­, ìƒìœ„ 20ê°œ):', allRegions.slice(0, 20));
  // console.log('ì „ì²´ ì§€ì—­ëª… ëª©ë¡ (ì§€ì—­2, ìƒìœ„ 20ê°œ):', allRegions2.slice(0, 20));
  
  // ë¶€í‰êµ¬ ê´€ë ¨ ë””ë²„ê·¸ ë¡œê·¸ ì œê±°ë¨

  const FIELDS = {
    region:   "ì§€ì—­",
    jibun:    "ì§€ë²ˆ",
    building: "ê±´ë¬¼ëª…",
    floor:    "ì¸µìˆ˜",
    store:    "ê°€ê²Œëª…",
    area_sale:"ë¶„ì–‘",
    area_real:"ì‹¤í‰ìˆ˜",
    deposit:  "ë³´ì¦ê¸ˆ",
    rent:     "ì›”ì„¸",
    premium:  "ê¶Œë¦¬ê¸ˆ",
    note:     "ë¹„ê³ ",
    manager:  "ë‹´ë‹¹ì",
    region2:  "ì§€ì—­2",
    phone:    "ì—°ë½ì²˜",
    client:   "ì˜ë¢°ì¸",
    note3:    "ë¹„ê³ 3"
  };

  const TEXT_KEYS = ["region","jibun","building","store","note","manager","region2","phone","client","note3"];
  const NUM_CONFIG = {
    area_sale:"gte",
    area_real:"gte",
    deposit:  "lte",
    rent:     "lte",
    premium:  "lte"
  };

  const parsedText = {};
  TEXT_KEYS.forEach(k => {
    parsedText[k] = parseTextTokens(EFFECTIVE_FILTERS[k] || "");
  });

  const parsedNum = {};
  Object.keys(NUM_CONFIG).forEach(k => {
    parsedNum[k] = buildNumFilter(EFFECTIVE_FILTERS[k] || "", NUM_CONFIG[k]);
  });

  const floorFilter = buildFloorFilter(EFFECTIVE_FILTERS.floor || "");

  const arr = LISTINGS.filter(item => {
    const fields = item.fields || {};

    for (const tk of TEXT_KEYS) {
      const v = fields[FIELDS[tk]] || "";
      if (!matchesTextTokens(v, parsedText[tk])) return false;
    }

    const fVal = parseFloorValue(fields[FIELDS.floor]);
    if (!checkNumFilter(fVal, floorFilter)) return false;

    const asVal = parseNumber(fields[FIELDS.area_sale]);
    if (!checkNumFilter(asVal, parsedNum.area_sale)) return false;

    const arVal = parseNumber(fields[FIELDS.area_real]);
    if (!checkNumFilter(arVal, parsedNum.area_real)) return false;

    const dVal = parseNumber(fields[FIELDS.deposit]);
    if (!checkNumFilter(dVal, parsedNum.deposit)) return false;

    const rVal = parseNumber(fields[FIELDS.rent]);
    if (!checkNumFilter(rVal, parsedNum.rent)) return false;

    const pVal = parseNumber(fields[FIELDS.premium]);
    if (!checkNumFilter(pVal, parsedNum.premium)) return false;

    return true;
  });

  sortListingsInPlace(arr);
  FILTERED_LISTINGS = arr;
  
  // ë””ë²„ê¹…: í•„í„°ë§ ê²°ê³¼ í™•ì¸
  // console.log('í•„í„°ë§ëœ ë§¤ë¬¼ ìˆ˜:', arr.length);
  if (arr.length === 0) {
    console.log('ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. í•„í„° ì¡°ê±´ì´ ë„ˆë¬´ ì—„ê²©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
  }
  
  // ë””ë²„ê¹…: ê° í•„í„° ì¡°ê±´ë³„ ë§¤ë¬¼ ìˆ˜ í™•ì¸
  if (EFFECTIVE_FILTERS.region2) {
    const region2Matches = LISTINGS.filter(item => {
      const region2 = item.fields?.ì§€ì—­2 || '';
      return region2.includes(EFFECTIVE_FILTERS.region2);
    });
    console.log(`ì§€ì—­2 í•„í„° (${EFFECTIVE_FILTERS.region2}) ë§¤ë¬¼ ìˆ˜:`, region2Matches.length);
  }
  
  if (EFFECTIVE_FILTERS.floor) {
    const floorMatches = LISTINGS.filter(item => {
      const floor = item.fields?.ì¸µìˆ˜ || '';
      return floor.includes(EFFECTIVE_FILTERS.floor);
    });
    console.log(`ì¸µìˆ˜ í•„í„° (${EFFECTIVE_FILTERS.floor}) ë§¤ë¬¼ ìˆ˜:`, floorMatches.length);
  }
  
  if (EFFECTIVE_FILTERS.area_real) {
    const areaMatches = LISTINGS.filter(item => {
      const area = parseNumber(item.fields?.ì‹¤í‰ìˆ˜) || 0;
      return area >= parseNumber(EFFECTIVE_FILTERS.area_real);
    });
    console.log(`ë©´ì  í•„í„° (${EFFECTIVE_FILTERS.area_real}í‰ ì´ìƒ) ë§¤ë¬¼ ìˆ˜:`, areaMatches.length);
  }
  
  if (EFFECTIVE_FILTERS.deposit) {
    const depositFilter = buildNumFilter(EFFECTIVE_FILTERS.deposit, "lte");
    const depositMatches = LISTINGS.filter(item => {
      const deposit = parseNumber(item.fields?.ë³´ì¦ê¸ˆ) || 0;
      return checkNumFilter(deposit, depositFilter);
    });
    console.log(`ë³´ì¦ê¸ˆ í•„í„° (${EFFECTIVE_FILTERS.deposit}) ë§¤ë¬¼ ìˆ˜:`, depositMatches.length);
  }
  
  dbg("applyAllFilters end");
  
  // ë¸Œë¦¬í•‘ í•„í„° ì ìš©
  applyBriefingFilters();

  setLayoutHeight();

  // ì§€ë„ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°ëŠ” ì´ˆê¸° ë¡œë“œ ì‹œì—ë§Œ ì‹¤í–‰
  if (MAP_READY && FETCH_CALLED_ONCE) {
    console.log("ğŸ” ì§€ë„ idle ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°");
    naver.maps.Event.trigger(MAP, 'idle');
  }
}

// ì •ë ¬ ìˆœí™˜ ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜
function resetSortCycles() {
  Object.keys(CURRENT_SORT_CYCLES).forEach(key => {
    CURRENT_SORT_CYCLES[key] = 0;
  });
  CURRENT_SORT_MODE = "latest";
}



function sortListingsInPlace(arr) {
  switch (CURRENT_SORT_MODE) {
    case "latest":
      arr.sort((a, b) => {
        const da = new Date(a.fields["ì ‘ìˆ˜ë‚ ì§œ"] || 0).getTime();
        const db = new Date(b.fields["ì ‘ìˆ˜ë‚ ì§œ"] || 0).getTime();
        return db - da;
      });
      break;
    case "oldest":
      arr.sort((a, b) => {
        const da = new Date(a.fields["ì ‘ìˆ˜ë‚ ì§œ"] || 0).getTime();
        const db = new Date(b.fields["ì ‘ìˆ˜ë‚ ì§œ"] || 0).getTime();
        return da - db;
      });
      break;
    case "area_high":
      arr.sort((a, b) => {
        const na = parseNumber(a.fields["ì‹¤í‰ìˆ˜"]);
        const nb = parseNumber(b.fields["ì‹¤í‰ìˆ˜"]);
        return (nb || 0) - (na || 0);
      });
      break;
    case "area_low":
      arr.sort((a, b) => {
        const na = parseNumber(a.fields["ì‹¤í‰ìˆ˜"]);
        const nb = parseNumber(b.fields["ì‹¤í‰ìˆ˜"]);
        return (na || 0) - (nb || 0);
      });
      break;
    case "deposit_low":
      arr.sort((a, b) => {
        const da = parseNumber(a.fields["ë³´ì¦ê¸ˆ"]);
        const db = parseNumber(b.fields["ë³´ì¦ê¸ˆ"]);
        return (da || 0) - (db || 0);
      });
      break;
    case "deposit_high":
      arr.sort((a, b) => {
        const da = parseNumber(a.fields["ë³´ì¦ê¸ˆ"]);
        const db = parseNumber(b.fields["ë³´ì¦ê¸ˆ"]);
        return (db || 0) - (da || 0);
      });
      break;
    case "rent_low":
      arr.sort((a, b) => {
        const ra = parseNumber(a.fields["ì›”ì„¸"]);
        const rb = parseNumber(b.fields["ì›”ì„¸"]);
        return (ra || 0) - (rb || 0);
      });
      break;
    case "rent_high":
      arr.sort((a, b) => {
        const ra = parseNumber(a.fields["ì›”ì„¸"]);
        const rb = parseNumber(b.fields["ì›”ì„¸"]);
        return (rb || 0) - (ra || 0);
      });
      break;
    case "default":
      // ê¸°ë³¸ ì •ë ¬ (ì ‘ìˆ˜ë‚ ì§œ ìµœì‹ ìˆœ)
      arr.sort((a, b) => {
        const da = new Date(a.fields["ì ‘ìˆ˜ë‚ ì§œ"] || 0).getTime();
        const db = new Date(b.fields["ì ‘ìˆ˜ë‚ ì§œ"] || 0).getTime();
        return db - da;
      });
      break;
    default:
      break;
  }
}

function renderListingList(arr) {
  const ul = document.getElementById("listingList");
  if (!ul) return;

  ul.innerHTML = "";
  arr.forEach(item => {
    const fields     = item.fields || {};
    const addr       = escapeHtml(item.address_full || "");
    const floorRaw   = fields["ì¸µìˆ˜"] || fields["ì¸µ"] || "";
    const floor      = floorRaw
      ? (/ì¸µ|ì§€í•˜|^b\d+/i.test(floorRaw) ? floorRaw : `${floorRaw}ì¸µ`)
      : "-";
    const areaReal   = escapeHtml(fields["ì‹¤í‰ìˆ˜"] || "-");
    const dep        = escapeHtml(fields["ë³´ì¦ê¸ˆ"] || "-");
    const rent       = escapeHtml(fields["ì›”ì„¸"]   || "-");
    const premRaw    = (fields["ê¶Œë¦¬ê¸ˆ"] ?? "").toString().trim();
    const premDisplay= ["", "ë¬´ê¶Œë¦¬", "0", "ë¬´"].includes(premRaw)
      ? "ë¬´ê¶Œë¦¬"
      : `ê¶Œ: ${escapeHtml(premRaw)}`;

    const li = document.createElement("li");
    li.dataset.id = item.id;
    li.style.position = 'relative';
    li.innerHTML = `
      <div class="listing-item">
        <div class="meta-top">
          <span class="addr">${addr}</span>
          <span class="floor">${floor}</span>
          <span class="area-real">${areaReal}í‰</span>
        </div>
        <div class="meta-bottom">
          <span>ë³´: ${dep}</span>
          <span>ì›”: ${rent}</span>
          <span>${premDisplay}</span>
        </div>
      </div>
    `;
    
    // ë¸Œë¦¬í•‘ ìƒíƒœ í‘œì‹œ ì¶”ê°€
    const briefingStatus = getBriefingStatus(item.id);
    updateListingItemBriefingStatus(li, briefingStatus);

    li.addEventListener("click", () => {
      clearSelection();
      setActiveMarker(item.id);
      renderDetailPanel(item);
      
      // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
      ul.querySelectorAll("li .listing-item.selected")
        .forEach(el => el.classList.remove("selected"));
      const inner = li.querySelector(".listing-item");
      if (inner) {
        inner.classList.add("selected");
      }
      
      // í´ë¦­ ì‹œ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
      const marker = MARKERS.find(m => m._listingId === item.id);
      if (marker && marker.getElement) {
        const dotEl = marker.getElement().querySelector(".marker-dot");
        if (dotEl) {
          dotEl.classList.add("blink");
          setTimeout(() => dotEl.classList.remove("blink"), 800);
        }
      }
      
      // í´ëŸ¬ìŠ¤í„° ë²„ë¸” ì• ë‹ˆë©”ì´ì…˜ë„ ì‹œë„
      if (CLUSTERER && CLUSTERER._clusters) {
        const clusterObj = CLUSTERER._clusters.find(c =>
          c.getClusterMember().some(m => m._listingId === item.id)
        );
        if (clusterObj && clusterObj._clusterMarker) {
          const bubble = clusterObj._clusterMarker
            .getElement()
            .querySelector(".cluster-bubble");
          if (bubble) {
            bubble.classList.remove("cluster-animate");
            void bubble.offsetWidth;
            bubble.classList.add("cluster-animate");
          }
        }
      }
    });

    // ë§ˆìš°ìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ ì¶”ê°€
    li.addEventListener("mouseenter", () => {
      highlightMarkerTemp(item.id, true);
      
      // ë§ˆì»¤ ë„íŠ¸ blink íš¨ê³¼
      const marker = MARKERS.find(m => m._listingId === item.id);
      if (marker && marker.getElement) {
        const dotEl = marker.getElement().querySelector(".marker-dot");
        if (dotEl) {
          dotEl.classList.add("blink");
          setTimeout(() => dotEl.classList.remove("blink"), 800);
        }
      }
      
      // í´ëŸ¬ìŠ¤í„° ë²„ë¸” blink íš¨ê³¼ ì¶”ê°€
      if (CLUSTERER && CLUSTERER._clusters) {
        const clusterObj = CLUSTERER._clusters.find(c =>
          c.getClusterMember().some(m => m._listingId === item.id)
        );
        if (clusterObj && clusterObj._clusterMarker) {
          const bubble = clusterObj._clusterMarker
            .getElement()
            .querySelector(".cluster-bubble");
          if (bubble) {
            // console.log("ğŸ”¥ ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ ë§ˆìš°ìŠ¤ì˜¤ë²„ - í´ëŸ¬ìŠ¤í„° ë²„ë¸” ì• ë‹ˆë©”ì´ì…˜:", bubble);
            bubble.style.animation = "clusterBlinkHover 0.6s ease-in-out";
            setTimeout(() => {
              bubble.style.animation = "";
            }, 600);
          }
        }
      }
    });

    li.addEventListener("mouseleave", () => {
      highlightMarkerTemp(item.id, false);
    });

    ul.appendChild(li);
  });
}

function scrollToListing(id) {
  const ul = document.getElementById("listingList");
  if (!ul) return;
  const li = ul.querySelector(`li[data-id="${id}"]`);
  if (!li) return;

  li.scrollIntoView({ behavior: "smooth", block: "center" });

  if (CURRENT_SELECTED_LI_ID) {
    const prev = ul.querySelector(`li[data-id="${CURRENT_SELECTED_LI_ID}"] .listing-item`);
    if (prev) prev.classList.remove("selected");
  }
  CURRENT_SELECTED_LI_ID = id;

  const inner = li.querySelector(".listing-item");
  if (inner) {
    inner.classList.add("selected");
  }
} 
/**************************************
 * ===== ì§€ë„ ë° ë§ˆì»¤ ê´€ë¦¬ =====
 **************************************/
function placeMarkers(arr) {
  if (!MAP) return;
  if (!Array.isArray(arr)) return;

  if (MARKERS && MARKERS.length) {
    MARKERS.forEach(m => m.setMap && m.setMap(null));
    MARKERS = [];
  }
  if (CLUSTERER) {
    try { CLUSTERER.setMap(null); } catch (e) {}
    CLUSTERER = null;
  }

  const bounds = new naver.maps.LatLngBounds();

  arr.forEach(item => {
    const { lat, lng } = item.coords || {};
    if (lat == null || lng == null) return;
    const pos   = new naver.maps.LatLng(lat, lng);
    const color = STATUS_COLORS[item.status_raw] || "#007AFF";

    const marker = new naver.maps.Marker({
      position: pos,
      map: null,
      icon: { content: createMarkerIcon(color, item.id === SELECTED_MARKER_ID, getBriefingStatus(item.id)) }
    });
    marker._listingId = item.id;

    naver.maps.Event.addListener(marker, "click", () => {
      setActiveMarker(item.id);
      scrollToListing(item.id);
      renderDetailPanel(item);
    });

    MARKERS.push(marker);
    bounds.extend(pos);
  });

  // MarkerClusteringì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
  if (typeof MarkerClustering !== "undefined" && MarkerClustering) {
    CLUSTERER = new MarkerClustering({
      minClusterSize: 2,
      maxZoom: MAP.getMaxZoom(),
      map: MAP,
      markers: MARKERS,
      disableClickZoom: true,
      gridSize: 80,

      stylingFunction: function(clusterMarker, count) {
        let cls = "cluster-small";
        if (count >= 50)      cls = "cluster-big";
        else if (count >= 10) cls = "cluster-mid";

        // í´ëŸ¬ìŠ¤í„° ê°ì²´ ì°¾ê¸° (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
        let clusterObj = null;
        if (CLUSTERER && CLUSTERER._clusters) {
          clusterObj = CLUSTERER._clusters.find(
            c => c._clusterMarker === clusterMarker
          );
        }
        
        // ë¸Œë¦¬í•‘ ìƒíƒœ ë¶„ì„
        let bubbleStyle = "";
        let bubbleContent = count;
        
        if (clusterObj && clusterObj.getClusterMember) {
          const clusterMembers = clusterObj.getClusterMember();
          const briefingStats = {
            normal: 0,
            pending: 0,
            completed: 0,
            onhold: 0
          };
          
          clusterMembers.forEach(marker => {
            const status = getBriefingStatus(marker._listingId);
            briefingStats[status]++;
          });
          
          // ë¸Œë¦¬í•‘ ìƒíƒœê°€ ìˆëŠ” ë§¤ë¬¼ì´ ìˆìœ¼ë©´ ìƒ‰ìƒ ë³€ê²½
          const hasBriefingItems = briefingStats.pending > 0 || briefingStats.completed > 0 || briefingStats.onhold > 0;
          
          if (hasBriefingItems) {
            // ì£¼ìš” ë¸Œë¦¬í•‘ ìƒíƒœ ê²°ì • (ìš°ì„ ìˆœìœ„: ì™„ë£Œ > ì˜ˆì • > ë³´ë¥˜)
            let primaryStatus = BRIEFING_STATUS.NORMAL;
            if (briefingStats.completed > 0) {
              primaryStatus = BRIEFING_STATUS.COMPLETED;
            } else if (briefingStats.pending > 0) {
              primaryStatus = BRIEFING_STATUS.PENDING;
            } else if (briefingStats.onhold > 0) {
              primaryStatus = BRIEFING_STATUS.ONHOLD;
            }
            
            // ë¸Œë¦¬í•‘ ìƒíƒœë³„ ìƒ‰ìƒ
            const statusColors = {
              [BRIEFING_STATUS.NORMAL]: '#007AFF',
              [BRIEFING_STATUS.PENDING]: '#FF3B30',
              [BRIEFING_STATUS.COMPLETED]: '#34C759',
              [BRIEFING_STATUS.ONHOLD]: '#AF52DE'
            };
            
            bubbleStyle = `background-color: ${statusColors[primaryStatus]} !important; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);`;
          }
        }

        const bubbleHtml = `<div class="cluster-bubble ${cls}" style="${bubbleStyle}">${bubbleContent}</div>`;
        const wrapper = clusterMarker.getElement();
        wrapper.innerHTML = bubbleHtml;

        try { clusterMarker.setZIndex(8000 + count); } catch (e) {}

        // í´ëŸ¬ìŠ¤í„° í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë” ì§ì ‘ì ìœ¼ë¡œ ì²˜ë¦¬
        wrapper.style.cursor = "pointer";
        wrapper.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log("ğŸ”¥ í´ëŸ¬ìŠ¤í„° í´ë¦­ë¨ (wrapper):", clusterMarker);

          // ë²„ë¸” ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ - ë” ê°•ë ¥í•œ ë°©ë²•
          const bubble = wrapper.querySelector(".cluster-bubble");
          if (bubble) {
            console.log("ë²„ë¸” ìš”ì†Œ ì°¾ìŒ:", bubble);
            
            // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±°
            bubble.classList.remove("cluster-animate");
            
            // ê°•ì œ ë¦¬í”Œë¡œìš°
            bubble.offsetHeight;
            
            // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ë‹¤ì‹œ ì¶”ê°€
            bubble.classList.add("cluster-animate");
            
            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ í´ë˜ìŠ¤ ì œê±°
            setTimeout(() => {
              bubble.classList.remove("cluster-animate");
            }, 350);
            
            console.log("ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€ë¨:", bubble.classList.contains("cluster-animate"));
          } else {
            console.log("ë²„ë¸” ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
          }

          // í´ëŸ¬ìŠ¤í„° ê°ì²´ ì°¾ê¸°
          const clusterObj = CLUSTERER._clusters.find(
            c => c._clusterMarker === clusterMarker
          );
          if (clusterObj) {
            console.log("í´ëŸ¬ìŠ¤í„° ê°ì²´ ì°¾ìŒ:", clusterObj);
            renderClusterGroupList(clusterObj);
          } else {
            console.log("í´ëŸ¬ìŠ¤í„° ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
          }
        });

        // ë§ˆìš°ìŠ¤ì˜¤ë²„ íš¨ê³¼ë„ ì¶”ê°€
        wrapper.addEventListener("mouseenter", () => {
          wrapper.style.transform = "scale(1.1)";
          wrapper.style.transition = "transform 0.2s ease";
          
          // í´ëŸ¬ìŠ¤í„° ë²„ë¸” blink íš¨ê³¼
          const bubble = wrapper.querySelector(".cluster-bubble");
          if (bubble) {
            bubble.style.animation = "clusterBlinkHover 0.6s ease-in-out";
            setTimeout(() => {
              bubble.style.animation = "";
            }, 600);
          }
        });

        wrapper.addEventListener("mouseleave", () => {
          wrapper.style.transform = "scale(1)";
        });

        // í´ëŸ¬ìŠ¤í„° ë²„ë¸”ì—ë„ ì§ì ‘ ì´ë²¤íŠ¸ ì¶”ê°€
        const bubble = wrapper.querySelector(".cluster-bubble");
        if (bubble) {
          // í´ë¦­ ì´ë²¤íŠ¸
          bubble.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log("ğŸ”¥ í´ëŸ¬ìŠ¤í„° ë²„ë¸” ì§ì ‘ í´ë¦­ë¨:", bubble);
            
            // CSS í´ë˜ìŠ¤ ì• ë‹ˆë©”ì´ì…˜
            bubble.classList.remove("cluster-animate");
            bubble.offsetHeight;
            bubble.classList.add("cluster-animate");
            
            const clusterObj = CLUSTERER._clusters.find(
              c => c._clusterMarker === clusterMarker
            );
            if (clusterObj) {
              renderClusterGroupList(clusterObj);
            }
          });
          
          // ë§ˆìš°ìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸
          bubble.addEventListener("mouseenter", () => {
            console.log("ğŸ”¥ í´ëŸ¬ìŠ¤í„° ë²„ë¸” ë§ˆìš°ìŠ¤ì˜¤ë²„:", bubble);
            bubble.style.animation = "clusterBlinkHover 0.6s ease-in-out";
            setTimeout(() => {
              bubble.style.animation = "";
            }, 600);
          });
        }
      }
    });
  } else {
    // MarkerClusteringì´ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ê°œë³„ ë§ˆì»¤ë¡œ í‘œì‹œ
    console.log('âš ï¸ MarkerClusteringì´ ë¡œë“œë˜ì§€ ì•Šì•„ ê°œë³„ ë§ˆì»¤ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.');
    MARKERS.forEach(m => m.setMap(MAP));
  }
}

function setActiveMarker(id){
  SELECTED_MARKER_ID = id;
  MARKERS.forEach(m => {
    const color = STATUS_COLORS[LISTINGS.find(x => x.id === m._listingId)?.status_raw] || "#007AFF";
    const isActive = (m._listingId === id);
    const briefingStatus = getBriefingStatus(m._listingId);
    m.setIcon({ content: createMarkerIcon(color, isActive, briefingStatus) });
    m.setZIndex(isActive ? 9999 : 1);
  });
}

function highlightMarkerTemp(id, on) {
  MARKERS.forEach(m => {
    if (m._listingId === id) {
      const color = STATUS_COLORS[LISTINGS.find(x => x.id === id)?.status_raw] || "#007AFF";
      const isActive = (m._listingId === SELECTED_MARKER_ID);
      const briefingStatus = getBriefingStatus(m._listingId);
      
      if (on) {
        // ë§ˆìš°ìŠ¤ì˜¤ë²„ ì‹œ ë” í° í¬ê¸°ì™€ ë°ì€ ìƒ‰ìƒ
        const cls = "marker-dot active";
        m.setIcon({ 
          content: `<div class="${cls}" style="background:${color}; transform: scale(1.5); box-shadow: 0 0 10px ${color};"></div>` 
        });
        m.setZIndex(5000);
      } else {
        // ë§ˆìš°ìŠ¤ì•„ì›ƒ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µì› (ë¸Œë¦¬í•‘ ìƒíƒœ í¬í•¨)
        m.setIcon({ content: createMarkerIcon(color, isActive, briefingStatus) });
        m.setZIndex(isActive ? 9999 : 1);
      }
    }
  });
}

function focusMarker(id, panTo = true) {
  const marker = MARKERS.find(m => m._listingId === id);
  if (!marker) return;
  setActiveMarker(id);
  if (panTo) {
    try { MAP.panTo(marker.getPosition()); } catch(e){}
  }
}

function createMarkerIcon(color = "#007AFF", active = false, briefingStatus = BRIEFING_STATUS.NORMAL){
  // ë¸Œë¦¬í•‘ ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
  let markerColor = color;
  if (briefingStatus !== BRIEFING_STATUS.NORMAL) {
    const statusColors = {
      [BRIEFING_STATUS.PENDING]: '#FF3B30',    // ë¹¨ê°„ìƒ‰ (ì˜ˆì •)
      [BRIEFING_STATUS.COMPLETED]: '#34C759',  // ì´ˆë¡ìƒ‰ (ì™„ë£Œ)
      [BRIEFING_STATUS.ONHOLD]: '#AF52DE'      // ë³´ë¼ìƒ‰ (ë³´ë¥˜)
    };
    markerColor = statusColors[briefingStatus] || color;
  }
  
  let cls = active ? "marker-dot active" : "marker-dot";
  return `<div class="${cls}" style="background:${markerColor};"></div>`;
}

function fixMapLayoutAfterShow() {
  const doFix = () => {
    setLayoutHeight();
    if (MAP) {
      naver.maps.Event.trigger(MAP, 'resize');
    }
  };
  requestAnimationFrame(doFix);
  setTimeout(doFix, 350);
}

function calcHaversineMeters(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const toRad = deg => deg * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

function getDistanceMeters(centerLatLng, targetLatLng) {
  if (window.naver && naver.maps &&
      naver.maps.GeometryUtil && naver.maps.GeometryUtil.getDistance) {
    return naver.maps.GeometryUtil.getDistance(centerLatLng, targetLatLng);
  }
  return calcHaversineMeters(
    centerLatLng.lat(), centerLatLng.lng(),
    targetLatLng.lat(), targetLatLng.lng()
  );
}

function computeDistancesIfNeeded() {
  if (!MAP) return;
  const c = MAP.getCenter();
  if (!c) return;

  const cx = c.x, cy = c.y;
  if (LAST_DISTANCE_CENTER && LAST_DISTANCE_CENTER.x === cx && LAST_DISTANCE_CENTER.y === cy) {
    return;
  }
  LAST_DISTANCE_CENTER = { x: cx, y: cy };

  LISTINGS.forEach(item => {
    const { lat, lng } = item.coords || {};
    if (lat == null || lng == null) {
      item._distance = null;
      return;
    }
    const d = getDistanceMeters(c, new naver.maps.LatLng(lat, lng));
    item._distance = d;
  });
}

function assignTempCoords() {
  LISTINGS.forEach((item, i) => {
    if (!item.coords || item.coords.lat == null || item.coords.lng == null) {
      const baseLat = 37.5665;
      const baseLng = 126.9780;
      item.coords = { lat: baseLat + (i * 0.0001), lng: baseLng + (i * 0.0001) };
    }
  });
}

function renderClusterGroupList(cluster) {
  const markers = cluster.getClusterMember();
  const ids     = markers.map(m => m._listingId);
  const arr     = LISTINGS.filter(x => ids.includes(x.id));

  const wrap = document.getElementById("clusterList");
  const ul   = document.getElementById("clusterItemList");
  const listingList = document.getElementById("listingList");
  if (!wrap || !ul) return;

  // ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¸°ê³  í´ëŸ¬ìŠ¤í„° ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
  if (listingList) listingList.style.visibility = "hidden";
  ul.innerHTML = "";

  arr.forEach(item => {
    const fields      = item.fields || {};
    const addr        = escapeHtml(item.address_full || "");
    const floor       = escapeHtml(fields["ì¸µìˆ˜"]   || "-");
    const area_real   = escapeHtml(fields["ì‹¤í‰ìˆ˜"] || "-");
    const dep         = escapeHtml(fields["ë³´ì¦ê¸ˆ"] || "-");
    const rent        = escapeHtml(fields["ì›”ì„¸"]   || "-");
    const rawPrem     = (fields["ê¶Œë¦¬ê¸ˆ"] ?? "").toString().trim();
    const premDisplay = ["", "ë¬´ê¶Œë¦¬", "0", "ë¬´"].includes(rawPrem)
      ? "ë¬´ê¶Œë¦¬"
      : `ê¶Œ: ${escapeHtml(rawPrem)}`;

    const li = document.createElement("li");
    li.classList.add("listing-item");
    li.setAttribute("data-id", item.id);
    li.style.position = 'relative';
    li.innerHTML = `
      <div class="title">${addr}</div>
      <div class="meta">
        ${floor}ì¸µ / ì‹¤í‰ìˆ˜ ${area_real}í‰ /
        ë³´ì¦ê¸ˆ ${dep} / ì›”ì„¸ ${rent} / ${premDisplay}
      </div>
    `;
    
    // ë¸Œë¦¬í•‘ ìƒíƒœ í‘œì‹œ ì¶”ê°€
    const briefingStatus = getBriefingStatus(item.id);
    updateListingItemBriefingStatus(li, briefingStatus);

    li.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      setActiveMarker(item.id);

      let clusterObj = null;
      if (CLUSTERER && Array.isArray(CLUSTERER._clusters)) {
        clusterObj = CLUSTERER._clusters.find(c =>
          c.getClusterMember().some(m => m._listingId === item.id)
        );
      }
      if (clusterObj && clusterObj._clusterMarker) {
        const bubble = clusterObj._clusterMarker
          .getElement()
          .querySelector(".cluster-bubble");
        if (bubble) {
          bubble.classList.remove("cluster-animate");
          void bubble.offsetWidth;
          bubble.classList.add("cluster-animate");
        }
      }

      const mk = MARKERS.find(m => m._listingId === item.id);
      if (mk?.getElement) {
        const dotEl = mk.getElement().querySelector(".marker-dot");
        if (dotEl) {
          dotEl.classList.add("blink");
          setTimeout(() => dotEl.classList.remove("blink"), 800);
        }
      }

      ul.querySelectorAll("li.selected")
        .forEach(el => el.classList.remove("selected"));
      li.classList.add("selected");

      const mainUl = document.getElementById("listingList");
      const mainLi = mainUl?.querySelector(`li[data-id="${item.id}"]`);
      if (mainLi) {
        const inner = mainLi.querySelector(".listing-item");
        if (inner) {
          inner.classList.add("selected");
          mainLi.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }
      renderDetailPanel(item);
    });

    // í´ëŸ¬ìŠ¤í„° ëª©ë¡ ë§ˆìš°ìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ ì¶”ê°€
    li.addEventListener("mouseenter", () => {
      highlightMarkerTemp(item.id, true);
      
      // ë§ˆì»¤ ë„íŠ¸ blink íš¨ê³¼
      const marker = MARKERS.find(m => m._listingId === item.id);
      if (marker && marker.getElement) {
        const dotEl = marker.getElement().querySelector(".marker-dot");
        if (dotEl) {
          dotEl.classList.add("blink");
          setTimeout(() => dotEl.classList.remove("blink"), 800);
        }
      }
      
      // í´ëŸ¬ìŠ¤í„° ë²„ë¸” blink íš¨ê³¼ ì¶”ê°€
      if (CLUSTERER && CLUSTERER._clusters) {
        const clusterObj = CLUSTERER._clusters.find(c =>
          c.getClusterMember().some(m => m._listingId === item.id)
        );
        if (clusterObj && clusterObj._clusterMarker) {
          const bubble = clusterObj._clusterMarker
            .getElement()
            .querySelector(".cluster-bubble");
          if (bubble) {
            bubble.style.animation = "clusterBlinkHover 0.6s ease-in-out";
            setTimeout(() => {
              bubble.style.animation = "";
            }, 600);
          }
        }
      }
    });

    li.addEventListener("mouseleave", () => {
      highlightMarkerTemp(item.id, false);
    });

    ul.appendChild(li);
  });

  wrap.classList.remove("hidden");
  
  // í´ëŸ¬ìŠ¤í„° ë¦¬ìŠ¤íŠ¸ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  const closeBtn = document.getElementById("clusterListCloseBtn");
  if (closeBtn) {
    closeBtn.onclick = () => {
      hideClusterList();
    };
  }
}

function hideClusterList() {
  const wrap = document.getElementById("clusterList");
  const listingList = document.getElementById("listingList");
  if (wrap) wrap.classList.add("hidden");
  // í´ëŸ¬ìŠ¤í„° ë¦¬ìŠ¤íŠ¸ê°€ ìˆ¨ê²¨ì§ˆ ë•Œ ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ í‘œì‹œ
  if (listingList) listingList.style.visibility = "visible";
}
function bindClusterClickDelegation() {
  if (_clusterClickDelegationBound) return;
  const mapWrap = document.getElementById("mapWrap");
  if (!mapWrap) return;

  mapWrap.addEventListener("click", (e) => {
    // í´ëŸ¬ìŠ¤í„° ë²„ë¸”ì„ ì§ì ‘ í´ë¦­í•œ ê²½ìš°
    if (e.target.classList.contains("cluster-bubble")) {
      const wrapper = e.target.closest("div[title]");
      if (!wrapper || !CLUSTERER) return;

      const cluster = CLUSTERER._clusters.find(
        c => c._clusterMarker.getElement() === wrapper
      );
      if (!cluster) return;

      console.log("ğŸ”¥ í´ëŸ¬ìŠ¤í„° ë²„ë¸” í´ë¦­ë¨ (delegation):", cluster);

      // ë²„ë¸” ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
      const bubble = wrapper.querySelector(".cluster-bubble");
      if (bubble) {
        bubble.classList.remove("cluster-animate");
        void bubble.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ
        bubble.classList.add("cluster-animate");
      }

      renderClusterGroupList(cluster);
      return;
    }

    // í´ëŸ¬ìŠ¤í„° wrapperë¥¼ í´ë¦­í•œ ê²½ìš°
    const wrapper = e.target.closest("div[title]");
    if (!wrapper || !CLUSTERER) return;

    const cluster = CLUSTERER._clusters.find(
      c => c._clusterMarker.getElement() === wrapper
    );
    if (!cluster) return;

    console.log("ğŸ”¥ í´ëŸ¬ìŠ¤í„° wrapper í´ë¦­ë¨ (delegation):", cluster);

    const bubble = wrapper.querySelector(".cluster-bubble");
    if (bubble) {
      bubble.classList.remove("cluster-animate");
      void bubble.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ
      bubble.classList.add("cluster-animate");
    }

    renderClusterGroupList(cluster);
  });

  _clusterClickDelegationBound = true;
} 

/**************************************
 * ===== íŒ¨ë„ í† ê¸€/ì „ì²´ë³´ê¸° =====
 **************************************/
function openCustomerPanel(customerId, view = "detail") {
  UI_STATE.selectedCustomerId = customerId;
  UI_STATE.currentCustomerView = view;
  UI_STATE.showCustomerPanel  = true;

  const panel = document.getElementById("customerPanel");
  const detail = document.getElementById("viewCustomerDetail");
  const form   = document.getElementById("viewCustomerForm");
  const title  = document.getElementById("customerPanelTitle");

  if (panel) panel.classList.remove("hidden");

  if (view === "form") {
    if (detail) detail.classList.add("hidden");
    if (form)   form.classList.remove("hidden");
    if (title)  title.textContent = "ì‹ ê·œ ë“±ë¡";
  } else {
    if (detail) detail.classList.remove("hidden");
    if (form)   form.classList.add("hidden");
    if (title)  title.textContent = "ê³ ê° ìƒì„¸";
  }

  setLayoutHeight();
  if (MAP) naver.maps.Event.trigger(MAP, 'resize');
}

function closeCustomerPanel() {
  UI_STATE.showCustomerPanel = false;
  const panel = document.getElementById("customerPanel");
  if (panel) panel.classList.add("hidden");
  setLayoutHeight();
  if (MAP) naver.maps.Event.trigger(MAP, 'resize');
}

function switchToListingMode(mode) {
  UI_STATE.isBriefingListMode = (mode === 'briefing');
  
  const propertyBtn = document.getElementById("propertyListBtn");
  const briefingBtn = document.getElementById("briefingListBtn");
  
  if (UI_STATE.isBriefingListMode) {
    // ë¸Œë¦¬í•‘ ë¦¬ìŠ¤íŠ¸ ëª¨ë“œë¡œ ì „í™˜
    if (propertyBtn) {
      propertyBtn.classList.remove("active");
      propertyBtn.removeAttribute("data-mode");
    }
    if (briefingBtn) {
      briefingBtn.classList.add("active");
      briefingBtn.setAttribute("data-mode", "briefing");
    }
    renderBriefingList();
  } else {
    // ì¼ë°˜ ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ ëª¨ë“œë¡œ ì „í™˜
    if (propertyBtn) {
      propertyBtn.classList.add("active");
      propertyBtn.setAttribute("data-mode", "property");
    }
    if (briefingBtn) {
      briefingBtn.classList.remove("active");
      briefingBtn.removeAttribute("data-mode");
    }
    applyAllFilters();
  }
}

// ê¸°ì¡´ í•¨ìˆ˜ëª… ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
function toggleBriefingList() {
  switchToListingMode(UI_STATE.isBriefingListMode ? 'property' : 'briefing');
}

function toggleFullBriefingList(show) {
  UI_STATE.showFullBriefingList = (show !== undefined) ? show : !UI_STATE.showFullBriefingList;
  const panel = document.getElementById("fullBriefingListPanel");
  if (!panel) {
    console.error("âŒ fullBriefingListPanelì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  console.log("ğŸ” toggleFullBriefingList í˜¸ì¶œë¨:", UI_STATE.showFullBriefingList);
  console.log("ğŸ” íŒ¨ë„ ìš”ì†Œ:", panel);
  console.log("ğŸ” í˜„ì¬ í´ë˜ìŠ¤:", panel.className);
  
  if (UI_STATE.showFullBriefingList) {
    panel.classList.remove("hidden");
    console.log("ğŸ” hidden í´ë˜ìŠ¤ ì œê±°ë¨, ìƒˆë¡œìš´ í´ë˜ìŠ¤:", panel.className);
    console.log("ğŸ” íŒ¨ë„ ìŠ¤íƒ€ì¼:", panel.style.display);
    renderFullBriefingList();
    console.log("ğŸ” ì „ì²´ë¸Œë¦¬í•‘ë¦¬ìŠ¤íŠ¸ ì—´ê¸° ì™„ë£Œ");
  } else {
    panel.classList.add("hidden");
    console.log("ğŸ” hidden í´ë˜ìŠ¤ ì¶”ê°€ë¨, ìƒˆë¡œìš´ í´ë˜ìŠ¤:", panel.className);
    console.log("ğŸ” ì „ì²´ë¸Œë¦¬í•‘ë¦¬ìŠ¤íŠ¸ ë‹«ê¸° ì™„ë£Œ");
  }
}

function toggleFullList(show) {
  UI_STATE.showFullList = (show !== undefined) ? show : !UI_STATE.showFullList;
  const panel = document.getElementById("fullListPanel");
  if (!panel) {
    console.error("âŒ fullListPanelì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  console.log("ğŸ” toggleFullList í˜¸ì¶œë¨:", UI_STATE.showFullList);
  console.log("ğŸ” íŒ¨ë„ ìš”ì†Œ:", panel);
  console.log("ğŸ” í˜„ì¬ í´ë˜ìŠ¤:", panel.className);
  
  if (UI_STATE.showFullList) {
    panel.classList.remove("hidden");
    console.log("ğŸ” hidden í´ë˜ìŠ¤ ì œê±°ë¨, ìƒˆë¡œìš´ í´ë˜ìŠ¤:", panel.className);
    console.log("ğŸ” íŒ¨ë„ ìŠ¤íƒ€ì¼:", panel.style.display);
    renderFullList();
    console.log("ğŸ” ì „ì²´ë¦¬ìŠ¤íŠ¸ ì—´ê¸° ì™„ë£Œ");
  } else {
    panel.classList.add("hidden");
    console.log("ğŸ” hidden í´ë˜ìŠ¤ ì¶”ê°€ë¨, ìƒˆë¡œìš´ í´ë˜ìŠ¤:", panel.className);
    console.log("ğŸ” ì „ì²´ë¦¬ìŠ¤íŠ¸ ë‹«ê¸° ì™„ë£Œ");
  }
}

function renderBriefingList() {
  // ë¸Œë¦¬í•‘ í˜„í™©ì´ ì²´í¬ëœ ë§¤ë¬¼ë§Œ í•„í„°ë§
  const briefingListings = LISTINGS.filter(item => {
    const status = getBriefingStatus(item.id);
    return status !== BRIEFING_STATUS.NORMAL; // ì¼ë°˜ì´ ì•„ë‹Œ ëª¨ë“  ìƒíƒœ (ì˜ˆì •, ì™„ë£Œ, ë³´ë¥˜)
  });
  
  // í˜„ì¬ ìƒë‹¨ í•„í„° ì ìš©
  const effectiveFilters = buildEffectiveFilters();
  let filteredListings = briefingListings;
  
  if (effectiveFilters && Object.keys(effectiveFilters).length > 0) {
    filteredListings = briefingListings.filter(item => {
      const fields = item.fields || {};
      
      // ì§€ì—­ í•„í„°
      if (effectiveFilters.region && effectiveFilters.region.length > 0) {
        const itemRegion = fields['ì§€ì—­'] || '';
        if (!effectiveFilters.region.some(r => itemRegion.includes(r))) {
          return false;
        }
      }
      
      // ì§€ë²ˆ í•„í„°
      if (effectiveFilters.jibun && effectiveFilters.jibun.length > 0) {
        const itemJibun = fields['ì§€ë²ˆ'] || '';
        if (!effectiveFilters.jibun.some(j => itemJibun.includes(j))) {
          return false;
        }
      }
      
      // ê±´ë¬¼ëª… í•„í„°
      if (effectiveFilters.building && effectiveFilters.building.length > 0) {
        const itemBuilding = fields['ê±´ë¬¼ëª…'] || '';
        if (!effectiveFilters.building.some(b => itemBuilding.includes(b))) {
          return false;
        }
      }
      
      // ì¸µìˆ˜ í•„í„°
      if (effectiveFilters.floor && effectiveFilters.floor.length > 0) {
        const itemFloor = fields['ì¸µìˆ˜'] || '';
        if (!effectiveFilters.floor.some(f => itemFloor.includes(f))) {
          return false;
        }
      }
      
      // ì‹¤í‰ìˆ˜ í•„í„°
      if (effectiveFilters.area && effectiveFilters.area.length > 0) {
        const itemArea = parseFloat(fields['ì‹¤í‰ìˆ˜']) || 0;
        const areaFilter = effectiveFilters.area[0];
        if (areaFilter.min !== null && itemArea < areaFilter.min) return false;
        if (areaFilter.max !== null && itemArea > areaFilter.max) return false;
      }
      
      // ë³´ì¦ê¸ˆ í•„í„°
      if (effectiveFilters.deposit && effectiveFilters.deposit.length > 0) {
        const itemDeposit = parseFloat(fields['ë³´ì¦ê¸ˆ']) || 0;
        const depositFilter = effectiveFilters.deposit[0];
        if (depositFilter.min !== null && itemDeposit < depositFilter.min) return false;
        if (depositFilter.max !== null && itemDeposit > depositFilter.max) return false;
      }
      
      // ì›”ì„¸ í•„í„°
      if (effectiveFilters.rent && effectiveFilters.rent.length > 0) {
        const itemRent = parseFloat(fields['ì›”ì„¸']) || 0;
        const rentFilter = effectiveFilters.rent[0];
        if (rentFilter.min !== null && itemRent < rentFilter.min) return false;
        if (rentFilter.max !== null && itemRent > rentFilter.max) return false;
      }
      
      // ê¶Œë¦¬ê¸ˆ í•„í„°
      if (effectiveFilters.premium && effectiveFilters.premium.length > 0) {
        const itemPremium = parseFloat(fields['ê¶Œë¦¬ê¸ˆ']) || 0;
        const premiumFilter = effectiveFilters.premium[0];
        if (premiumFilter.min !== null && itemPremium < premiumFilter.min) return false;
        if (premiumFilter.max !== null && itemPremium > premiumFilter.max) return false;
      }
      
      // í‚¤ì›Œë“œ í•„í„°
      if (effectiveFilters.keyword && effectiveFilters.keyword.length > 0) {
        const itemText = [
          fields['ê°€ê²Œëª…'] || '',
          fields['ê±´ë¬¼ëª…'] || '',
          fields['ì§€ë²ˆ'] || '',
          fields['ë¹„ê³ '] || '',
          fields['ë¹„ê³ 3'] || ''
        ].join(' ').toLowerCase();
        
        if (!effectiveFilters.keyword.every(k => itemText.includes(k.toLowerCase()))) {
          return false;
        }
      }
      
      return true;
    });
  }
  
  // ì •ë ¬ ì ìš©
  if (CURRENT_SORT_MODE) {
    sortListingsInPlace(filteredListings);
  }
  
  // ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
  renderListingList(filteredListings);
  
  // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
  updateCountsDisplay(LISTINGS.length, filteredListings.length);
}

function renderFullList() {
  const content = document.getElementById("fullListContent");
  if (!content) return;
  
  // ì „ì²´ ë§¤ë¬¼ ë°ì´í„° ì‚¬ìš© (í•„í„°ë§ë˜ì§€ ì•Šì€ ì›ë³¸)
  const allListings = LISTINGS || [];
  
  // í˜„ì¬ ìƒë‹¨ í•„í„° ì ìš©
  const effectiveFilters = buildEffectiveFilters();
  let filteredListings = allListings;
  
  if (effectiveFilters && Object.keys(effectiveFilters).length > 0) {
    filteredListings = allListings.filter(item => {
      const fields = item.fields || {};
      
      // ì§€ì—­ í•„í„°
      if (effectiveFilters.region && effectiveFilters.region.length > 0) {
        const itemRegion = fields['ì§€ì—­'] || '';
        if (!effectiveFilters.region.some(r => itemRegion.includes(r))) {
          return false;
        }
      }
      
      // ì§€ë²ˆ í•„í„°
      if (effectiveFilters.jibun && effectiveFilters.jibun.length > 0) {
        const itemJibun = fields['ì§€ë²ˆ'] || '';
        if (!effectiveFilters.jibun.some(j => itemJibun.includes(j))) {
          return false;
        }
      }
      
      // ê±´ë¬¼ëª… í•„í„°
      if (effectiveFilters.building && effectiveFilters.building.length > 0) {
        const itemBuilding = fields['ê±´ë¬¼ëª…'] || '';
        if (!effectiveFilters.building.some(b => itemBuilding.includes(b))) {
          return false;
        }
      }
      
      // ì¸µìˆ˜ í•„í„°
      if (effectiveFilters.floor && effectiveFilters.floor.length > 0) {
        const itemFloor = fields['ì¸µìˆ˜'] || '';
        if (!effectiveFilters.floor.some(f => itemFloor.includes(f))) {
          return false;
        }
      }
      
      // ì‹¤í‰ìˆ˜ í•„í„°
      if (effectiveFilters.area && effectiveFilters.area.length > 0) {
        const itemArea = parseFloat(fields['ì‹¤í‰ìˆ˜']) || 0;
        const areaFilter = effectiveFilters.area[0];
        if (areaFilter.min !== null && itemArea < areaFilter.min) return false;
        if (areaFilter.max !== null && itemArea > areaFilter.max) return false;
      }
      
      // ë³´ì¦ê¸ˆ í•„í„°
      if (effectiveFilters.deposit && effectiveFilters.deposit.length > 0) {
        const itemDeposit = parseFloat(fields['ë³´ì¦ê¸ˆ']) || 0;
        const depositFilter = effectiveFilters.deposit[0];
        if (depositFilter.min !== null && itemDeposit < depositFilter.min) return false;
        if (depositFilter.max !== null && itemDeposit > depositFilter.max) return false;
      }
      
      // ì›”ì„¸ í•„í„°
      if (effectiveFilters.rent && effectiveFilters.rent.length > 0) {
        const itemRent = parseFloat(fields['ì›”ì„¸']) || 0;
        const rentFilter = effectiveFilters.rent[0];
        if (rentFilter.min !== null && itemRent < rentFilter.min) return false;
        if (rentFilter.max !== null && itemRent > rentFilter.max) return false;
      }
      
      // ê¶Œë¦¬ê¸ˆ í•„í„°
      if (effectiveFilters.premium && effectiveFilters.premium.length > 0) {
        const itemPremium = parseFloat(fields['ê¶Œë¦¬ê¸ˆ']) || 0;
        const premiumFilter = effectiveFilters.premium[0];
        if (premiumFilter.min !== null && itemPremium < premiumFilter.min) return false;
        if (premiumFilter.max !== null && itemPremium > premiumFilter.max) return false;
      }
      
      // í‚¤ì›Œë“œ í•„í„°
      if (effectiveFilters.keyword && effectiveFilters.keyword.length > 0) {
        const itemText = [
          fields['ê°€ê²Œëª…'] || '',
          fields['ê±´ë¬¼ëª…'] || '',
          fields['ì§€ë²ˆ'] || '',
          fields['ë¹„ê³ '] || '',
          fields['ë¹„ê³ 3'] || ''
        ].join(' ').toLowerCase();
        
        if (!effectiveFilters.keyword.every(k => itemText.includes(k.toLowerCase()))) {
          return false;
        }
      }
      
      return true;
    });
  }
  
  // ë¸Œë¦¬í•‘ í•„í„° ì ìš©
  if (BRIEFING_FILTERS) {
    filteredListings = filteredListings.filter(item => {
      const status = getBriefingStatus(item.id);
      return BRIEFING_FILTERS[status];
    });
  }
  
  // ì •ë ¬ ì ìš©
  if (CURRENT_SORT_MODE) {
    sortListingsInPlace(filteredListings);
  }
  
  // í—¤ë” ë Œë”ë§ (ê°„ë‹¨í•œ ì •ë³´ë§Œ)
  const headerHtml = `
    <div style="background: #f8f9fa; padding: 12px 16px; border-bottom: 1px solid #e0e0e0;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="color: #666; font-size: 14px;">
          ì´ ${allListings.length}ê±´ / í•„í„° í›„ ${filteredListings.length}ê±´
        </span>
      </div>
    </div>
  `;
  
  // ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (í…Œì´ë¸” í˜•íƒœë¡œ ëª¨ë“  ì •ë³´ í‘œì‹œ)
  const listHtml = `
    <div style="height: calc(100vh - 234px); overflow-y: auto;">
      <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
        <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">
          <tr style="border-bottom: 2px solid #dee2e6;">
            <th style="padding:8px;min-width:60px;">ì ‘ìˆ˜ë‚ ì§œ</th>
            <th style="padding:8px;min-width:50px;">ì§€ì—­</th>
            <th style="padding:8px;min-width:50px;">ì§€ë²ˆ</th>
            <th style="padding:8px;min-width:60px;">ê±´ë¬¼ëª…</th>
            <th style="padding:8px;min-width:40px;">ì¸µìˆ˜</th>
            <th style="padding:8px;min-width:60px;">ê°€ê²Œëª…</th>
            <th style="padding:8px;min-width:40px;">ë¶„ì–‘</th>
            <th style="padding:8px;min-width:40px;">ì‹¤í‰ìˆ˜</th>
            <th style="padding:8px;min-width:50px;">ë³´ì¦ê¸ˆ</th>
            <th style="padding:8px;min-width:50px;">ì›”ì„¸</th>
            <th style="padding:8px;min-width:50px;">ê¶Œë¦¬ê¸ˆ</th>
            <th style="padding:8px;min-width:300px;">ë¹„ê³ </th>
            <th style="padding:8px;min-width:50px;">ë‹´ë‹¹ì</th>
            <th style="padding:8px;min-width:30px;">ìƒ</th>
            <th style="padding:8px;min-width:40px;">í˜„í™©</th>
            <th style="padding:8px;min-width:50px;">ì§€ì—­2</th>
            <th style="padding:8px;min-width:60px;">ì—°ë½ì²˜</th>
            <th style="padding:8px;min-width:50px;">ì˜ë¢°ì¸</th>
            <th style="padding:8px;min-width:120px;">ë¹„ê³ 3</th>
            <th style="padding:8px;min-width:60px;">ë¸Œë¦¬í•‘</th>
          </tr>
        </thead>
        <tbody>
          ${filteredListings.map(item => {
            const fields = item.fields || {};
            const briefingStatus = getBriefingStatus(item.id);
            const briefingText = getBriefingStatusText(briefingStatus);
            const briefingColor = {
              [BRIEFING_STATUS.NORMAL]: '#1976d2',
              [BRIEFING_STATUS.PENDING]: '#ff9800',
              [BRIEFING_STATUS.COMPLETED]: '#4caf50',
              [BRIEFING_STATUS.ONHOLD]: '#9e9e9e'
            }[briefingStatus];
            return `
              <tr style="border-bottom:1px solid #eee;cursor:pointer;background:white;"
                  onclick="selectFullListItem('${item.id}')"
                  onmouseenter="highlightFullListItem('${item.id}', true); this.style.backgroundColor='#f8f9fa';"
                  onmouseleave="highlightFullListItem('${item.id}', false); this.style.backgroundColor='white';">
                <td style="padding:6px 8px;">${escapeHtml(fields['ì ‘ìˆ˜ë‚ ì§œ'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì§€ì—­'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì§€ë²ˆ'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ê±´ë¬¼ëª…'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì¸µìˆ˜'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ê°€ê²Œëª…'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ë¶„ì–‘'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì‹¤í‰ìˆ˜'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ë³´ì¦ê¸ˆ'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì›”ì„¸'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ê¶Œë¦¬ê¸ˆ'] || '-')}</td>
                <td style="padding:6px 8px;max-width:300px;word-wrap:break-word;">${escapeHtml(fields['ë¹„ê³ '] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ë‹´ë‹¹ì'] || fields['manager'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ìƒ'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['í˜„í™©'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì§€ì—­2'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì—°ë½ì²˜'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì˜ë¢°ì¸'] || '-')}</td>
                <td style="padding:6px 8px;max-width:120px;word-wrap:break-word;">${escapeHtml(fields['ë¹„ê³ 3'] || '-')}</td>
                <td style="padding:6px 8px;text-align:center;">
                  <div style="padding:2px 6px;border-radius:8px;font-size:12px;font-weight:600;color:white;background:${briefingColor};cursor:pointer;display:inline-block;"
                       onclick="event.stopPropagation(); cycleBriefingStatus('${item.id}')">
                    ${briefingText}
                  </div>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
  
  content.innerHTML = headerHtml + listHtml;
}
function renderFullBriefingList() {
  const content = document.getElementById("fullBriefingListContent");
  if (!content) return;
  
  // ë¸Œë¦¬í•‘ í˜„í™©ì´ ì²´í¬ëœ ë§¤ë¬¼ë§Œ í•„í„°ë§
  const briefingListings = LISTINGS.filter(item => {
    const status = getBriefingStatus(item.id);
    return status !== BRIEFING_STATUS.NORMAL; // ì¼ë°˜ì´ ì•„ë‹Œ ëª¨ë“  ìƒíƒœ (ì˜ˆì •, ì™„ë£Œ, ë³´ë¥˜)
  });
  
  // í˜„ì¬ ìƒë‹¨ í•„í„° ì ìš©
  const effectiveFilters = buildEffectiveFilters();
  let filteredListings = briefingListings;
  
  if (effectiveFilters && Object.keys(effectiveFilters).length > 0) {
    filteredListings = briefingListings.filter(item => {
      const fields = item.fields || {};
      
      // ì§€ì—­ í•„í„°
      if (effectiveFilters.region && effectiveFilters.region.length > 0) {
        const itemRegion = fields['ì§€ì—­'] || '';
        if (!effectiveFilters.region.some(r => itemRegion.includes(r))) {
          return false;
        }
      }
      
      // ì§€ë²ˆ í•„í„°
      if (effectiveFilters.jibun && effectiveFilters.jibun.length > 0) {
        const itemJibun = fields['ì§€ë²ˆ'] || '';
        if (!effectiveFilters.jibun.some(j => itemJibun.includes(j))) {
          return false;
        }
      }
      
      // ê±´ë¬¼ëª… í•„í„°
      if (effectiveFilters.building && effectiveFilters.building.length > 0) {
        const itemBuilding = fields['ê±´ë¬¼ëª…'] || '';
        if (!effectiveFilters.building.some(b => itemBuilding.includes(b))) {
          return false;
        }
      }
      
      // ì¸µìˆ˜ í•„í„°
      if (effectiveFilters.floor && effectiveFilters.floor.length > 0) {
        const itemFloor = fields['ì¸µìˆ˜'] || '';
        if (!effectiveFilters.floor.some(f => itemFloor.includes(f))) {
          return false;
        }
      }
      
      // ì‹¤í‰ìˆ˜ í•„í„°
      if (effectiveFilters.area && effectiveFilters.area.length > 0) {
        const itemArea = parseFloat(fields['ì‹¤í‰ìˆ˜']) || 0;
        const areaFilter = effectiveFilters.area[0];
        if (areaFilter.min !== null && itemArea < areaFilter.min) return false;
        if (areaFilter.max !== null && itemArea > areaFilter.max) return false;
      }
      
      // ë³´ì¦ê¸ˆ í•„í„°
      if (effectiveFilters.deposit && effectiveFilters.deposit.length > 0) {
        const itemDeposit = parseFloat(fields['ë³´ì¦ê¸ˆ']) || 0;
        const depositFilter = effectiveFilters.deposit[0];
        if (depositFilter.min !== null && itemDeposit < depositFilter.min) return false;
        if (depositFilter.max !== null && itemDeposit > depositFilter.max) return false;
      }
      
      // ì›”ì„¸ í•„í„°
      if (effectiveFilters.rent && effectiveFilters.rent.length > 0) {
        const itemRent = parseFloat(fields['ì›”ì„¸']) || 0;
        const rentFilter = effectiveFilters.rent[0];
        if (rentFilter.min !== null && itemRent < rentFilter.min) return false;
        if (rentFilter.max !== null && itemRent > rentFilter.max) return false;
      }
      
      // ê¶Œë¦¬ê¸ˆ í•„í„°
      if (effectiveFilters.premium && effectiveFilters.premium.length > 0) {
        const itemPremium = parseFloat(fields['ê¶Œë¦¬ê¸ˆ']) || 0;
        const premiumFilter = effectiveFilters.premium[0];
        if (premiumFilter.min !== null && itemPremium < premiumFilter.min) return false;
        if (premiumFilter.max !== null && itemPremium > premiumFilter.max) return false;
      }
      
      // í‚¤ì›Œë“œ í•„í„°
      if (effectiveFilters.keyword && effectiveFilters.keyword.length > 0) {
        const itemText = [
          fields['ê°€ê²Œëª…'] || '',
          fields['ê±´ë¬¼ëª…'] || '',
          fields['ì§€ë²ˆ'] || '',
          fields['ë¹„ê³ '] || '',
          fields['ë¹„ê³ 3'] || ''
        ].join(' ').toLowerCase();
        
        if (!effectiveFilters.keyword.every(k => itemText.includes(k.toLowerCase()))) {
          return false;
        }
      }
      
      return true;
    });
  }
  
  // ì •ë ¬ ì ìš©
  if (CURRENT_SORT_MODE) {
    sortListingsInPlace(filteredListings);
  }
  
  // í—¤ë” ë Œë”ë§ (ê°„ë‹¨í•œ ì •ë³´ë§Œ)
  const headerHtml = `
    <div style="background: #f8f9fa; padding: 12px 16px; border-bottom: 1px solid #e0e0e0;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="color: #666; font-size: 14px;">
          ì´ ${LISTINGS.length}ê±´ / ë¸Œë¦¬í•‘ ${briefingListings.length}ê±´ / í•„í„° í›„ ${filteredListings.length}ê±´
        </span>
      </div>
    </div>
  `;
  
  // ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (í…Œì´ë¸” í˜•íƒœë¡œ ëª¨ë“  ì •ë³´ í‘œì‹œ)
  const listHtml = `
    <div style="height: calc(100vh - 234px); overflow-y: auto;">
      <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
        <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">
          <tr style="border-bottom: 2px solid #dee2e6;">
            <th style="padding:8px;min-width:60px;">ì ‘ìˆ˜ë‚ ì§œ</th>
            <th style="padding:8px;min-width:50px;">ì§€ì—­</th>
            <th style="padding:8px;min-width:50px;">ì§€ë²ˆ</th>
            <th style="padding:8px;min-width:60px;">ê±´ë¬¼ëª…</th>
            <th style="padding:8px;min-width:40px;">ì¸µìˆ˜</th>
            <th style="padding:8px;min-width:60px;">ê°€ê²Œëª…</th>
            <th style="padding:8px;min-width:40px;">ë¶„ì–‘</th>
            <th style="padding:8px;min-width:40px;">ì‹¤í‰ìˆ˜</th>
            <th style="padding:8px;min-width:50px;">ë³´ì¦ê¸ˆ</th>
            <th style="padding:8px;min-width:50px;">ì›”ì„¸</th>
            <th style="padding:8px;min-width:50px;">ê¶Œë¦¬ê¸ˆ</th>
            <th style="padding:8px;min-width:300px;">ë¹„ê³ </th>
            <th style="padding:8px;min-width:50px;">ë‹´ë‹¹ì</th>
            <th style="padding:8px;min-width:30px;">ìƒ</th>
            <th style="padding:8px;min-width:40px;">í˜„í™©</th>
            <th style="padding:8px;min-width:50px;">ì§€ì—­2</th>
            <th style="padding:8px;min-width:60px;">ì—°ë½ì²˜</th>
            <th style="padding:8px;min-width:50px;">ì˜ë¢°ì¸</th>
            <th style="padding:8px;min-width:120px;">ë¹„ê³ 3</th>
            <th style="padding:8px;min-width:60px;">ë¸Œë¦¬í•‘</th>
          </tr>
        </thead>
        <tbody>
          ${filteredListings.map(item => {
            const fields = item.fields || {};
            const briefingStatus = getBriefingStatus(item.id);
            const briefingText = getBriefingStatusText(briefingStatus);
            const briefingColor = {
              [BRIEFING_STATUS.NORMAL]: '#1976d2',
              [BRIEFING_STATUS.PENDING]: '#ff9800',
              [BRIEFING_STATUS.COMPLETED]: '#4caf50',
              [BRIEFING_STATUS.ONHOLD]: '#9e9e9e'
            }[briefingStatus];
            return `
              <tr style="border-bottom:1px solid #eee;cursor:pointer;background:white;"
                  onclick="selectFullListItem('${item.id}')"
                  onmouseenter="highlightFullListItem('${item.id}', true); this.style.backgroundColor='#f8f9fa';"
                  onmouseleave="highlightFullListItem('${item.id}', false); this.style.backgroundColor='white';">
                <td style="padding:6px 8px;">${escapeHtml(fields['ì ‘ìˆ˜ë‚ ì§œ'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì§€ì—­'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì§€ë²ˆ'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ê±´ë¬¼ëª…'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì¸µìˆ˜'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ê°€ê²Œëª…'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ë¶„ì–‘'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì‹¤í‰ìˆ˜'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ë³´ì¦ê¸ˆ'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì›”ì„¸'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ê¶Œë¦¬ê¸ˆ'] || '-')}</td>
                <td style="padding:6px 8px;max-width:300px;word-wrap:break-word;">${escapeHtml(fields['ë¹„ê³ '] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ë‹´ë‹¹ì'] || fields['manager'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ìƒ'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['í˜„í™©'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì§€ì—­2'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì—°ë½ì²˜'] || '-')}</td>
                <td style="padding:6px 8px;">${escapeHtml(fields['ì˜ë¢°ì¸'] || '-')}</td>
                <td style="padding:6px 8px;max-width:120px;word-wrap:break-word;">${escapeHtml(fields['ë¹„ê³ 3'] || '-')}</td>
                <td style="padding:6px 8px;text-align:center;">
                  <div style="padding:2px 6px;border-radius:8px;font-size:12px;font-weight:600;color:white;background:${briefingColor};cursor:pointer;display:inline-block;"
                       onclick="event.stopPropagation(); cycleBriefingStatus('${item.id}')">
                    ${briefingText}
                  </div>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
  
  content.innerHTML = headerHtml + listHtml;
}



function selectFullListItem(listingId) {
  // ë§¤ë¬¼ ìƒì„¸ ì •ë³´ í‘œì‹œ
  const item = LISTINGS.find(l => l.id === listingId);
  if (item) {
    // ì§€ë„ì—ì„œ í•´ë‹¹ ë§¤ë¬¼ ì„ íƒ
    setActiveMarker(listingId);
    // ë§¤ë¬¼ ìƒì„¸ ì •ë³´ í‘œì‹œ
    renderDetailPanel(item);
  }
}

function highlightFullListItem(listingId, on) {
  // ì§€ë„ì—ì„œ í•´ë‹¹ ë§¤ë¬¼ í•˜ì´ë¼ì´íŠ¸
  highlightMarkerTemp(listingId, on);
}

function refreshFullList() {
  // ì „ì²´ë³´ê¸° íŒ¨ë„ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ ìƒˆë¡œê³ ì¹¨
  if (UI_STATE.showFullList) {
    renderFullList();
  }
}

function toggleBriefingFilter() {
  const dropdown = document.getElementById('briefingFilterDropdown');
  if (dropdown) {
    dropdown.classList.toggle('hidden');
  }
}

// ë¸Œë¦¬í•‘ í•„í„° ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(event) {
  const briefingFilter = document.getElementById('briefingFilter');
  const dropdown = document.getElementById('briefingFilterDropdown');
  
  if (briefingFilter && dropdown && !briefingFilter.contains(event.target)) {
    dropdown.classList.add('hidden');
  }
});

function renderDetailPanel(item) {
  // showSecondaryPanel í•¨ìˆ˜ ì‚¬ìš©
  showSecondaryPanel('viewListingDetail');
  
  const viewListingDetail = document.getElementById('viewListingDetail');
  if (!viewListingDetail) {
    console.error('ë§¤ë¬¼ìƒì„¸ ë·° ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  const detailTitleEl = document.getElementById("secondaryPanelTitle");
  const detailEl = document.getElementById('viewListingDetail');
  
  if (!detailTitleEl || !detailEl) return;
  
  detailTitleEl.textContent = "ë§¤ë¬¼ ìƒì„¸ ì •ë³´";
  
  const fields = item.fields || {};
  const addr = item.address_full || '';
  
  detailEl.innerHTML = `
    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
      <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 6px;">${escapeHtml(fields['ê°€ê²Œëª…'] || fields['ê±´ë¬¼ëª…'] || 'ë§¤ë¬¼ëª… ì—†ìŒ')}</div>
      <div style="color: #666; font-size: 13px;">ğŸ“ ${escapeHtml(addr || 'ì£¼ì†Œ ì—†ìŒ')} <span class="listing-detail-briefing-status briefing-${getBriefingStatus(item.id)}" onclick="cycleBriefingStatus('${item.id}')">${getBriefingStatusText(getBriefingStatus(item.id))}</span></div>
    </div>
    
    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; height: calc(100vh - 200px); overflow-y: auto;">
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ì ‘ìˆ˜ë‚ ì§œ</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ì ‘ìˆ˜ë‚ ì§œ'] || 'ì ‘ìˆ˜ë‚ ì§œ ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ì§€ì—­</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ì§€ì—­'] || 'ì§€ì—­ ì •ë³´ ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ì§€ë²ˆ</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ì§€ë²ˆ'] || 'ì§€ë²ˆ ì •ë³´ ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ê±´ë¬¼ëª…</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ê±´ë¬¼ëª…'] || 'ê±´ë¬¼ëª… ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ê°€ê²Œëª…</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ê°€ê²Œëª…'] || 'ê°€ê²Œëª… ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ì¸µìˆ˜</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ì¸µìˆ˜'] || 'ì¸µìˆ˜ ì •ë³´ ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ì‹¤í‰ìˆ˜</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ì‹¤í‰ìˆ˜'] || 'ì‹¤í‰ìˆ˜ ì •ë³´ ì—†ìŒ')}í‰</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ë³´ì¦ê¸ˆ</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ë³´ì¦ê¸ˆ'] || 'ë³´ì¦ê¸ˆ ì •ë³´ ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ì›”ì„¸</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ì›”ì„¸'] || 'ì›”ì„¸ ì •ë³´ ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ê¶Œë¦¬ê¸ˆ</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ê¶Œë¦¬ê¸ˆ'] || 'ê¶Œë¦¬ê¸ˆ ì •ë³´ ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ë¹„ê³ </span>
        <span class="value" style="color: #666; flex: 1; font-size: 13px;">${escapeHtml(fields['ë¹„ê³ '] || 'ë¹„ê³  ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ì˜ë¢°ì¸</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ì˜ë¢°ì¸'] || 'ì˜ë¢°ì¸ ì •ë³´ ì—†ìŒ')}</span>
      </div>
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ì—°ë½ì²˜</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ì—°ë½ì²˜'] || 'ì—°ë½ì²˜ ì •ë³´ ì—†ìŒ')}</span>
      </div>
      ${fields['ë¹„ê³ 3'] ? `<div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ë¹„ê³ 3</span>
        <span class="value" style="color: #666; flex: 1; font-size: 13px;">${escapeHtml(fields['ë¹„ê³ 3'])}</span>
      </div>` : ''}
      <div class="detail-row" style="display: flex; justify-content: space-between; padding: 6px 0;">
        <span class="label" style="font-weight: 600; color: #333; min-width: 70px; font-size: 13px;">ë‹´ë‹¹ì</span>
        <span class="value" style="color: #666; font-size: 13px;">${escapeHtml(fields['ë‹´ë‹¹ì'] || fields['manager'] || 'ë‹´ë‹¹ì ì •ë³´ ì—†ìŒ')}</span>
      </div>
    </div>
  `;
}

/**************************************
 * ===== ì§€ë„ ì´ˆê¸°í™” =====
 **************************************/
function initMap() {
  console.log("ğŸ” initMap í˜¸ì¶œë¨");
  console.log("window.naver:", window.naver);
  console.log("window.naver.maps:", window.naver?.maps);
  
  // ë„¤ì´ë²„ ì§€ë„ APIê°€ ì™„ì „íˆ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
  if (!window.naver || !window.naver.maps || typeof naver.maps.Map !== 'function') {
    console.log("[initMap] window.naver.mapsê°€ ì•„ì§ ì™„ì „íˆ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 500ms í›„ ì¬ì‹œë„");
    
    // ë¬´í•œ ë£¨í”„ ë°©ì§€: ìµœëŒ€ 5ë²ˆë§Œ ì¬ì‹œë„
    if (!window.initMapRetryCount) {
      window.initMapRetryCount = 0;
    }
    
    if (window.initMapRetryCount < 5) {
      window.initMapRetryCount++;
      console.log(`ğŸ”„ ì¬ì‹œë„ ${window.initMapRetryCount}/5`);
      setTimeout(initMap, 500);
    } else {
      console.error("âŒ ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨ - ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼");
      showToast("ë„¤ì´ë²„ ì§€ë„ APIë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.", "error");
      // ì¬ì‹œë„ ì¹´ìš´í„° ë¦¬ì…‹
      window.initMapRetryCount = 0;
    }
    return;
  }
  
  // ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ë©´ ì¬ì‹œë„ ì¹´ìš´í„° ë¦¬ì…‹
  window.initMapRetryCount = 0;

  dbg("initMap í˜¸ì¶œ");
  
  // MarkerClustering.js ë™ì  ë¡œë“œ
  loadMarkerClustering();

  MAP = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.4933485, 126.7225676),
    zoom: 18,
    mapTypeControl: false
  });

  naver.maps.Event.addListener(MAP, 'click', (e) => {
    // ê±°ë¦¬ì œê¸° ëª¨ë“œì¼ ë•ŒëŠ” ë‹¤ë¥¸ ë™ì‘ ìˆ˜í–‰
    if (IS_DISTANCE_MODE) {
      handleDistanceClick(e);
      return;
    }
    
    // ê±°ë¦¬ë·° ë ˆì´ì–´ê°€ í™œì„±í™”ëœ ê²½ìš° í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    if (MAP._streetLayer) {
      console.log('ğŸ“ ì§€ë„ í´ë¦­ (ê±°ë¦¬ë·° ë ˆì´ì–´ í™œì„±í™”ë¨):', e.coord);
      console.log('ğŸ”„ ê±°ë¦¬ë·° ë ˆì´ì–´ í´ë¦­ ì´ë²¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜');
      
      // ê±°ë¦¬ë·° ë ˆì´ì–´ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ í˜¸ì¶œ
      if (e.coord) {
        console.log('ğŸ”„ openPanorama í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘');
        openPanorama(e.coord);
      }
      return;
    }
    
    // ê¸°ì¡´ ë™ì‘
    hideClusterList();
    const secondaryPanel = document.getElementById('secondaryPanel');
    if (secondaryPanel) {
      secondaryPanel.classList.add('hidden');
      secondaryPanel.classList.remove('visible');
    }
    clearSelection();
  });
  
  // ê±°ë¦¬ì œê¸° ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸
  naver.maps.Event.addListener(MAP, 'dblclick', (e) => {
    if (IS_DISTANCE_MODE) {
      handleDistanceDoubleClick(e);
    }
  });
  
  // ê±°ë¦¬ì œê¸° ìš°í´ë¦­ ì´ë²¤íŠ¸ (ì‚­ì œ)
  naver.maps.Event.addListener(MAP, 'rightclick', (e) => {
    if (IS_DISTANCE_MODE && DISTANCE_POINTS.length > 0) {
      handleDistanceRightClick(e);
    }
  });

  setLayoutHeight();
  naver.maps.Event.trigger(MAP, 'resize');

  MAP_READY = true;
  while (MAP_READY_QUEUE.length > 0) {
    try {
      const fn = MAP_READY_QUEUE.shift();
      fn && fn();
    } catch (err) {
      console.error('[MAP_READY_QUEUE] ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜', err);
    }
  }

  naver.maps.Event.addListener(MAP, 'idle', () => {
    if (!MAP_READY) return;

    const zoom = MAP.getZoom();
    const THRESHOLD = 14;
    if (zoom < THRESHOLD) {
      if (UI_STATE.isBriefingListMode) {
        renderBriefingList();
      } else {
        renderListingList([]);
      }
      updateCountsDisplay(LISTINGS.length, 0);
      return;
    }

    const bounds = MAP.getBounds();
    const visibleItems = FILTERED_LISTINGS.filter(item => {
      const { lat, lng } = item.coords || {};
      return lat != null && lng != null
        && bounds.hasLatLng(new naver.maps.LatLng(lat, lng));
    });
    
    sortListingsInPlace(visibleItems);
    
    // ë¸Œë¦¬í•‘ë¦¬ìŠ¤íŠ¸ ëª¨ë“œì¼ ë•ŒëŠ” ë¸Œë¦¬í•‘ë¦¬ìŠ¤íŠ¸ë¥¼ ë Œë”ë§, ì•„ë‹ˆë©´ ì¼ë°˜ ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸
    if (UI_STATE.isBriefingListMode) {
      renderBriefingList();
    } else {
      renderListingList(visibleItems);
    }
    
    updateCountsDisplay(FILTERED_LISTINGS.length, visibleItems.length);
  });

  document.dispatchEvent(new Event('map-ready'));
  
  // í´ëŸ¬ìŠ¤í„° í´ë¦­ ìœ„ì„ ë°”ì¸ë”©
  setTimeout(() => {
    bindClusterClickDelegation();
  }, 500);
  
  // ì¶”ê°€ë¡œ ë§ˆì»¤ê°€ ë°°ì¹˜ëœ í›„ì—ë„ ë°”ì¸ë”©
  setTimeout(() => {
    bindClusterClickDelegation();
  }, 1000);
  
  // ì§€ë„ ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™”
  initMapControls();
}
/**************************************
 * ===== ì„¸ì…˜ ì‚¬ìš©ì ë™ê¸°í™” =====
 **************************************/
async function syncUserFromSession() {
  try {
    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const currentUserEmail = localStorage.getItem("X-USER");
    
    const headers = { "Accept": "application/json" };
    if (currentUserEmail) {
      headers["X-User"] = currentUserEmail;
    }
    
    const res = await fetch("/api/me", { headers: headers });
    const data = await res.json();

    if (res.ok && data && data.logged_in && data.email) {
      setCurrentUser(data.email);

      // ì–´ë“œë¯¼ ê¶Œí•œ ì •ë³´ ì €ì¥
      if (data.is_admin) {
        localStorage.setItem("X-USER-ADMIN", "true");
        console.log("âœ… ì–´ë“œë¯¼ ê¶Œí•œ í™•ì¸ë¨:", data.email);
      } else {
        localStorage.removeItem("X-USER-ADMIN");
        console.log("â„¹ï¸ ì¼ë°˜ ì‚¬ìš©ì:", data.email);
      }

      const usEl = document.getElementById('userStatus');
      if (usEl) {
        const roleText = data.is_admin ? `ì–´ë“œë¯¼: ${data.email}` : `ì‚¬ìš©ì: ${data.email}`;
        usEl.textContent = roleText;
      }
      
      const nl = document.getElementById('naverLoginBtn');
      const lo = document.getElementById('logoutBtn');
      if (nl) nl.classList.add('hidden');
      if (lo) lo.classList.remove('hidden');

      const roleNameEl = document.getElementById("userRoleName");
      if (roleNameEl && data.role && data.name) {
        roleNameEl.textContent = `${data.role} / ${data.name}`;
      }

      // ì–´ë“œë¯¼ UI í† ê¸€
      if (typeof toggleAdminUI === 'function') {
        toggleAdminUI(data.is_admin);
      }

      return;
    }

    const stored = localStorage.getItem("X-USER");
    if (stored) {
      setCurrentUser(stored);
      return;
    }

    currentUser = null;
    const usEl = document.getElementById('userStatus');
    if (usEl) usEl.textContent = 'ë¹„ë¡œê·¸ì¸';
    const nl = document.getElementById('naverLoginBtn');
    const lo = document.getElementById('logoutBtn');
    if (nl) nl.classList.remove('hidden');
    if (lo) lo.classList.add('hidden');

  } catch (e) {
    console.error("ì‚¬ìš©ì ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨", e);
    const stored = localStorage.getItem("X-USER");
    if (stored) {
      setCurrentUser(stored);
    }
  }
}

async function loadCustomerList(filter = 'own') {
  try {
    if (!currentUser) {
      console.error('ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }
    
    let url = '/api/customers';
    
    // í•„í„°ë§ íŒŒë¼ë¯¸í„° ì¶”ê°€
    if (filter === 'own') {
      url += '?filter=own';
    } else if (filter === 'all') {
      url += '?filter=all';
    } else if (filter.startsWith('manager:')) {
      const manager = filter.split(':')[1];
      url += `?filter=manager&manager=${encodeURIComponent(manager)}`;
    }
    
    console.log('ğŸŒ API ìš”ì²­ URL:', url);
    console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì:', currentUser);
    
    const res = await fetch(url, {
      headers: {
        'X-User': currentUser
      }
    });
    
    console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:', res.status, res.statusText);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    console.log('ğŸ“¦ ë°›ì€ ë°ì´í„°:', data);
    console.log('ğŸ“‹ data.items:', data.items);
    console.log('ğŸ“‹ data.itema:', data.itema);
    console.log('ğŸ“‹ data í‚¤ë“¤:', Object.keys(data));
    
    const customerList = data.items || data.itema || [];
    console.log('ğŸ“‹ ìµœì¢… ê³ ê° ëª©ë¡:', customerList);
    
    // ê° ê³ ê° ê°ì²´ì˜ ì†ì„± í™•ì¸
    if (customerList.length > 0) {
      console.log('ğŸ” ì²« ë²ˆì§¸ ê³ ê° ê°ì²´:', customerList[0]);
      console.log('ğŸ” ì²« ë²ˆì§¸ ê³ ê°ì˜ ì†ì„±ë“¤:', Object.keys(customerList[0]));
      console.log('ğŸ” ì²« ë²ˆì§¸ ê³ ê°ì˜ name:', customerList[0].name);
      console.log('ğŸ” ì²« ë²ˆì§¸ ê³ ê°ì˜ phone:', customerList[0].phone);
    }
    
    console.log('ğŸš€ renderCustomerList í˜¸ì¶œ ì§ì „ customerList:', customerList);
    console.log('ğŸš€ renderCustomerList í˜¸ì¶œ ì§ì „ ì²« ë²ˆì§¸ ê³ ê°:', customerList[0]);
    
    renderCustomerList(customerList);
  } catch (err) {
    console.error('ê³ ê° ëª©ë¡ ìš”ì²­ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', err);
  }
}

function renderCustomerList(list) {
  console.log('ğŸ” renderCustomerList í˜¸ì¶œ:', list);
  console.log('ğŸ” renderCustomerList ë§¤ê°œë³€ìˆ˜ íƒ€ì…:', typeof list);
  console.log('ğŸ” renderCustomerList ë§¤ê°œë³€ìˆ˜ ê¸¸ì´:', list ? list.length : 'undefined');
  console.log('ğŸ” ê³ ê° ID ëª©ë¡:', list.map(c => c.id));
  console.log('ğŸ” ì²« ë²ˆì§¸ ê³ ê° ìƒì„¸:', list[0]);
  console.log('ğŸ” ì²« ë²ˆì§¸ ê³ ê° íƒ€ì…:', typeof list[0]);
  console.log('ğŸ” ì²« ë²ˆì§¸ ê³ ê° í‚¤ë“¤:', list[0] ? Object.keys(list[0]) : 'undefined');
  
  // ì „ì—­ ë³€ìˆ˜ì— ê³ ê° ëª©ë¡ ì €ì¥ (ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ìš©)
  window.currentCustomerList = list;
  console.log('ğŸ” window.currentCustomerList ì„¤ì • í›„:', window.currentCustomerList);
  console.log('ğŸ” window.currentCustomerList ì²« ë²ˆì§¸ ê³ ê°:', window.currentCustomerList[0]);
  
  // 2ì°¨ ì‚¬ì´ë“œë°”ì˜ ê³ ê° ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ê¸°
  let customerListContent = document.getElementById("customerListContent2");
  if (!customerListContent) {
    // viewCustomerList ë‚´ë¶€ì—ì„œ ì°¾ê¸°
    const viewCustomerList = document.getElementById("viewCustomerList");
    if (viewCustomerList) {
      customerListContent = viewCustomerList.querySelector(".customer-list-container div");
    }
  }
  if (!customerListContent) {
    customerListContent = document.getElementById("customerListContent");
  }
  
  if (!customerListContent) {
    console.error("ê³ ê° ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // ê³ ê° ëª©ë¡ì„ ì¹´ë“œ í˜•íƒœë¡œ ë Œë”ë§
  customerListContent.innerHTML = '';
  
  if (list.length === 0) {
    customerListContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">ë“±ë¡ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  // í•„í„° ì˜ì—­ì„ ê°™ì€ ì¤„ì— ë°°ì¹˜
  const titleContainer = document.createElement('div');
  titleContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 0 4px;';
  
  // í•„í„° ì˜ì—­
  const filterContainer = document.createElement('div');
  filterContainer.style.cssText = 'display: flex; gap: 8px; align-items: center;';
  
  // ë‹´ë‹¹ì í•„í„° (ì–´ë“œë¯¼ì¸ ê²½ìš°ë§Œ)
  if (currentUser === 'darkbirth@naver.com' || currentUser === 'darkbirth1@gmail.com' || currentUser === 'jeonghannah@naver.com') {
    const managerFilter = document.createElement('select');
    managerFilter.id = 'customerFilterSelect';
    managerFilter.style.cssText = 'padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; min-width: 100px;';
    managerFilter.innerHTML = '<option value="all">ì „ì²´ ê³ ê°</option>';
    
    // ë‹´ë‹¹ì ëª©ë¡ì„ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
    fetch('/api/customers/managers', {
      headers: { 'X-User': currentUser }
    })
    .then(response => response.json())
    .then(data => {
      if (data.managers && data.managers.length > 0) {
        data.managers.forEach(manager => {
          const option = document.createElement('option');
          option.value = `manager:${manager}`;
          option.textContent = `${manager} ê³ ê°`;
          managerFilter.appendChild(option);
        });
      }
    })
    .catch(error => {
      console.error('ë‹´ë‹¹ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    });
    
    managerFilter.addEventListener('change', handleCustomerFilterChange);
    filterContainer.appendChild(managerFilter);
  }
  
  // ìƒíƒœ í•„í„° (ëª¨ë“  ì‚¬ìš©ì)
  const statusFilter = document.createElement('select');
  statusFilter.id = 'customerStatusFilter';
  statusFilter.style.cssText = 'padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; min-width: 70px;';
  statusFilter.innerHTML = `
    <option value="all">ì „ì²´ ìƒíƒœ</option>
    <option value="ìƒ">ìƒì„±</option>
    <option value="ì™„">ì™„ë£Œ</option>
    <option value="ë³´ë¥˜">ë³´ë¥˜</option>
    <option value="í¬ê¸°">í¬ê¸°</option>
  `;
  statusFilter.addEventListener('change', handleStatusFilterChange);
  filterContainer.appendChild(statusFilter);
  
  titleContainer.appendChild(filterContainer);
  customerListContent.appendChild(titleContainer);
  
  // ê³ ê° ëª©ë¡ ë Œë”ë§
  renderCustomerListItems(list);
};

// í•„í„°ë§ëœ ê³ ê° ëª©ë¡ë§Œ ë Œë”ë§ (í•„í„°ëŠ” ìœ ì§€)
function renderFilteredCustomerList(filteredList) {
  // ê³ ê° ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ê¸°
  let customerListContent = document.getElementById("customerListContent2");
  if (!customerListContent) {
    const viewCustomerList = document.getElementById("viewCustomerList");
    if (viewCustomerList) {
      customerListContent = viewCustomerList.querySelector(".customer-list-container div");
    }
  }
  if (!customerListContent) {
    customerListContent = document.getElementById("customerListContent");
  }
  
  if (!customerListContent) {
    console.error("ê³ ê° ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // ê¸°ì¡´ ê³ ê° ëª©ë¡ ì»¨í…Œì´ë„ˆ ì œê±° (í•„í„°ëŠ” ìœ ì§€)
  const existingListContainer = customerListContent.querySelector('.customer-list-items');
  if (existingListContainer) {
    existingListContainer.remove();
  }
  
  // í•„í„°ë§ëœ ëª©ë¡ ë Œë”ë§
  renderCustomerListItems(filteredList);
};

// ê³ ê° ëª©ë¡ ì•„ì´í…œë§Œ ë Œë”ë§
function renderCustomerListItems(list) {
  // ê³ ê° ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ê¸°
  let customerListContent = document.getElementById("customerListContent2");
  if (!customerListContent) {
    const viewCustomerList = document.getElementById("viewCustomerList");
    if (viewCustomerList) {
      customerListContent = viewCustomerList.querySelector(".customer-list-container div");
    }
  }
  if (!customerListContent) {
    customerListContent = document.getElementById("customerListContent");
  }
  
  if (!customerListContent) {
    console.error("ê³ ê° ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // ê³ ê° ëª©ë¡ ì»¨í…Œì´ë„ˆ
  const listContainer = document.createElement('div');
  listContainer.className = 'customer-list-items';
  listContainer.style.cssText = 'height: auto; overflow: visible; padding-right: 4px;';
  
  list.forEach((c, index) => {
    console.log(`ğŸ” ê³ ê° ${index + 1} ë Œë”ë§:`, c);
    console.log(`ğŸ” ê³ ê° ${index + 1} ì´ë¦„:`, c.name);
    console.log(`ğŸ” ê³ ê° ${index + 1} ì „í™”ë²ˆí˜¸:`, c.phone);
    
    const customerCard = document.createElement('div');
    customerCard.className = 'customer-card';
    customerCard.style.cssText = `
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    `;
    
    // ë”ë¸”í´ë¦­ ì•ˆë‚´ íˆ´íŒ ì¶”ê°€
    customerCard.title = "í´ë¦­: ìƒì„¸ë³´ê¸° | ë”ë¸”í´ë¦­: í•„í„°ì ìš© | ìš°í´ë¦­: ë©”ë‰´ (ìˆ˜ì •/ìƒíƒœë³€ê²½/ì‚­ì œ)";
    
    // ê³ ê° ì •ë³´ ìš”ì•½
    const summary = [];
    if (c.regions) summary.push(`ğŸ“ ${c.regions}`);
    if (c.floor) summary.push(`ğŸ¢ ${c.floor}ì¸µ`);
    if (c.area) summary.push(`ğŸ“ ${c.area}í‰`);
    if (c.deposit) summary.push(`ğŸ’° ë³´:${c.deposit}`);
    if (c.rent) summary.push(`ğŸ’µ ì›”:${c.rent}`);
    if (c.premium) summary.push(`ğŸ”‘ ê¶Œ:${c.premium}`);
    
    // ì°¸ê³ ì‚¬í•­ ì²˜ë¦¬ (ê¸´ ê²½ìš° ì¤„ì„)
    let notesDisplay = '';
    if (c.notes && c.notes.trim()) {
      const notes = c.notes.trim();
      notesDisplay = notes.length > 30 ? notes.substring(0, 30) + '...' : notes;
    }
    
    // ìƒíƒœ í‘œì‹œ (í´ë¦­ ê°€ëŠ¥í•œ ë“œë¡­ë‹¤ìš´)
    const status = c.status || 'ìƒ';
    const statusConfig = {
      'ìƒ': { label: 'ìƒì„±', color: '#28a745', bgColor: '#d4edda' },
      'ì™„': { label: 'ì™„ë£Œ', color: '#0c5460', bgColor: '#d1ecf1' },
      'ë³´ë¥˜': { label: 'ë³´ë¥˜', color: '#856404', bgColor: '#fff3cd' },
      'í¬ê¸°': { label: 'í¬ê¸°', color: '#721c24', bgColor: '#f8d7da' }
    };
    const statusInfo = statusConfig[status] || statusConfig['ìƒ'];
    
    customerCard.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
        <div style="font-weight: bold; color: #333; font-size: 14px;">${escapeHtml(c.name || 'ì´ë¦„ ì—†ìŒ')}</div>
        <div style="display: flex; align-items: center; gap: 4px;">
          <span style="color: #666; font-size: 11px;">ğŸ‘¤ ${escapeHtml(c.manager || 'ë‹´ë‹¹ì ì—†ìŒ')}</span>
          <span class="status-badge" 
                style="background: ${statusInfo.bgColor}; color: ${statusInfo.color}; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; cursor: pointer; transition: all 0.2s ease;"
                onclick="event.stopPropagation(); showStatusDropdown(event, '${c.id}', '${status}')"
                title="í´ë¦­í•˜ì—¬ ìƒíƒœ ë³€ê²½">${statusInfo.label}</span>
        </div>
      </div>
      <div style="color: #666; font-size: 12px; margin-bottom: 3px;">ğŸ“ ${escapeHtml(c.phone || 'ì—°ë½ì²˜ ì—†ìŒ')}</div>
      <div style="color: #666; font-size: 11px; line-height: 1.2; margin-bottom: 3px;">
        ${summary.length > 0 ? summary.join(' | ') : 'í¬ë§ ì¡°ê±´ ì—†ìŒ'}
      </div>
      ${notesDisplay ? `<div style="color: #888; font-size: 10px; line-height: 1.1; font-style: italic;">ğŸ“ ${escapeHtml(notesDisplay)}</div>` : ''}
    `;
    
    customerCard.addEventListener('click', (e) => {
      // ìƒíƒœ ë°°ì§€ í´ë¦­ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê³ ê° ìƒì„¸ë³´ê¸° ì‹¤í–‰
      if (!e.target.classList.contains('status-badge')) {
        showCustomerDetail(c);
      }
    });
    
    // ë”ë¸”í´ë¦­ ì‹œ í•„í„° ì ìš©
    customerCard.addEventListener('dblclick', () => {
      applyCustomerFilter(c);
    });
    
    // ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì¶”ê°€
    customerCard.addEventListener('contextmenu', (e) => {
      console.log('ğŸ–±ï¸ ìš°í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ:', e);
      console.log('ğŸ–±ï¸ ìš°í´ë¦­í•œ ê³ ê°:', c);
      e.preventDefault();
      showCustomerContextMenu(e, c);
    });
    
    customerCard.addEventListener('mouseenter', () => {
      customerCard.style.backgroundColor = '#f0f8ff';
      customerCard.style.borderColor = '#1976d2';
      customerCard.style.boxShadow = '0 2px 4px rgba(25, 118, 210, 0.1)';
    });
    
    customerCard.addEventListener('mouseleave', () => {
      customerCard.style.backgroundColor = 'white';
      customerCard.style.borderColor = '#e0e0e0';
      customerCard.style.boxShadow = 'none';
    });
    
    // ìƒíƒœ ë°°ì§€ í˜¸ë²„ íš¨ê³¼ ì¶”ê°€
    const statusBadge = customerCard.querySelector('.status-badge');
    if (statusBadge) {
      statusBadge.addEventListener('mouseenter', () => {
        statusBadge.style.transform = 'scale(1.05)';
        statusBadge.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
      });
      
      statusBadge.addEventListener('mouseleave', () => {
        statusBadge.style.transform = 'scale(1)';
        statusBadge.style.boxShadow = 'none';
      });
    }
    
    listContainer.appendChild(customerCard);
  });
  
  customerListContent.appendChild(listContainer);
}

// ê³ ê° ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
function showCustomerContextMenu(e, customer) {
  console.log('ğŸ“‹ showCustomerContextMenu í˜¸ì¶œ:', customer);
  console.log('ğŸ“‹ ê³ ê° ID:', customer.id);
  
  // ê¸°ì¡´ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì œê±°
  const existingMenu = document.getElementById('customerContextMenu');
  if (existingMenu) {
    existingMenu.remove();
  }
  
  // ìƒˆ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìƒì„±
  const contextMenu = document.createElement('div');
  contextMenu.id = 'customerContextMenu';
  contextMenu.style.cssText = `
    position: fixed;
    top: ${e.clientY}px;
    left: ${e.clientX}px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    z-index: 999999;
    min-width: 120px;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  `;
  
  console.log('ğŸ“‹ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ HTML ìƒì„± ì¤‘...');
  contextMenu.innerHTML = `
    <div class="context-menu-item" data-action="edit" data-customer-id="${customer.id}" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px;">âœï¸ ìˆ˜ì •</div>
    <div class="context-menu-item" data-action="status" data-customer-id="${customer.id}" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px;">ğŸ”„ ìƒíƒœë³€ê²½</div>
    <div class="context-menu-item" data-action="delete" data-customer-id="${customer.id}" style="padding: 8px 12px; cursor: pointer; font-size: 13px; color: #dc3545;">ğŸ—‘ï¸ ì‚­ì œ</div>
  `;
  console.log('ğŸ“‹ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ HTML ìƒì„± ì™„ë£Œ');
  
  // í˜¸ë²„ íš¨ê³¼ ë° í´ë¦­ ì´ë²¤íŠ¸
  const menuItems = contextMenu.querySelectorAll('.context-menu-item');
  menuItems.forEach(item => {
    item.addEventListener('mouseenter', () => {
      item.style.backgroundColor = '#f5f5f5';
    });
    item.addEventListener('mouseleave', () => {
      item.style.backgroundColor = 'white';
    });
    
    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    item.addEventListener('click', async (e) => {
      e.stopPropagation();
      const action = item.getAttribute('data-action');
      const customerId = item.getAttribute('data-customer-id');
      console.log('ğŸ–±ï¸ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í´ë¦­:', action, customerId);
      
      if (action === 'edit') {
        console.log('ğŸ”§ editCustomerById í•¨ìˆ˜ í˜¸ì¶œ ì‹œë„:', customerId);
        console.log('ğŸ”§ editCustomerById í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€:', typeof window.editCustomerById);
        if (typeof window.editCustomerById === 'function') {
          console.log('ğŸ”§ editCustomerById í•¨ìˆ˜ í˜¸ì¶œ ì§ì „');
          console.log('ğŸ”§ customerId ê°’:', customerId);
          console.log('ğŸ”§ window.editCustomerById í•¨ìˆ˜:', window.editCustomerById);
          try {
            const result = await window.editCustomerById(customerId);
            console.log('ğŸ”§ editCustomerById í•¨ìˆ˜ í˜¸ì¶œ ì™„ë£Œ, ê²°ê³¼:', result);
          } catch (error) {
            console.error('âŒ editCustomerById í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
          }
        } else {
          console.error('âŒ editCustomerById í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
      } else if (action === 'status') {
        console.log('ğŸ”„ changeCustomerStatusById í•¨ìˆ˜ í˜¸ì¶œ ì‹œë„:', customerId);
        if (typeof window.changeCustomerStatusById === 'function') {
          window.changeCustomerStatusById(customerId);
        } else {
          console.error('âŒ changeCustomerStatusById í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
      } else if (action === 'delete') {
        console.log('ğŸ—‘ï¸ deleteCustomerById í•¨ìˆ˜ í˜¸ì¶œ ì‹œë„:', customerId);
        if (typeof window.deleteCustomerById === 'function') {
          window.deleteCustomerById(customerId);
        } else {
          console.error('âŒ deleteCustomerById í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
      }
      
      contextMenu.remove();
    });
  });
  
  document.body.appendChild(contextMenu);
  console.log('ğŸ“‹ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ DOMì— ì¶”ê°€ ì™„ë£Œ');
  console.log('ğŸ“‹ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìœ„ì¹˜:', e.clientX, e.clientY);
  
  // ë‹¤ë¥¸ ê³³ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
  setTimeout(() => {
    document.addEventListener('click', function closeMenu() {
      contextMenu.remove();
      document.removeEventListener('click', closeMenu);
    });
  }, 100);
}
// ê³ ê° ìˆ˜ì • í•¨ìˆ˜
window.editCustomerById = async function(customerId) {
  console.log('ğŸ”§ editCustomer í˜¸ì¶œ:', customerId);
  console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì:', currentUser);
  console.log('ğŸ” í˜„ì¬ ê³ ê° ëª©ë¡:', window.currentCustomerList);
  console.log('ğŸ” ì°¾ì„ ê³ ê° ID:', customerId);
  
  try {
    // í˜„ì¬ ë¡œë“œëœ ê³ ê° ëª©ë¡ì—ì„œ ê³ ê° ë°ì´í„° ì°¾ê¸°
    const customer = window.currentCustomerList.find(c => c.id === customerId);
    console.log('ğŸ” í˜„ì¬ ê³ ê° ëª©ë¡ì—ì„œ ì°¾ì€ ê³ ê°:', customer);
    
    if (!customer) {
      console.error('âŒ ê³ ê°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', customerId);
      alert('ê³ ê° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    console.log('âœ… ê³ ê° ë°ì´í„° ì°¾ìŒ:', customer);
    
    // í˜„ì¬ ì„ íƒëœ ê³ ê° ì €ì¥ (ì·¨ì†Œ ë²„íŠ¼ìš©)
    window.selectedCustomer = customer;
    
    // ìˆ˜ì • ì „ìš© íŒ¨ë„ ì—´ê¸°
    showSecondaryPanel('viewCustomerEdit');
    renderCustomerEditForm(customer);
    
    // ì œëª© ë³€ê²½
    const detailTitleEl = document.getElementById("secondaryPanelTitle");
    if (detailTitleEl) {
      detailTitleEl.textContent = "ê³ ê° ì •ë³´ ìˆ˜ì •";
    }
  } catch (error) {
    console.error('ê³ ê° ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜:', error);
    alert('ê³ ê° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê³ ê° ì‚­ì œ í•¨ìˆ˜
window.deleteCustomerById = async function(customerId) {
  console.log('ğŸ—‘ï¸ deleteCustomer í˜¸ì¶œ:', customerId);
  console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì:', currentUser);
  
  if (!confirm('ì •ë§ë¡œ ì´ ê³ ê°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  try {
    const url = `/api/customers/${customerId}`;
    console.log('ğŸŒ ìš”ì²­ URL:', url);
    
    const response = await fetch(url, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-User': currentUser
      }
    });
    
    console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
    
    if (response.ok) {
      showToast('ê³ ê°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      // ê³ ê° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      loadCustomerList();
    } else {
      const error = await response.text();
      console.error('âŒ ì‚­ì œ ì‹¤íŒ¨:', error);
      alert(`ì‚­ì œ ì‹¤íŒ¨: ${error}`);
    }
  } catch (error) {
    console.error('ê³ ê° ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
    alert('ê³ ê° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê³ ê° IDë¡œ ê³ ê° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
function getCustomerById(customerId) {
  // í˜„ì¬ ë¡œë“œëœ ê³ ê° ëª©ë¡ì—ì„œ ì°¾ê¸°
  // ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ì¢‹ì§€ë§Œ, ê°„ë‹¨íˆ êµ¬í˜„
  return window.currentCustomerList ? window.currentCustomerList.find(c => c.id === customerId) : null;
}

// ê³ ê° ì„ íƒ ì´ˆê¸°í™”
function clearCustomerSelection() {
  // ì„ íƒëœ ê³ ê° ì´ˆê¸°í™”
  window.selectedCustomer = null;
  
  // ë¸Œë¦¬í•‘ ìƒíƒœ ì´ˆê¸°í™”
  loadBriefingStates(null);
  
  // ë¸Œë¦¬í•‘ ë¦¬ìŠ¤íŠ¸ ëª¨ë“œ í•´ì œí•˜ê³  ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸ë¡œ ê¸°ë³¸ ì„¤ì •
  UI_STATE.isBriefingListMode = false;
  UI_STATE.currentCustomerId = null;
  
  // ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸°
  const modeButtons = document.querySelector('.listing-mode-buttons');
  if (modeButtons) {
    modeButtons.classList.add('hidden');
  }
  
  // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™” (ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸ê°€ ê¸°ë³¸ ì„ íƒ)
  const propertyBtn = document.getElementById("propertyListBtn");
  const briefingBtn = document.getElementById("briefingListBtn");
  
  if (propertyBtn) {
    propertyBtn.classList.add("active");
    propertyBtn.setAttribute("data-mode", "property");
  }
  if (briefingBtn) {
    briefingBtn.classList.remove("active");
    briefingBtn.removeAttribute("data-mode");
  }
  
  // ê³ ê° ì •ë³´ ìˆ¨ê¸°ê³  ê³ ê° ëª©ë¡ í‘œì‹œ
  const selectedCustomerInfo = document.getElementById("selectedCustomerInfo");
  const customerListContainer = document.getElementById("customerListContainer");
  
  if (selectedCustomerInfo) selectedCustomerInfo.classList.add("hidden");
  if (customerListContainer) customerListContainer.classList.remove("hidden");
  
  // ê³ ê° í•„í„° í•´ì œ
  clearCustomerFilter();
  
  // ë¸Œë¦¬í•‘ í•„í„° ì ìš©
  applyBriefingFilters();
}

function showCustomerDetail(c) {
  // 2ì°¨ ì‚¬ì´ë“œë°”ì— ê³ ê° ìƒì„¸ì •ë³´ í‘œì‹œ
  const detailTitleEl = document.getElementById('secondaryPanelTitle');
  
  if (detailTitleEl) {
    detailTitleEl.textContent = 'ê³ ê° ìƒì„¸ì •ë³´';
  }
  
  // í˜„ì¬ ì„ íƒëœ ê³ ê° ì €ì¥
  window.selectedCustomer = c;
  
  // ë¸Œë¦¬í•‘ ìƒíƒœ ë¡œë“œ
  loadBriefingStates(c.id);
  
  // í˜„ì¬ ê³ ê° ID ì €ì¥
  UI_STATE.currentCustomerId = c.id;
  
  // ê³ ê° ìƒì„¸ì •ë³´ í™”ë©´ í‘œì‹œ
  showSecondaryPanel('viewCustomerDetail');
  
  // ê³ ê° ìƒì„¸ì •ë³´ ë Œë”ë§
  renderCustomerDetail(c);
};

// ê³ ê° ìƒì„¸ì •ë³´ ë Œë”ë§ í•¨ìˆ˜
function renderCustomerDetail(c) {
  console.log('renderCustomerDetail í˜¸ì¶œë¨:', c);
  
  const customerDetailContent = document.getElementById('customerDetailContent');
  
  console.log('customerDetailContent ìš”ì†Œ:', customerDetailContent);
  
  if (!customerDetailContent) {
    console.error('ê³ ê° ìƒì„¸ì •ë³´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  console.log('HTML ë Œë”ë§ ì‹œì‘');
  customerDetailContent.innerHTML = `
    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px; margin-bottom: 8px;">
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">ë‹´ë‹¹ì</label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.manager || 'ë‹´ë‹¹ì ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">ê³ ê°ëª…</label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.name || 'ì´ë¦„ ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">ì—°ë½ì²˜</label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.phone || 'ì—°ë½ì²˜ ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">í¬ë§ì§€ì—­</label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.regions || 'í¬ë§ì§€ì—­ ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">í¬ë§ì¸µìˆ˜</label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.floor || 'í¬ë§ì¸µìˆ˜ ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">í¬ë§ë©´ì </label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.area || 'í¬ë§ë©´ì  ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">í¬ë§ë³´ì¦ê¸ˆ</label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.deposit || 'í¬ë§ë³´ì¦ê¸ˆ ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">í¬ë§ì›”ì„¸</label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.rent || 'í¬ë§ì›”ì„¸ ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">í¬ë§ê¶Œë¦¬ê¸ˆ</label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.premium || 'í¬ë§ê¶Œë¦¬ê¸ˆ ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">ì°¸ê³ ì‚¬í•­</label>
        <div style="padding: 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333; min-height: 60px; white-space: pre-wrap; line-height: 1.4;">${escapeHtml(c.notes || 'ì°¸ê³ ì‚¬í•­ ì—†ìŒ')}</div>
      </div>
      
      <div class="detail-row" style="margin-bottom: 6px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 2px; font-size: 12px;">ìƒíƒœ</label>
        <div style="padding: 4px 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #333;">${escapeHtml(c.status || 'ìƒ')}</div>
      </div>
    </div>
    
    <div class="detail-actions" style="display: flex; justify-content: space-between; gap: 8px; margin-top: 8px;">
      <div style="display: flex; gap: 4px;">
        <button id="selectCustomerBtn" class="btn" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">ì„ íƒ</button>
        <button id="backToListBtn" class="btn" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì´ì „í™”ë©´</button>
      </div>
      <div style="display: flex; gap: 4px;">
        <button id="editCustomerDetailBtn" class="btn" style="padding: 8px 12px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ìˆ˜ì •</button>
        <button id="deleteCustomerDetailBtn" class="btn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
      </div>
    </div>
  `;
  
  console.log('HTML ë Œë”ë§ ì™„ë£Œ');
  
  // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  const selectBtn = document.getElementById('selectCustomerBtn');
  const backBtn = document.getElementById('backToListBtn');
  const editBtn = document.getElementById('editCustomerDetailBtn');
  const deleteBtn = document.getElementById('deleteCustomerDetailBtn');
  
  if (selectBtn) selectBtn.addEventListener('click', () => {
    // 1ì°¨ì‚¬ì´ë“œë°”ì— ê³ ê°ì •ë³´ ì…ë ¥
    console.log('ì„ íƒ ë²„íŠ¼ í´ë¦­:', c);
    
    // 1ì°¨ì‚¬ì´ë“œë°”ì— ê³ ê°ì •ë³´ í‘œì‹œ
    const selectedCustomerInfo = document.getElementById("selectedCustomerInfo");
    const customerInfoContent = document.getElementById("customerInfoContent");
    const customerListContainer = document.getElementById("customerListContainer");
    
    if (selectedCustomerInfo && customerInfoContent) {
      // ê³ ê° ëª©ë¡ ìˆ¨ê¸°ê³  ê³ ê° ì •ë³´ í‘œì‹œ
      if (customerListContainer) customerListContainer.classList.add("hidden");
      selectedCustomerInfo.classList.remove("hidden");
      
      // í˜„ì¬ ì„ íƒëœ ê³ ê° ì €ì¥
      window.selectedCustomer = c;
      
      // ê³ ê°ì •ë³´ ë‚´ìš© ë Œë”ë§
      customerInfoContent.innerHTML = `
        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <div style="font-weight: bold; color: #333; font-size: 14px;">${escapeHtml(c.name || 'ì´ë¦„ ì—†ìŒ')}</div>
            <div style="color: #666; font-size: 11px;">ğŸ‘¤ ${escapeHtml(c.manager || 'ë‹´ë‹¹ì ì—†ìŒ')}</div>
          </div>
          <div style="color: #666; font-size: 12px; margin-bottom: 3px;">ğŸ“ ${escapeHtml(c.phone || 'ì—°ë½ì²˜ ì—†ìŒ')}</div>
          <div style="color: #666; font-size: 11px; line-height: 1.2; margin-bottom: 3px;">
            ${(() => {
              const summary = [];
              if (c.regions) summary.push(`ğŸ“ ${c.regions}`);
              if (c.floor || c.floor_pref) summary.push(`ğŸ¢ ${c.floor || c.floor_pref}ì¸µ`);
              if (c.area || c.area_pref) summary.push(`ğŸ“ ${c.area || c.area_pref}í‰`);
              if (c.deposit || c.deposit_pref) summary.push(`ğŸ’° ë³´:${c.deposit || c.deposit_pref}`);
              if (c.rent || c.rent_pref) summary.push(`ğŸ’µ ì›”:${c.rent || c.rent_pref}`);
              if (c.premium || c.premium_pref) summary.push(`ğŸ”‘ ê¶Œ:${c.premium || c.premium_pref}`);
              return summary.length > 0 ? summary.join(' | ') : 'í¬ë§ ì¡°ê±´ ì—†ìŒ';
            })()}
          </div>
          ${c.notes && c.notes.trim() ? `<div style="color: #888; font-size: 10px; line-height: 1.1; font-style: italic;">ğŸ“ ${escapeHtml(c.notes.trim())}</div>` : ''}
        </div>
        
        <div class="detail-actions" style="display: flex; gap: 4px; margin-bottom: 12px;">
          <button id="applyCustomerFilterBtn" class="btn" style="flex: 1; padding: 4px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">ì„ íƒ</button>
          <button id="editCustomerBtn" class="btn" style="flex: 1; padding: 4px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">ìˆ˜ì •</button>
          <button id="deleteCustomerBtn" class="btn" style="flex: 1; padding: 4px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">ì‚­ì œ</button>
          <button id="clearCustomerSelectionBtn" class="btn" style="flex: 1; padding: 4px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">ì´ˆê¸°í™”</button>
        </div>
      `;
      
      // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      const applyFilterBtn = document.getElementById('applyCustomerFilterBtn');
      const editBtn = document.getElementById('editCustomerBtn');
      const deleteBtn = document.getElementById('deleteCustomerBtn');
      const clearBtn = document.getElementById('clearCustomerSelectionBtn');
      
      if (applyFilterBtn) applyFilterBtn.addEventListener('click', () => applyCustomerFilter(c));
      if (editBtn) editBtn.addEventListener('click', () => window.editCustomerById(c.id));
      if (deleteBtn) deleteBtn.addEventListener('click', () => {
        if (confirm('ì •ë§ë¡œ ì´ ê³ ê°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          window.deleteCustomerById(c.id);
        }
      });
      if (clearBtn) clearBtn.addEventListener('click', clearCustomerSelection);
    }
    
    // 2ì°¨ì‚¬ì´ë“œë°” ë‹«ê¸°
    const secondaryPanel = document.getElementById('secondaryPanel');
    if (secondaryPanel) {
      secondaryPanel.classList.add('hidden');
      secondaryPanel.classList.remove('visible');
    }
  });
  
  if (backBtn) backBtn.addEventListener('click', () => {
    // ê³ ê°ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    showSecondaryPanel('viewCustomerList');
    const detailTitleEl = document.getElementById('secondaryPanelTitle');
    if (detailTitleEl) detailTitleEl.textContent = currentUser === 'admin' ? 'ê³ ê° ëª©ë¡' : 'ë‚´ ê³ ê° ëª©ë¡';
  });
  
  if (editBtn) editBtn.addEventListener('click', () => {
    // ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ì´ë™
    console.log('ìˆ˜ì • ë²„íŠ¼ í´ë¦­:', c);
    
    // í˜„ì¬ ì„ íƒëœ ê³ ê° ì €ì¥ (ì·¨ì†Œ ë²„íŠ¼ìš©)
    window.selectedCustomer = c;
    
    // ìˆ˜ì • ì „ìš© íŒ¨ë„ ì—´ê¸°
    showSecondaryPanel('viewCustomerEdit');
    renderCustomerEditForm(c);
    
    // ì œëª© ë³€ê²½
    const detailTitleEl = document.getElementById("secondaryPanelTitle");
    if (detailTitleEl) {
      detailTitleEl.textContent = "ê³ ê° ì •ë³´ ìˆ˜ì •";
    }
  });
  
  if (deleteBtn) deleteBtn.addEventListener('click', () => {
    // ì‚­ì œ í™•ì¸ í›„ ì‹¤í–‰
    if (confirm('ì •ë§ë¡œ ì´ ê³ ê°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      window.deleteCustomerById(c.id).then(() => {
        // ì‚­ì œ ì™„ë£Œ í›„ ìƒì„¸ì •ë³´ì°½ ë‹«ê³  ê³ ê°ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        showSecondaryPanel('viewCustomerList');
        const detailTitleEl = document.getElementById('secondaryPanelTitle');
        if (detailTitleEl) detailTitleEl.textContent = currentUser === 'admin' ? 'ê³ ê° ëª©ë¡' : 'ë‚´ ê³ ê° ëª©ë¡';
      });
    }
  });
}

function renderCustomerForm(c = {}) {
  showSecondaryPanel('viewCustomerForm');

  const detailTitleEl = document.getElementById("secondaryPanelTitle");
  const viewCustomerForm = document.getElementById("viewCustomerForm");
  
  if (!detailTitleEl || !viewCustomerForm) return;

  detailTitleEl.textContent = c.id ? "ê³ ê° ì •ë³´ ìˆ˜ì •" : "ê³ ê° ì‹ ê·œë“±ë¡";

  viewCustomerForm.innerHTML = `
    <div style="background: #f8f9fa; padding: 8px; border-radius: 8px; margin-bottom: 10px;">
      <div style="font-size: 14px; font-weight: bold; color: #333;">${c.id ? 'ê³ ê° ì •ë³´ ìˆ˜ì •' : 'ìƒˆ ê³ ê° ë“±ë¡'}</div>
      <div style="color: #666; font-size: 12px; margin-top: 2px;">ê³ ê° ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
    </div>
    
    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px;">
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">ë‹´ë‹¹ì *</label>
        <input class="form-control" id="frmManager" 
               value="${escapeHtml(c.manager || '')}" 
               placeholder="ë‹´ë‹¹ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">ê³ ê°ëª… *</label>
        <input class="form-control" id="frmName" 
               value="${escapeHtml(c.name || '')}"
               placeholder="ê³ ê°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">ì—°ë½ì²˜ *</label>
        <input class="form-control" id="frmPhone" 
               value="${escapeHtml(c.phone || '')}" 
               placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ì§€ì—­</label>
        <input class="form-control" id="frmRegions" 
               value="${escapeHtml(c.regions || '')}" 
               placeholder="í¬ë§ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ì¸µìˆ˜</label>
        <input class="form-control" id="frmFloor" 
               value="${escapeHtml(c.floor_pref || '')}" 
               placeholder="í¬ë§ì¸µìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ë©´ì </label>
        <input class="form-control" id="frmArea" 
               value="${escapeHtml(c.area_pref || '')}" 
               placeholder="ì˜ˆ: 20 (20í‰ ì´ìƒ) ë˜ëŠ” 10-20 (10~20í‰ ë²”ìœ„)"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ë³´ì¦ê¸ˆ</label>
        <input class="form-control" id="frmDeposit" 
               value="${escapeHtml(c.deposit_pref || '')}"
               placeholder="í¬ë§ë³´ì¦ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ì›”ì„¸</label>
        <input class="form-control" id="frmRent" 
               value="${escapeHtml(c.rent_pref || '')}"
               placeholder="í¬ë§ì›”ì„¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ê¶Œë¦¬ê¸ˆ</label>
        <input class="form-control" id="frmPremium" 
               value="${escapeHtml(c.premium_pref || '')}"
               placeholder="í¬ë§ê¶Œë¦¬ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">ì°¸ê³ ì‚¬í•­</label>
        <textarea class="form-control" id="frmNotes"
                  rows="4" placeholder="ì°¸ê³ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"
                  style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; resize: vertical; max-height: 120px; overflow-y: auto; margin-left: -8px;">${escapeHtml(c.notes || '')}</textarea>
      </div>
    </div>
    
    <div class="detail-actions" style="margin-top: 6px; display: flex; gap: 6px;">
      <button id="saveCustomerBtn" class="btn" style="flex: 1; padding: 6px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px;">ì €ì¥</button>
      <button id="cancelCustomerBtn" class="btn" style="flex: 1; padding: 6px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì·¨ì†Œ</button>
    </div>
  `;

  const saveBtn = document.getElementById('saveCustomerBtn');
  const cancelBtn = document.getElementById('cancelCustomerBtn');
  
  if (saveBtn) saveBtn.addEventListener('click', () => submitCustomerForm(c.id || 'new'));
  if (cancelBtn) cancelBtn.addEventListener('click', () => {
    console.log('ì‹ ê·œë“±ë¡ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ë¨');
    console.log('window.selectedCustomer:', window.selectedCustomer);
    
    // ê³ ê°ìƒì„¸ì •ë³´ë¡œ ëŒì•„ê°€ê¸°
    if (window.selectedCustomer) {
      console.log('ê³ ê°ìƒì„¸ì •ë³´ë¡œ ëŒì•„ê°€ê¸°');
      renderCustomerDetail(window.selectedCustomer);
    } else {
      console.log('ê³ ê°ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°');
      // ì„ íƒëœ ê³ ê°ì´ ì—†ìœ¼ë©´ ê³ ê°ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
      showSecondaryPanel('viewCustomerList');
      const detailTitleEl = document.getElementById('secondaryPanelTitle');
      if (detailTitleEl) detailTitleEl.textContent = currentUser === 'admin' ? 'ê³ ê° ëª©ë¡' : 'ë‚´ ê³ ê° ëª©ë¡';
    }
  });
}
// ê³ ê° ìˆ˜ì • ì „ìš© í¼ ë Œë”ë§ í•¨ìˆ˜
function renderCustomerEditForm(c = {}) {
  const viewCustomerEdit = document.getElementById("viewCustomerEdit");
  
  if (!viewCustomerEdit) return;

  viewCustomerEdit.innerHTML = `
    <div style="background: #fff3cd; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffeaa7;">
      <div style="font-size: 14px; font-weight: bold; color: #856404;">ê³ ê° ì •ë³´ ìˆ˜ì •</div>
      <div style="color: #856404; font-size: 12px; margin-top: 2px;">ê¸°ì¡´ ê³ ê° ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤</div>
    </div>
    
    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px;">
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">ë‹´ë‹¹ì *</label>
        <input class="form-control" id="editManager" 
               value="${escapeHtml(cleanValue(c.manager))}" 
               placeholder="ë‹´ë‹¹ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">ê³ ê°ëª… *</label>
        <input class="form-control" id="editName" 
               value="${escapeHtml(cleanValue(c.name))}"
               placeholder="ê³ ê°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">ì—°ë½ì²˜ *</label>
        <input class="form-control" id="editPhone" 
               value="${escapeHtml(cleanValue(c.phone))}" 
               placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ì§€ì—­</label>
        <input class="form-control" id="editRegions" 
               value="${escapeHtml(cleanValue(c.regions))}" 
               placeholder="í¬ë§ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ì¸µìˆ˜</label>
        <input class="form-control" id="editFloor" 
               value="${escapeHtml(cleanValue(c.floor))}" 
               placeholder="í¬ë§ì¸µìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ë©´ì </label>
        <input class="form-control" id="editArea" 
               value="${escapeHtml(cleanValue(c.area))}" 
               placeholder="ì˜ˆ: 20 (20í‰ ì´ìƒ) ë˜ëŠ” 10-20 (10~20í‰ ë²”ìœ„)"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ë³´ì¦ê¸ˆ</label>
        <input class="form-control" id="editDeposit" 
               value="${escapeHtml(cleanValue(c.deposit))}"
               placeholder="í¬ë§ë³´ì¦ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ì›”ì„¸</label>
        <input class="form-control" id="editRent" 
               value="${escapeHtml(cleanValue(c.rent))}"
               placeholder="í¬ë§ì›”ì„¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">í¬ë§ê¶Œë¦¬ê¸ˆ</label>
        <input class="form-control" id="editPremium" 
               value="${escapeHtml(cleanValue(c.premium))}"
               placeholder="í¬ë§ê¶Œë¦¬ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”"
               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-left: -8px;">
      </div>
      
      <div class="detail-row" style="margin-bottom: 8px;">
        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 3px; font-size: 12px;">ì°¸ê³ ì‚¬í•­</label>
        <textarea class="form-control" id="editNotes"
                  rows="4" placeholder="ì°¸ê³ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"
                  style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; resize: vertical; max-height: 120px; overflow-y: auto; margin-left: -8px;">${escapeHtml(cleanValue(c.notes))}</textarea>
      </div>
    </div>
    
    <div class="detail-actions" style="margin-top: 6px; display: flex; gap: 6px;">
      <button id="updateCustomerBtn" class="btn" style="flex: 1; padding: 6px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px;">ìˆ˜ì •</button>
      <button id="cancelEditBtn" class="btn" style="flex: 1; padding: 6px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì·¨ì†Œ</button>
    </div>
  `;

  const updateBtn = document.getElementById('updateCustomerBtn');
  const cancelBtn = document.getElementById('cancelEditBtn');
  
  if (updateBtn) updateBtn.addEventListener('click', () => submitCustomerEditForm(c.id));
  if (cancelBtn) cancelBtn.addEventListener('click', () => {
    console.log('ìˆ˜ì • ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ë¨');
    console.log('window.selectedCustomer:', window.selectedCustomer);
    
    // ê³ ê°ìƒì„¸ì •ë³´ë¡œ ëŒì•„ê°€ê¸°
    if (window.selectedCustomer) {
      console.log('ê³ ê°ìƒì„¸ì •ë³´ë¡œ ëŒì•„ê°€ê¸°');
      showSecondaryPanel('viewCustomerDetail');
      renderCustomerDetail(window.selectedCustomer);
    } else {
      console.log('ê³ ê°ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°');
      // ì„ íƒëœ ê³ ê°ì´ ì—†ìœ¼ë©´ ê³ ê°ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
      showSecondaryPanel('viewCustomerList');
      const detailTitleEl = document.getElementById('secondaryPanelTitle');
      if (detailTitleEl) detailTitleEl.textContent = currentUser === 'admin' ? 'ê³ ê° ëª©ë¡' : 'ë‚´ ê³ ê° ëª©ë¡';
    }
  });
}

window.changeCustomerStatusById = async function(customerId) {
  console.log('ğŸ”„ changeCustomerStatus í˜¸ì¶œ:', customerId);
  
  // í˜„ì¬ ê³ ê° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const customer = getCustomerById(customerId);
  if (!customer) {
    console.error('ê³ ê°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', customerId);
    return;
  }
  
  // ìƒíƒœ ë³€ê²½ ì˜µì…˜ (ë‚˜ì¤‘ì— í™•ì¥ ê°€ëŠ¥)
  const statusOptions = [
    { value: 'active', label: 'í™œì„±', color: '#28a745' },
    { value: 'inactive', label: 'ë¹„í™œì„±', color: '#6c757d' },
    { value: 'pending', label: 'ëŒ€ê¸°ì¤‘', color: '#ffc107' },
    { value: 'completed', label: 'ì™„ë£Œ', color: '#17a2b8' }
  ];
  
  // í˜„ì¬ ìƒíƒœ í™•ì¸ (ê¸°ë³¸ê°’: active)
  const currentStatus = customer.status || 'active';
  
  // ìƒíƒœ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸
  const selectedStatus = prompt(
    `ê³ ê° ìƒíƒœë¥¼ ë³€ê²½í•˜ì„¸ìš”:\n\n` +
    `${statusOptions.map(opt => `${opt.value}: ${opt.label}`).join('\n')}\n\n` +
    `í˜„ì¬ ìƒíƒœ: ${currentStatus}\n` +
    `ìƒˆë¡œìš´ ìƒíƒœë¥¼ ì…ë ¥í•˜ì„¸ìš”:`,
    currentStatus
  );
  
  if (!selectedStatus || selectedStatus === currentStatus) {
    return;
  }
  
  // ìœ íš¨í•œ ìƒíƒœì¸ì§€ í™•ì¸
  const validStatus = statusOptions.find(opt => opt.value === selectedStatus);
  if (!validStatus) {
    alert('ìœ íš¨í•˜ì§€ ì•Šì€ ìƒíƒœì…ë‹ˆë‹¤.');
    return;
  }
  
  try {
    const url = `/api/customers/${customerId}`;
    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-User': currentUser
      },
      body: JSON.stringify({
        status: selectedStatus
      })
    });
    
    if (response.ok) {
      alert(`ê³ ê° ìƒíƒœê°€ '${validStatus.label}'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      // ê³ ê° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      loadCustomerList(currentUser === 'admin' ? 'all' : 'own');
    } else {
      const error = await response.text();
      console.error('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
      alert(`ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${error}`);
    }
  } catch (error) {
    console.error('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
    // ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
  }
}

// ê³ ê°ì˜ ì €ì¥ëœ í•„í„°ë°ì´í„°ë¡œ ë§¤ë¬¼ í•„í„°ë§ ì ìš©
function applyCustomerFilter(customer) {
  console.log('applyCustomerFilter í˜¸ì¶œ:', customer);
  
  // í˜„ì¬ ì„ íƒëœ ê³ ê° ì €ì¥
  window.selectedCustomer = customer;
  
  // ë¸Œë¦¬í•‘ ìƒíƒœ ë¡œë“œ
  loadBriefingStates(customer.id);
  
  // ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸ íƒ€ì´í‹€ì„ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
  const listingTitle = document.querySelector(".listing-title");
  if (listingTitle) {
    listingTitle.style.cursor = "pointer";
    listingTitle.style.color = "#007bff";
    listingTitle.style.textDecoration = "underline";
    listingTitle.onclick = () => {
      UI_STATE.isBriefingListMode = false;
      applyAllFilters();
    };
  }
  
  // ê³ ê° ì„ íƒ ì‹œ ë²„íŠ¼ë“¤ í‘œì‹œ
  const modeButtons = document.querySelector('.listing-mode-buttons');
  if (modeButtons) {
    modeButtons.classList.remove('hidden');
    console.log('ë²„íŠ¼ë“¤ í‘œì‹œë¨:', modeButtons.className);
  } else {
    console.log('ë²„íŠ¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
  }
  
  // ê³ ê° ì„ íƒ ì‹œ ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸ ëª¨ë“œë¡œ ê¸°ë³¸ ì„¤ì •
  switchToListingMode('property');
  
  // í˜„ì¬ ê³ ê° ID ì €ì¥
  UI_STATE.currentCustomerId = customer.id;
  
  try {
    // ì§€ì—­ëª… ì •ê·œí™” í•¨ìˆ˜ (ì„œë²„ì˜ normalize_region í•¨ìˆ˜ì™€ ë™ì¼í•œ ë¡œì§)
    function normalizeRegion(region) {
      if (!region) return region;
      
      region = region.trim();
      
      // "êµ¬ ì „ì²´", "êµ¬ ì „ë¶€" íŒ¨í„´ ì²˜ë¦¬
      if (region.includes("êµ¬ ì „ì²´") || region.includes("êµ¬ ì „ë¶€")) {
        return region.split("êµ¬")[0] + "êµ¬";
      }
      
      // "êµ¬ì „ì²´", "êµ¬ì „ë¶€" íŒ¨í„´ ì²˜ë¦¬ (ê³µë°± ì—†ëŠ” ê²½ìš°)
      if (region.includes("êµ¬ì „ì²´") || region.includes("êµ¬ì „ë¶€")) {
        return region.split("êµ¬ì „ì²´")[0] + "êµ¬";
      }
      
      // "ì‹œ ì „ì²´", "ì‹œ ì „ë¶€" íŒ¨í„´ ì²˜ë¦¬
      if (region.includes("ì‹œ ì „ì²´") || region.includes("ì‹œ ì „ë¶€")) {
        return region.split("ì‹œ")[0] + "ì‹œ";
      }
      
      // "ì‹œì „ì²´", "ì‹œì „ë¶€" íŒ¨í„´ ì²˜ë¦¬ (ê³µë°± ì—†ëŠ” ê²½ìš°)
      if (region.includes("ì‹œì „ì²´") || region.includes("ì‹œì „ë¶€")) {
        return region.split("ì‹œì „ì²´")[0] + "ì‹œ";
      }
      
      return region;
    }
    
    // ê³ ê°ì˜ ì €ì¥ëœ í•„í„°ë°ì´í„° íŒŒì‹±
    let filterData = {};
    if (customer.filter_data) {
      filterData = JSON.parse(customer.filter_data);
    } else {
      // ê¸°ì¡´ ë°©ì‹ í˜¸í™˜ì„± (filter_dataê°€ ì—†ëŠ” ê²½ìš°)
      filterData = {
        region: customer.regions || '',
        floor: customer.floor || '',
        area_real: customer.area || '',
        deposit: customer.deposit || '',
        rent: customer.rent || '',
        premium: customer.premium || ''
      };
    }

    // CUSTOMER_FILTERS ì´ˆê¸°í™”
    Object.keys(CUSTOMER_FILTERS).forEach(k => delete CUSTOMER_FILTERS[k]);
    
    // ê³ ê° í•„í„°ì—ë§Œ ì‚¬ìš©í•  í•„ë“œë“¤ (í•„ìš”í•œ í•„ë“œë§Œ)
    const customerFilterKeys = ['region', 'region2', 'floor', 'area_real', 'deposit', 'rent', 'premium'];
    
    // ë¹ˆ ê°’ì´ ì•„ë‹Œ í•„ë“œë§Œ í•„í„°ì— ì¶”ê°€ (ì§€ì—­ëª… ì •ê·œí™” í¬í•¨, notes ì œì™¸)
    Object.keys(filterData).forEach(key => {
      if (customerFilterKeys.includes(key) && filterData[key] && filterData[key].toString().trim() !== '') {
        let value = filterData[key].toString().trim();
        
        // region í•„ë“œì¸ ê²½ìš° ì •ê·œí™” ë° ë‹¤ì¤‘ ì§€ì—­ ì²˜ë¦¬
        if (key === 'region') {
          // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ ì§€ì—­ ì²˜ë¦¬
          const regions = value.split(',').map(r => r.trim()).filter(r => r);
          const regionList = [];
          const region2List = [];
          
          regions.forEach(region => {
            const normalizedRegion = normalizeRegion(region);
            
            // ì‹œêµ°êµ¬ ë‹¨ìœ„ì¸ì§€ í™•ì¸ (êµ¬, ì‹œë¡œ ëë‚˜ëŠ” ê²½ìš°)
            if (normalizedRegion.includes('êµ¬') || normalizedRegion.includes('ì‹œ')) {
              region2List.push(normalizedRegion);
            } else {
              regionList.push(normalizedRegion);
            }
          });
          
          // ê²°ê³¼ ì„¤ì •
          if (regionList.length > 0) {
            CUSTOMER_FILTERS['region'] = regionList.join(',');
            console.log('ìë©´ë™ë¦¬ ë‹¨ìœ„ ì§€ì—­ì„ regionì— ì„¤ì •:', regionList.join(','));
          }
          if (region2List.length > 0) {
            CUSTOMER_FILTERS['region2'] = region2List.join(',');
            console.log('ì‹œêµ°êµ¬ ë‹¨ìœ„ ì§€ì—­ì„ region2ì— ì„¤ì •:', region2List.join(','));
          }
        } else {
          // floor í•„ë“œ íŠ¹ë³„ ì²˜ë¦¬ (ì§€ì—­ëª…ì´ ì˜ëª» ë“¤ì–´ê°„ ê²½ìš° ì²˜ë¦¬)
          if (key === 'floor') {
            // ì§€ì—­ëª… íŒ¨í„´ì¸ì§€ í™•ì¸ (êµ¬, ì‹œë¡œ ëë‚˜ëŠ” ê²½ìš°)
            if (value.includes('êµ¬') || value.includes('ì‹œ')) {
              // ì§€ì—­ëª…ì´ ì˜ëª» ë“¤ì–´ê°„ ê²½ìš° region2ë¡œ ì´ë™
              const normalizedRegion = normalizeRegion(value);
              CUSTOMER_FILTERS['region2'] = normalizedRegion;
              console.log('floor í•„ë“œì— ì§€ì—­ëª…ì´ ë“¤ì–´ìˆì–´ region2ë¡œ ì´ë™:', value);
            } else {
              // ìˆ«ìë‚˜ ì¸µìˆ˜ ì •ë³´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©
              CUSTOMER_FILTERS[key] = value;
            }
          }
          // ë©´ì  í•„ë“œ íŠ¹ë³„ ì²˜ë¦¬ (ë‹¨ì¼ê°’ì€ ì´ìƒ ê²€ìƒ‰, ë²”ìœ„ëŠ” ê·¸ëŒ€ë¡œ)
          else if (key === 'area_real') {
            if (value.includes('-')) {
              // ë²”ìœ„ê°€ ì§€ì •ëœ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©
              CUSTOMER_FILTERS[key] = value;
            } else {
              // ë‹¨ì¼ê°’ì¸ ê²½ìš° ì´ìƒ ê²€ìƒ‰ìœ¼ë¡œ ì²˜ë¦¬
              const numValue = parseFloat(value);
              if (!isNaN(numValue) && numValue > 0) {
                CUSTOMER_FILTERS[key] = `${numValue}-`;
              } else {
                CUSTOMER_FILTERS[key] = value;
              }
            }
          }
          // ë³´ì¦ê¸ˆ, ì›”ì„¸, ê¶Œë¦¬ê¸ˆì€ ë²”ìœ„ë¡œ ì²˜ë¦¬ (0 ~ ì…ë ¥ê°’)
          else if (key === 'deposit' || key === 'rent' || key === 'premium') {
            const numValue = parseFloat(value);
            if (!isNaN(numValue) && numValue > 0) {
              CUSTOMER_FILTERS[key] = `0-${numValue}`;
            } else {
              CUSTOMER_FILTERS[key] = value;
            }
          } else {
            CUSTOMER_FILTERS[key] = value;
          }
        }
      }
    });

    // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
    console.log('ê³ ê° í•„í„° ì ìš©:', {
      customerName: customer.name,
      originalFilterData: filterData,
      normalizedFilters: CUSTOMER_FILTERS
    });
    
    // í•„í„° ì ìš©
    applyAllFilters();
    
    // 2ì°¨ ì‚¬ì´ë“œë°” ë‹«ê¸°
    const secondaryPanel = document.getElementById('secondaryPanel');
    if (secondaryPanel) {
      secondaryPanel.classList.add('hidden');
      secondaryPanel.classList.remove('visible');
    }
    
    // ${customer.name} ê³ ê°ì˜ í•„í„°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
    
  } catch (error) {
    console.error('ê³ ê° í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜:', error);
    alert('í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê³ ê° í•„í„° ë³€ê²½ í•¸ë“¤ëŸ¬
function handleCustomerFilterChange() {
  const select = document.getElementById('customerFilterSelect');
  if (select) {
    const filter = select.value;
    loadCustomerList(filter);
  }
}

// ê³ ê° í•„í„° í•´ì œ
function clearCustomerFilter() {
  // CUSTOMER_FILTERS ì´ˆê¸°í™”
  Object.keys(CUSTOMER_FILTERS).forEach(k => delete CUSTOMER_FILTERS[k]);
  
  // í•„í„° ì ìš©
  applyAllFilters();
  
      // ê³ ê° í•„í„°ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.
}

// ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
window.handleCustomerFilterChange = handleCustomerFilterChange;

function applyCustomerFormAsFilter() {
  // ê³ ê° í¼ì˜ ì…ë ¥ê°’ì„ í•„í„°ë¡œ ì ìš©
  const formData = {
    region: document.getElementById('frmRegions')?.value || '',
    floor: document.getElementById('frmFloor')?.value || '',
    area_real: document.getElementById('frmArea')?.value || '',
    deposit: document.getElementById('frmDeposit')?.value || '',
    rent: document.getElementById('frmRent')?.value || '',
    premium: document.getElementById('frmPremium')?.value || ''
  };

  // CUSTOMER_FILTERS ì´ˆê¸°í™”
  Object.keys(CUSTOMER_FILTERS).forEach(k => delete CUSTOMER_FILTERS[k]);
  
  // ë¹ˆ ê°’ì´ ì•„ë‹Œ í•„ë“œë§Œ í•„í„°ì— ì¶”ê°€ (notes ì œì™¸)
  Object.keys(formData).forEach(key => {
    if (key !== 'notes' && formData[key] && formData[key].trim() !== '') {
      CUSTOMER_FILTERS[key] = formData[key].trim();
    }
  });

  // í•„í„° ì ìš©
  applyAllFilters();
  
  // 2ì°¨ ì‚¬ì´ë“œë°” ë‹«ê¸°
  const secondaryPanel = document.getElementById('secondaryPanel');
  if (secondaryPanel) {
    secondaryPanel.classList.add('hidden');
    secondaryPanel.classList.remove('visible');
  }
  
      // ê³ ê° ì •ë³´ê°€ í•„í„°ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
}
async function submitCustomerForm(customerId) {
  console.log('ê³ ê° í¼ ì œì¶œ:', customerId);

  if (!currentUser) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  // ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸
  const isEditMode = customerId && customerId !== 'new';

  // í¼ ë°ì´í„° ìˆ˜ì§‘
  const areaVal = document.getElementById('frmArea')?.value || '';
  const depositVal = document.getElementById('frmDeposit')?.value || '';
  const rentVal = document.getElementById('frmRent')?.value || '';
  const premiumVal = document.getElementById('frmPremium')?.value || '';

  // ìƒë‹¨í•„í„° ë°©ì‹ìœ¼ë¡œ í•„í„°ë°ì´í„° êµ¬ì„± (ì§€ì—­ëª… ì •ê·œí™” í¬í•¨)
  const regionsInput = document.getElementById('frmRegions')?.value || '';
  
  // ì§€ì—­ëª… ì •ê·œí™” í•¨ìˆ˜ (ì„œë²„ì˜ normalize_region í•¨ìˆ˜ì™€ ë™ì¼í•œ ë¡œì§)
  function normalizeRegion(region) {
    if (!region) return region;
    
    region = region.trim();
    
    // "êµ¬ ì „ì²´", "êµ¬ ì „ë¶€" íŒ¨í„´ ì²˜ë¦¬
    if (region.includes("êµ¬ ì „ì²´") || region.includes("êµ¬ ì „ë¶€")) {
      return region.split("êµ¬")[0] + "êµ¬";
    }
    
    // "êµ¬ì „ì²´", "êµ¬ì „ë¶€" íŒ¨í„´ ì²˜ë¦¬ (ê³µë°± ì—†ëŠ” ê²½ìš°)
    if (region.includes("êµ¬ì „ì²´") || region.includes("êµ¬ì „ë¶€")) {
      return region.split("êµ¬ì „ì²´")[0] + "êµ¬";
    }
    
    // "ì‹œ ì „ì²´", "ì‹œ ì „ë¶€" íŒ¨í„´ ì²˜ë¦¬
    if (region.includes("ì‹œ ì „ì²´") || region.includes("ì‹œ ì „ë¶€")) {
      return region.split("ì‹œ")[0] + "ì‹œ";
    }
    
    // "ì‹œì „ì²´", "ì‹œì „ë¶€" íŒ¨í„´ ì²˜ë¦¬ (ê³µë°± ì—†ëŠ” ê²½ìš°)
    if (region.includes("ì‹œì „ì²´") || region.includes("ì‹œì „ë¶€")) {
      return region.split("ì‹œì „ì²´")[0] + "ì‹œ";
    }
    
    return region;
  }
  
  const normalizedRegion = normalizeRegion(regionsInput);
  
  // í•„í„° ë°ì´í„° êµ¬ì„± (notes ì œì™¸)
  const filterData = {
    region: normalizedRegion,  // ì •ê·œí™”ëœ ì§€ì—­ëª… ì‚¬ìš©
    floor: document.getElementById('frmFloor')?.value || '',
    area_real: areaVal,
    deposit: depositVal,
    rent: rentVal,
    premium: premiumVal
  };

  const formData = {
    manager: document.getElementById('frmManager')?.value || '',
    name: document.getElementById('frmName')?.value || '',
    phone: document.getElementById('frmPhone')?.value || '',
    regions: document.getElementById('frmRegions')?.value || '',
    floor: document.getElementById('frmFloor')?.value || '',
    area: areaVal,
    deposit: depositVal,
    rent: rentVal,
    premium: premiumVal,
    notes: document.getElementById('frmNotes')?.value || '',
    // ìƒë‹¨í•„í„° ë°©ì‹ì˜ í•„í„°ë°ì´í„° ì €ì¥
    filter_data: JSON.stringify(filterData),
    created_by: currentUser,
    created_at: new Date().toISOString()
  };

  // í•„ìˆ˜ í•„ë“œ ê²€ì¦
  if (!formData.name.trim()) {
    alert('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  if (!formData.phone.trim()) {
    alert('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  try {
    const url = isEditMode ? `/api/customers/${customerId}` : '/api/customers/';
    const method = isEditMode ? 'PUT' : 'POST';
    
    // formDataì—ì„œ NaN ê°’ ì œê±°
    const cleanedFormData = cleanObject(formData);
    console.log('ğŸ§¹ ì •ë¦¬ëœ formData (submitCustomerForm):', cleanedFormData);
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-User': currentUser
      },
      body: JSON.stringify(cleanedFormData)
    });
    if (response.ok) {
      const result = await response.json();
      console.log('ê³ ê° ì €ì¥ ì„±ê³µ:', result);
      alert(isEditMode ? 'ê³ ê°ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê³ ê°ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      const secondaryPanel = document.getElementById('secondaryPanel');
      if (secondaryPanel) {
        secondaryPanel.classList.add('hidden');
        secondaryPanel.classList.remove('visible');
      }
      if (currentUser === 'admin') {
        loadCustomerList('all');
      } else {
        loadCustomerList('own');
      }
      
      // ê³ ê° ì €ì¥ í›„ ëª©ë¡ ê°±ì‹ 
      if (window.afterCustomerSaved) {
        window.afterCustomerSaved();
      }
    } else {
      const error = await response.text();
      console.error('ê³ ê° ì €ì¥ ì‹¤íŒ¨:', error);
      alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error);
    }
  } catch (error) {
    console.error('ê³ ê° ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ê³ ê° ìˆ˜ì • ì „ìš© í¼ ì œì¶œ í•¨ìˆ˜
async function submitCustomerEditForm(customerId) {
  console.log('ê³ ê° ìˆ˜ì • í¼ ì œì¶œ:', customerId);

  if (!currentUser) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  // í¼ ë°ì´í„° ìˆ˜ì§‘ (NaN ê°’ ì²˜ë¦¬)
  const areaVal = cleanValue(document.getElementById('editArea')?.value) || '';
  const depositVal = cleanValue(document.getElementById('editDeposit')?.value) || '';
  const rentVal = cleanValue(document.getElementById('editRent')?.value) || '';
  const premiumVal = cleanValue(document.getElementById('editPremium')?.value) || '';

  // ìƒë‹¨í•„í„° ë°©ì‹ìœ¼ë¡œ í•„í„°ë°ì´í„° êµ¬ì„± (ì§€ì—­ëª… ì •ê·œí™” í¬í•¨)
  const regionsInput = cleanValue(document.getElementById('editRegions')?.value) || '';
  
  // ì§€ì—­ëª… ì •ê·œí™” í•¨ìˆ˜ (ì„œë²„ì˜ normalize_region í•¨ìˆ˜ì™€ ë™ì¼í•œ ë¡œì§)
  function normalizeRegion(region) {
    if (!region) return region;
    
    region = region.trim();
    
    // "êµ¬ ì „ì²´", "êµ¬ ì „ë¶€" íŒ¨í„´ ì²˜ë¦¬
    if (region.includes("êµ¬ ì „ì²´") || region.includes("êµ¬ ì „ë¶€")) {
      return region.split("êµ¬")[0] + "êµ¬";
    }
    
    // "êµ¬ì „ì²´", "êµ¬ì „ë¶€" íŒ¨í„´ ì²˜ë¦¬ (ê³µë°± ì—†ëŠ” ê²½ìš°)
    if (region.includes("êµ¬ì „ì²´") || region.includes("êµ¬ì „ë¶€")) {
      return region.split("êµ¬ì „ì²´")[0] + "êµ¬";
    }
    
    // "ì‹œ ì „ì²´", "ì‹œ ì „ë¶€" íŒ¨í„´ ì²˜ë¦¬
    if (region.includes("ì‹œ ì „ì²´") || region.includes("ì‹œ ì „ë¶€")) {
      return region.split("ì‹œ")[0] + "ì‹œ";
    }
    
    // "ì‹œì „ì²´", "ì‹œì „ë¶€" íŒ¨í„´ ì²˜ë¦¬ (ê³µë°± ì—†ëŠ” ê²½ìš°)
    if (region.includes("ì‹œì „ì²´") || region.includes("ì‹œì „ë¶€")) {
      return region.split("ì‹œì „ì²´")[0] + "ì‹œ";
    }
    
    return region;
  }
  
  const normalizedRegion = normalizeRegion(regionsInput);
  
  // í•„í„° ë°ì´í„° êµ¬ì„± (notes ì œì™¸)
  const filterData = {
    region: normalizedRegion,  // ì •ê·œí™”ëœ ì§€ì—­ëª… ì‚¬ìš©
    floor: cleanValue(document.getElementById('editFloor')?.value) || '',
    area_real: areaVal,
    deposit: depositVal,
    rent: rentVal,
    premium: premiumVal
  };

  const formData = {
    manager: cleanValue(document.getElementById('editManager')?.value) || '',
    name: cleanValue(document.getElementById('editName')?.value) || '',
    phone: cleanValue(document.getElementById('editPhone')?.value) || '',
    regions: cleanValue(document.getElementById('editRegions')?.value) || '',
    floor: cleanValue(document.getElementById('editFloor')?.value) || '',
    area: areaVal,
    deposit: depositVal,
    rent: rentVal,
    premium: premiumVal,
    notes: cleanValue(document.getElementById('editNotes')?.value) || '',
    // ìƒë‹¨í•„í„° ë°©ì‹ì˜ í•„í„°ë°ì´í„° ì €ì¥
    filter_data: JSON.stringify(filterData)
  };

  // í•„ìˆ˜ í•„ë“œ ê²€ì¦
  if (!formData.name.trim()) {
    alert('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  if (!formData.phone.trim()) {
    alert('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  try {
    const url = `/api/customers/${customerId}`;
    
    // formDataì—ì„œ NaN ê°’ ì œê±°
    const cleanedFormData = cleanObject(formData);
    console.log('ğŸ§¹ ì •ë¦¬ëœ formData:', cleanedFormData);
    
    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-User': currentUser
      },
      body: JSON.stringify(cleanedFormData)
    });
    
    if (response.ok) {
      try {
        const result = await response.json();
        console.log('ê³ ê° ìˆ˜ì • ì„±ê³µ:', result);
        // ê³ ê°ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
      } catch (jsonError) {
        console.log('JSON íŒŒì‹± ì‹¤íŒ¨, í•˜ì§€ë§Œ ìˆ˜ì •ì€ ì„±ê³µ:', jsonError);
        // ê³ ê°ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
      }
      
      // íŒ¨ë„ ë‹«ê¸°
      const secondaryPanel = document.getElementById('secondaryPanel');
      if (secondaryPanel) {
        secondaryPanel.classList.add('hidden');
        secondaryPanel.classList.remove('visible');
      }
      
      // ê³ ê° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      if (currentUser === 'admin') {
        loadCustomerList('all');
      } else {
        loadCustomerList('own');
      }
      
      // ê³ ê° ì €ì¥ í›„ ëª©ë¡ ê°±ì‹ 
      if (window.afterCustomerSaved) {
        window.afterCustomerSaved();
      }
    } else {
      const error = await response.text();
      console.error('ê³ ê° ìˆ˜ì • ì‹¤íŒ¨:', error);
      // ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error
    }
  } catch (error) {
    console.error('ê³ ê° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:', error);
    console.error('ì˜¤ë¥˜ íƒ€ì…:', typeof error);
    console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
    console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    
    // ë” êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê³µ
    let errorMessage = 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    if (error.message) {
      errorMessage += ` (${error.message})`;
    }
    // errorMessage
  }
}

// ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
window.initMap = initMap;
// window.editCustomer = editCustomer; // ì´ë¯¸ window.editCustomerByIdë¡œ ì •ì˜ë¨
// window.deleteCustomer = deleteCustomer; // ì´ë¯¸ window.deleteCustomerByIdë¡œ ì •ì˜ë¨

// ê³ ê° ìƒíƒœ ë³€ê²½ í•¨ìˆ˜
window.changeCustomerStatus = async function(customerId, newStatus) {
  console.log('ğŸ”„ ê³ ê° ìƒíƒœ ë³€ê²½:', customerId, '->', newStatus);
  
  try {
    const url = `/api/customers/${customerId}`;
    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-User': currentUser
      },
      body: JSON.stringify({ status: newStatus })
    });
    
    if (response.ok) {
      console.log('âœ… ê³ ê° ìƒíƒœ ë³€ê²½ ì„±ê³µ');
      // ê³ ê° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      loadCustomerList(currentUser === 'admin' ? 'all' : 'own');
    } else {
      const error = await response.text();
      console.error('âŒ ê³ ê° ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
      // ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error
    }
  } catch (error) {
    console.error('âŒ ê³ ê° ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
    alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
};

// ê³ ê° ìƒíƒœ ë“œë¡­ë‹¤ìš´ í‘œì‹œ í•¨ìˆ˜
window.showStatusDropdown = function(event, customerId, currentStatus) {
  event.stopPropagation();
  
  // ê¸°ì¡´ ë“œë¡­ë‹¤ìš´ ì œê±°
  const existingDropdown = document.querySelector('.status-dropdown');
  if (existingDropdown) {
    existingDropdown.remove();
  }
  
  const statusOptions = [
    { value: 'ìƒ', label: 'ìƒì„±', color: '#28a745', bgColor: '#d4edda' },
    { value: 'ì™„', label: 'ì™„ë£Œ', color: '#0c5460', bgColor: '#d1ecf1' },
    { value: 'ë³´ë¥˜', label: 'ë³´ë¥˜', color: '#856404', bgColor: '#fff3cd' },
    { value: 'í¬ê¸°', label: 'í¬ê¸°', color: '#721c24', bgColor: '#f8d7da' }
  ];
  
  const dropdown = document.createElement('div');
  dropdown.className = 'status-dropdown';
  dropdown.style.cssText = `
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 1000;
    min-width: 80px;
  `;
  
  statusOptions.forEach(option => {
    const item = document.createElement('div');
    item.style.cssText = `
      padding: 6px 10px;
      cursor: pointer;
      font-size: 11px;
      border-bottom: 1px solid #f0f0f0;
      background: ${option.value === currentStatus ? '#f8f9fa' : 'white'};
    `;
    item.textContent = option.label;
    
    item.addEventListener('click', (e) => {
      e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
      window.changeCustomerStatus(customerId, option.value);
      dropdown.remove();
    });
    
    item.addEventListener('mouseenter', () => {
      item.style.backgroundColor = '#f8f9fa';
    });
    
    item.addEventListener('mouseleave', () => {
      item.style.backgroundColor = option.value === currentStatus ? '#f8f9fa' : 'white';
    });
    
    dropdown.appendChild(item);
  });
  
  // ë“œë¡­ë‹¤ìš´ì„ í´ë¦­í•œ ìš”ì†Œì— ì¶”ê°€
  event.target.parentNode.style.position = 'relative';
  event.target.parentNode.appendChild(dropdown);
  
  // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
  setTimeout(() => {
    document.addEventListener('click', function closeDropdown() {
      dropdown.remove();
      document.removeEventListener('click', closeDropdown);
    });
  }, 100);
};

// ê³ ê° ìƒíƒœ í•„í„° ë³€ê²½ í•¸ë“¤ëŸ¬
window.handleStatusFilterChange = function() {
  const statusFilter = document.getElementById('customerStatusFilter');
  if (statusFilter) {
    const selectedStatus = statusFilter.value;
    console.log('ğŸ”„ ìƒíƒœ í•„í„° ë³€ê²½:', selectedStatus);
    
    // í˜„ì¬ ê³ ê° ëª©ë¡ì—ì„œ í•„í„°ë§
    if (window.currentCustomerList) {
      let filteredList = window.currentCustomerList;
      
      if (selectedStatus !== 'all') {
        filteredList = window.currentCustomerList.filter(customer => 
          (customer.status || 'ìƒ') === selectedStatus
        );
      }
      
      // í•„í„°ë§ëœ ëª©ë¡ë§Œ ë Œë”ë§ (í•„í„°ëŠ” ìœ ì§€)
      renderFilteredCustomerList(filteredList);
    }
  }
};

// ê³ ê° í•„í„° ë³€ê²½ í•¸ë“¤ëŸ¬
window.handleCustomerFilterChange = function() {
  const filterSelect = document.getElementById('customerFilterSelect');
  if (filterSelect) {
    const selectedFilter = filterSelect.value;
    loadCustomerList(selectedFilter);
  }
}; 
/**************************************
 * ===== DOMContentLoaded ì´ˆê¸°í™” =====
 **************************************/
window.addEventListener("DOMContentLoaded", async () => {
  // ëª¨ë“ˆí™”ëœ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
  if (window.initializeApp) {
    await window.initializeApp();
  } else {
    console.error('initializeApp í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
});

// í´ëŸ¬ìŠ¤í„° í´ë¦­ ìœ„ì„ ë°”ì¸ë”©ì€ ë©”ì¸ DOMContentLoadedì—ì„œ ì²˜ë¦¬ë¨ 

// í´ëŸ¬ìŠ¤í„° í´ë¦­ ìœ„ì„ ë°”ì¸ë”©ì€ ë©”ì¸ DOMContentLoadedì—ì„œ ì²˜ë¦¬ë¨

// í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
function showToast(message, type = 'info') {
  // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
  const existingToast = document.querySelector('.toast-notification');
  if (existingToast) {
    existingToast.remove();
  }
  
  // í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„±
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
    color: white;
    padding: 12px 20px;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 10000;
    font-size: 14px;
    max-width: 300px;
    word-wrap: break-word;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
  `;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ê¸°
  setTimeout(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(0)';
  }, 100);
  
  // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ê¸°
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 300);
  }, 3000);
}

/**************************************
 * ===== ì§€ë„ ì»¨íŠ¸ë¡¤ ê¸°ëŠ¥ =====
 **************************************/

// MarkerClustering.js ë™ì  ë¡œë“œ
function loadMarkerClustering() {
  if (typeof MarkerClustering !== 'undefined') {
    console.log('âœ… MarkerClusteringì´ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  const script = document.createElement('script');
  script.src = '/static/js/vendor/MarkerClustering.js';
  script.onload = function() {
    console.log('âœ… MarkerClusteringì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
  };
  script.onerror = function() {
    console.error('âŒ MarkerClustering ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  };
  document.head.appendChild(script);
}

// Streetview ëª¨ë“ˆì€ ì´ì œ HTMLì—ì„œ ì§ì ‘ ë¡œë“œë©ë‹ˆë‹¤

// ì§€ë„ ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™”
function initMapControls() {
  // ë¡œë“œë·° ë²„íŠ¼
  const roadviewBtn = document.getElementById('roadviewBtn');
  if (roadviewBtn) {
    roadviewBtn.addEventListener('click', toggleRoadview);
  }
  
  // ì§€ì í¸ì§‘ë„ ë²„íŠ¼
  const cadastralBtn = document.getElementById('cadastralBtn');
  if (cadastralBtn) {
    cadastralBtn.addEventListener('click', toggleCadastralMap);
  }
  
  // ê±°ë¦¬ì œê¸° ë²„íŠ¼
  const distanceBtn = document.getElementById('distanceBtn');
  if (distanceBtn) {
    distanceBtn.addEventListener('click', toggleDistanceMeasure);
  }
  
  // ë¡œë“œë·° ë‹«ê¸° ë²„íŠ¼
  const roadviewCloseBtn = document.getElementById('roadviewCloseBtn');
  if (roadviewCloseBtn) {
    roadviewCloseBtn.addEventListener('click', function() {
      console.log('ğŸ”„ ë¡œë“œë·° ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨');
      closePanorama();
    });
  } else {
    console.error('âŒ roadviewCloseBtnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  // ê±°ë¦¬ì œê¸° í•¸ë“¤ëŸ¬ëŠ” ì´ë¯¸ initMapì—ì„œ ì¶”ê°€ë¨
  
  // ESC í‚¤ë¡œ ê±°ë¦¬ì œê¸° ëª¨ë“œ í•´ì œ
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && IS_DISTANCE_MODE) {
      toggleDistanceMeasure();
    }
  });
  

}

// ë¡œë“œë·° í† ê¸€
function toggleRoadview() {
  console.log('ğŸ›£ï¸ ë¡œë“œë·° í† ê¸€ ë²„íŠ¼ í´ë¦­ë¨');
  const container = document.getElementById('roadviewContainer');
  if (!container) {
    console.error('âŒ roadviewContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (container.classList.contains('hidden')) {
    console.log('ğŸ”„ ë¡œë“œë·° ì—´ê¸° ì‹œë„...');
    openRoadview();
  } else {
    console.log('ğŸ”„ ë¡œë“œë·° ë‹«ê¸° ì‹œë„...');
    closeRoadview();
  }
}

// ê±°ë¦¬ë·° ë ˆì´ì–´ í† ê¸€
function openRoadview() {
  console.log('ğŸ”„ ê±°ë¦¬ë·° ë ˆì´ì–´ í† ê¸€ ì‹œì‘');
  
  // ê±°ë¦¬ë·° ë ˆì´ì–´ê°€ ì´ë¯¸ í‘œì‹œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
  if (MAP._streetLayer) {
    // ë ˆì´ì–´ ì œê±°
    console.log('ğŸ”„ ê±°ë¦¬ë·° ë ˆì´ì–´ ì œê±° ì¤‘...');
    MAP._streetLayer.setMap(null);
    MAP._streetLayer = null;
    showToast('ê±°ë¦¬ë·° ë ˆì´ì–´ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    console.log('âœ… ê±°ë¦¬ë·° ë ˆì´ì–´ ì œê±° ì™„ë£Œ');
    return;
  }
  
  // ê±°ë¦¬ë·° ë ˆì´ì–´ ìƒì„± ë° í‘œì‹œ
  try {
    console.log('ğŸ”„ ê±°ë¦¬ë·° ë ˆì´ì–´ ìƒì„± ì¤‘...');
    MAP._streetLayer = new naver.maps.StreetLayer();
    MAP._streetLayer.setMap(MAP);
    
    // ê±°ë¦¬ë·° ë ˆì´ì–´ í´ë¦­ ì´ë²¤íŠ¸ - ê°€ì¥ ê°€ê¹Œìš´ ê±°ë¦¬ë·° ì§€ì ìœ¼ë¡œ ìë™ ì´ë™
    naver.maps.Event.addListener(MAP._streetLayer, 'click', function(e) {
      console.log('ğŸ“ ê±°ë¦¬ë·° ë ˆì´ì–´ í´ë¦­:', e.coord);
      console.log('ğŸ“ í´ë¦­ ì´ë²¤íŠ¸ ì „ì²´:', e);
      
      // í´ë¦­í•œ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ê±°ë¦¬ë·° ì§€ì ìœ¼ë¡œ ìë™ ì´ë™
      if (e.coord) {
        console.log('ğŸ”„ openPanorama í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘');
        openPanorama(e.coord);
      } else {
        console.error('âŒ í´ë¦­í•œ ìœ„ì¹˜ì˜ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
    });
    
    // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ì—ì„œë„ ê±°ë¦¬ë·° ë ˆì´ì–´ í´ë¦­ ì²˜ë¦¬
    naver.maps.Event.addListener(MAP, 'click', function(e) {
      if (MAP._streetLayer) {
        console.log('ğŸ“ ì§€ë„ í´ë¦­ (ê±°ë¦¬ë·° ë ˆì´ì–´ í™œì„±í™”ë¨):', e.coord);
        console.log('ğŸ”„ ê±°ë¦¬ë·° ë ˆì´ì–´ í´ë¦­ ì´ë²¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜');
        
        // ê±°ë¦¬ë·° ë ˆì´ì–´ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ í˜¸ì¶œ
        if (e.coord) {
          console.log('ğŸ”„ openPanorama í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘');
          openPanorama(e.coord);
        }
      }
    });
    
    // ê±°ë¦¬ë·° ë ˆì´ì–´ ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸
    naver.maps.Event.addListener(MAP._streetLayer, 'load', function() {
      console.log('âœ… ê±°ë¦¬ë·° ë ˆì´ì–´ ë¡œë“œ ì™„ë£Œ');
    });
    
    // ê±°ë¦¬ë·° ë ˆì´ì–´ ì—ëŸ¬ ì´ë²¤íŠ¸
    naver.maps.Event.addListener(MAP._streetLayer, 'error', function(error) {
      console.error('âŒ ê±°ë¦¬ë·° ë ˆì´ì–´ ì—ëŸ¬:', error);
    });
    
    showToast('ê±°ë¦¬ë·° ë ˆì´ì–´ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ë„ì—ì„œ ê±°ë¦¬ë·° ì•„ì´ì½˜ì„ í´ë¦­í•˜ì„¸ìš”.', 'info');
    console.log('âœ… ê±°ë¦¬ë·° ë ˆì´ì–´ ìƒì„± ì™„ë£Œ');
    
  } catch (error) {
    console.error('âŒ ê±°ë¦¬ë·° ë ˆì´ì–´ ìƒì„± ì‹¤íŒ¨:', error);
    showToast('ê±°ë¦¬ë·° ë ˆì´ì–´ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
  }
}
  
// ê±°ë¦¬ë·° ë ˆì´ì–´ì—ì„œ í´ë¦­ ì‹œ íŒŒë…¸ë¼ë§ˆ ì—´ê¸°
function openPanorama(position) {
  console.log('ğŸ”„ openPanorama í•¨ìˆ˜ ì‹œì‘');
  console.log('ğŸ“ ì „ë‹¬ë°›ì€ ìœ„ì¹˜:', position);
  console.log('ğŸ” Panorama API í™•ì¸:', typeof naver.maps.Panorama);
  
  if (typeof naver.maps.Panorama === 'undefined') {
    console.error('âŒ Panorama APIê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ');
    showToast('ê±°ë¦¬ë·° ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  const container = document.getElementById('roadviewContainer');
  const roadviewDiv = document.getElementById('roadview');
  const minimapContent = document.querySelector('.minimap-content');
  
  if (!container || !roadviewDiv || !minimapContent) {
    console.error('âŒ í•„ìš”í•œ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  try {
    console.log('ğŸ”„ íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™” ì‹œì‘...');
    
    // ì»¨í…Œì´ë„ˆ í¬ê¸° í™•ì¸
    const containerWidth = roadviewDiv.offsetWidth || window.innerWidth;
    const containerHeight = roadviewDiv.offsetHeight || window.innerHeight;
    console.log('ğŸ“ ì»¨í…Œì´ë„ˆ í¬ê¸°:', containerWidth, 'x', containerHeight);
    
    // íŒŒë…¸ë¼ë§ˆë¥¼ roadview divì— ìƒì„±
    ROADVIEW = new naver.maps.Panorama(roadviewDiv, {
      position: position,
      pov: {
        pan: 0,
        tilt: 0,
        fov: 90
      },
      zoom: 1,
      enableWheel: true,
      enableKeyboard: true,
      enableDoubleClick: true,
      size: new naver.maps.Size(containerWidth, containerHeight)
    });
    
    console.log('âœ… Panorama ê°ì²´ ìƒì„± ì™„ë£Œ:', ROADVIEW);
    
    // ë¯¸ë‹ˆë§µ ìƒì„±
    ROADVIEW_MINIMAP = new naver.maps.Map(minimapContent, {
      center: position,
      zoom: 15,
      mapTypeControl: false,
      scaleControl: false,
      logoControl: false,
      mapDataControl: false,
      zoomControl: false,
      streetViewControl: false
    });
    
    // ë¯¸ë‹ˆë§µì´ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
    console.log('ğŸ” ë¯¸ë‹ˆë§µ ìƒì„± ì™„ë£Œ:', ROADVIEW_MINIMAP);
    console.log('ğŸ” minimapContent í¬ê¸°:', minimapContent.offsetWidth, 'x', minimapContent.offsetHeight);
    
    // ë¯¸ë‹ˆë§µì´ ë¡œë“œë˜ì§€ ì•Šì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ì„œ ì¦‰ì‹œ ëŒ€ì²´ ë©”ì‹œì§€ í‘œì‹œ
    if (minimapContent.children.length === 0) {
      console.log('ğŸ”„ ë¯¸ë‹ˆë§µ ë¡œë“œ ëŒ€ê¸° ì¤‘ - ì„ì‹œ ë©”ì‹œì§€ í‘œì‹œ');
      minimapContent.innerHTML = `
        <div style="
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100%;
          color: #333;
          text-align: center;
          padding: 10px;
          font-size: 12px;
          background: #f8f9fa;
          border: 2px solid #007AFF;
          border-radius: 6px;
        ">
          <div>
            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ—ºï¸</div>
            <div style="font-weight: bold; margin-bottom: 4px;">ë¯¸ë‹ˆë§µ ë¡œë”© ì¤‘...</div>
            <div style="font-size: 10px; color: #666;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
          </div>
        </div>
      `;
    }
    
    // ë¯¸ë‹ˆë§µ ë¡œë“œ í™•ì¸ (ë” ë¹ ë¥¸ í™•ì¸)
    setTimeout(() => {
      console.log('ğŸ” ë¯¸ë‹ˆë§µ ë¡œë“œ ìƒíƒœ í™•ì¸ ì¤‘...');
      console.log('ğŸ” minimapContent ìì‹ ìš”ì†Œ ìˆ˜:', minimapContent.children.length);
      console.log('ğŸ” minimapContent í¬ê¸°:', minimapContent.offsetWidth, 'x', minimapContent.offsetHeight);
      
      if (minimapContent.children.length === 0) {
        console.warn('âš ï¸ ë¯¸ë‹ˆë§µì´ ë¡œë“œë˜ì§€ ì•ŠìŒ - ëŒ€ì²´ ë©”ì‹œì§€ í‘œì‹œ');
        minimapContent.innerHTML = `
          <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #333;
            text-align: center;
            padding: 10px;
            font-size: 12px;
            background: #f8f9fa;
            border: 2px solid #007AFF;
            border-radius: 6px;
          ">
            <div>
              <div style="font-size: 24px; margin-bottom: 8px;">ğŸ—ºï¸</div>
              <div style="font-weight: bold; margin-bottom: 4px;">ë¯¸ë‹ˆë§µ</div>
              <div style="font-size: 10px; color: #666;">í´ë¦­í•˜ì—¬ ì´ë™</div>
            </div>
          </div>
        `;
        
        // ëŒ€ì²´ ë¯¸ë‹ˆë§µ í´ë¦­ ì´ë²¤íŠ¸
        minimapContent.addEventListener('click', function() {
          console.log('ğŸ”„ ëŒ€ì²´ ë¯¸ë‹ˆë§µ í´ë¦­ë¨');
          showToast('ë¯¸ë‹ˆë§µì„ í´ë¦­í•˜ì—¬ ë‹¤ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
        });
      } else {
        console.log('âœ… ë¯¸ë‹ˆë§µì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë¨');
        console.log('ğŸ” ë¯¸ë‹ˆë§µ ë‚´ìš©:', minimapContent.innerHTML.substring(0, 100) + '...');
      }
    }, 500);
    
    // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ (íšŒì „í•˜ëŠ” ë…¹ìƒ‰ ì )
    const positionMarker = new naver.maps.Marker({
      position: position,
      map: ROADVIEW_MINIMAP,
      icon: {
        content: `
          <div style="
            width: 16px; 
            height: 16px; 
            background: #34C759; 
            border: 2px solid white; 
            border-radius: 50%; 
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transform: rotate(0deg);
          ">
            <div style="
              position: absolute;
              top: 2px;
              left: 50%;
              transform: translateX(-50%);
              width: 0;
              height: 0;
              border-left: 3px solid transparent;
              border-right: 3px solid transparent;
              border-bottom: 6px solid white;
            "></div>
          </div>
        `,
        anchor: new naver.maps.Point(8, 8)
      }
    });
    
    // ë¯¸ë‹ˆë§µ í´ë¦­ ì´ë²¤íŠ¸ - íŒŒë…¸ë¼ë§ˆ ì´ë™
    naver.maps.Event.addListener(ROADVIEW_MINIMAP, 'click', function(e) {
      console.log('ğŸ”„ ë¯¸ë‹ˆë§µ í´ë¦­ë¨:', e.coord);
      
      // í´ë¦­í•œ ìœ„ì¹˜ë¡œ íŒŒë…¸ë¼ë§ˆ ì´ë™
      if (ROADVIEW) {
        ROADVIEW.setPosition(e.coord);
        
        // ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        positionMarker.setPosition(e.coord);
        
        // ë¯¸ë‹ˆë§µ ì¤‘ì‹¬ ì´ë™
        ROADVIEW_MINIMAP.setCenter(e.coord);
        
        // ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸ (ê°„ë‹¨í•œ ì¢Œí‘œ í‘œì‹œ)
        updateRoadviewLocationInfo(e.coord);
        
        console.log('âœ… íŒŒë…¸ë¼ë§ˆê°€ ìƒˆë¡œìš´ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤:', e.coord);
        showToast('ìƒˆë¡œìš´ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.', 'info');
      }
    });
    
    // ë¯¸ë‹ˆë§µ ì¤Œ ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸
    const zoomInBtn = document.querySelector('.minimap-zoom .zoom-in');
    const zoomOutBtn = document.querySelector('.minimap-zoom .zoom-out');
    
    if (zoomInBtn) {
      zoomInBtn.addEventListener('click', function() {
        const currentZoom = ROADVIEW_MINIMAP.getZoom();
        ROADVIEW_MINIMAP.setZoom(currentZoom + 1);
      });
    }
    
    if (zoomOutBtn) {
      zoomOutBtn.addEventListener('click', function() {
        const currentZoom = ROADVIEW_MINIMAP.getZoom();
        ROADVIEW_MINIMAP.setZoom(currentZoom - 1);
      });
    }
    
    // ë¯¸ë‹ˆë§µ í™•ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
    const expandBtn = document.querySelector('.minimap-expand-btn');
    if (expandBtn) {
      expandBtn.addEventListener('click', function() {
        const minimap = document.getElementById('roadviewMiniMap');
        if (minimap) {
          minimap.classList.toggle('expanded');
        }
      });
    }
    

    
    // íŒŒë…¸ë¼ë§ˆ ìœ„ì¹˜ ë³€ê²½ ì‹œ ë¯¸ë‹ˆë§µ ë™ê¸°í™”
    naver.maps.Event.addListener(ROADVIEW, 'position_changed', function() {
      const currentPosition = ROADVIEW.getPosition();
      ROADVIEW_MINIMAP.setCenter(currentPosition);
      positionMarker.setPosition(currentPosition);
      
      // ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
      updateRoadviewLocationInfo(currentPosition);
      
      // ë°©í–¥ ì—…ë°ì´íŠ¸ - ì  ìì²´ê°€ íšŒì „
      const pov = ROADVIEW.getPov();
      const rotation = pov.pan;
      positionMarker.setIcon({
        content: `
          <div style="
            width: 16px; 
            height: 16px; 
            background: #34C759; 
            border: 2px solid white; 
            border-radius: 50%; 
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transform: rotate(${rotation}deg);
          ">
            <div style="
              position: absolute;
              top: 2px;
              left: 50%;
              transform: translateX(-50%);
              width: 0;
              height: 0;
              border-left: 3px solid transparent;
              border-right: 3px solid transparent;
              border-bottom: 6px solid white;
            "></div>
          </div>
        `,
        anchor: new naver.maps.Point(8, 8)
      });
    });
    // íŒŒë…¸ë¼ë§ˆ POV ë³€ê²½ ì‹œ ë°©í–¥ í‘œì‹œ ì—…ë°ì´íŠ¸ - ì  ìì²´ê°€ íšŒì „
    naver.maps.Event.addListener(ROADVIEW, 'pov_changed', function() {
      const pov = ROADVIEW.getPov();
      const rotation = pov.pan;
      positionMarker.setIcon({
        content: `
          <div style="
            width: 16px; 
            height: 16px; 
            background: #34C759; 
            border: 2px solid white; 
            border-radius: 50%; 
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transform: rotate(${rotation}deg);
          ">
            <div style="
              position: absolute;
              top: 2px;
              left: 50%;
              transform: translateX(-50%);
              width: 0;
              height: 0;
              border-left: 3px solid transparent;
              border-right: 3px solid transparent;
              border-bottom: 6px solid white;
            "></div>
          </div>
        `,
        anchor: new naver.maps.Point(8, 8)
      });
    });
    
    // íŒŒë…¸ë¼ë§ˆ ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸
    naver.maps.Event.addListener(ROADVIEW, 'init', function() {
      console.log('âœ… íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™” ì™„ë£Œ');
      
      // íŒŒë…¸ë¼ë§ˆ í¬ê¸° ì¬ì¡°ì •
      setTimeout(() => {
        if (ROADVIEW) {
          ROADVIEW.setSize(new naver.maps.Size(roadviewDiv.offsetWidth, roadviewDiv.offsetHeight));
          naver.maps.Event.trigger(ROADVIEW, 'resize');
        }
      }, 100);
    });
    
    // íŒŒë…¸ë¼ë§ˆ ë¡œë“œ íƒ€ì„ì•„ì›ƒ (3ì´ˆ í›„ ì²´í¬)
    setTimeout(() => {
      if (ROADVIEW && roadviewDiv.children.length === 0) {
        console.warn('âš ï¸ íŒŒë…¸ë¼ë§ˆ ë¡œë“œ íƒ€ì„ì•„ì›ƒ - ëŒ€ì²´ ë©”ì‹œì§€ í‘œì‹œ');
        roadviewDiv.innerHTML = `
          <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          ">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ™ï¸</div>
            <h3>ê±°ë¦¬ë·°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì´ ì§€ì—­ì—ì„œëŠ” ë„¤ì´ë²„ ê±°ë¦¬ë·° ë°ì´í„°ê°€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            <p>ë‹¤ë¥¸ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§€ë„ë¡œ ëŒì•„ê°€ì„¸ìš”.</p>
            <button onclick="closePanorama()" style="
              margin-top: 20px;
              padding: 10px 20px;
              background: rgba(255,255,255,0.2);
              border: 1px solid rgba(255,255,255,0.3);
              color: white;
              border-radius: 5px;
              cursor: pointer;
            ">ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</button>
          </div>
        `;
      }
    }, 3000);
    
    // íŒŒë…¸ë¼ë§ˆ ì—ëŸ¬ ì´ë²¤íŠ¸
    naver.maps.Event.addListener(ROADVIEW, 'error', function(error) {
      console.error('âŒ íŒŒë…¸ë¼ë§ˆ ì—ëŸ¬:', error);
      showToast('ì´ ì§€ì—­ì—ì„œëŠ” ê±°ë¦¬ë·°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      
      // ì—ëŸ¬ ì‹œ ëŒ€ì²´ ë©”ì‹œì§€ í‘œì‹œ
      roadviewDiv.innerHTML = `
        <div style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          color: white;
          text-align: center;
          padding: 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        ">
          <div style="font-size: 48px; margin-bottom: 20px;">ğŸ™ï¸</div>
          <h3>ê±°ë¦¬ë·°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì´ ì§€ì—­ì—ì„œëŠ” ë„¤ì´ë²„ ê±°ë¦¬ë·° ë°ì´í„°ê°€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
          <p>ë‹¤ë¥¸ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§€ë„ë¡œ ëŒì•„ê°€ì„¸ìš”.</p>
          <button onclick="closePanorama()" style="
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 5px;
            cursor: pointer;
          ">ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      `;
    });
    
    // ì»¨í…Œì´ë„ˆ í‘œì‹œ - ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” í›„ í‘œì‹œ
    container.style.display = '';
    container.style.visibility = '';
    container.style.opacity = '';
    container.style.pointerEvents = '';
    container.classList.remove('hidden');
    
    // ì»¨í…Œì´ë„ˆê°€ í‘œì‹œëœ í›„ íŒŒë…¸ë¼ë§ˆ í¬ê¸° ì¬ì¡°ì •
    setTimeout(() => {
      if (ROADVIEW && roadviewDiv) {
        const width = roadviewDiv.offsetWidth;
        const height = roadviewDiv.offsetHeight;
        console.log('ğŸ”„ íŒŒë…¸ë¼ë§ˆ í¬ê¸° ì¬ì¡°ì •:', width, 'x', height);
        console.log('ğŸ” roadviewDiv ìì‹ ìš”ì†Œ ìˆ˜:', roadviewDiv.children.length);
        console.log('ğŸ” roadviewDiv ë‚´ìš©:', roadviewDiv.innerHTML.substring(0, 200) + '...');
        
        ROADVIEW.setSize(new naver.maps.Size(width, height));
        naver.maps.Event.trigger(ROADVIEW, 'resize');
        
        // íŒŒë…¸ë¼ë§ˆê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ëŒ€ì²´ ë©”ì‹œì§€ í‘œì‹œ
        if (roadviewDiv.children.length === 0) {
          console.warn('âš ï¸ íŒŒë…¸ë¼ë§ˆê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ - ëŒ€ì²´ ë©”ì‹œì§€ í‘œì‹œ');
          roadviewDiv.innerHTML = `
            <div style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 100%;
              color: white;
              text-align: center;
              padding: 20px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            ">
              <div style="font-size: 48px; margin-bottom: 20px;">ğŸ™ï¸</div>
              <h3>ê±°ë¦¬ë·°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
              <p>ì´ ì§€ì—­ì—ì„œëŠ” ë„¤ì´ë²„ ê±°ë¦¬ë·° ë°ì´í„°ê°€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
              <p>ë‹¤ë¥¸ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§€ë„ë¡œ ëŒì•„ê°€ì„¸ìš”.</p>
              <button onclick="closePanorama()" style="
                margin-top: 20px;
                padding: 10px 20px;
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                border-radius: 5px;
                cursor: pointer;
              ">ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
          `;
        }
      }
    }, 200);
    
    // ê°•ì œë¡œ ì»¨í…Œì´ë„ˆ í‘œì‹œ ìƒíƒœ í™•ì¸
    console.log('ğŸ” ì»¨í…Œì´ë„ˆ í‘œì‹œ ìƒíƒœ:', !container.classList.contains('hidden'));
    
    console.log('âœ… íŒŒë…¸ë¼ë§ˆê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.');
    showToast('ê±°ë¦¬ë·°ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'info');
    
  } catch (error) {
    console.error('âŒ íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    console.error('âŒ ì—ëŸ¬ ìƒì„¸:', error.message, error.stack);
    showToast('ì´ ì§€ì—­ì—ì„œëŠ” ê±°ë¦¬ë·°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
  }
}

// ë¡œë“œë·° ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
function updateRoadviewLocationInfo(position) {
  try {
    const roadNameEl = document.querySelector('.road-name');
    const addressEl = document.querySelector('.address');
    
    if (roadNameEl) {
      roadNameEl.textContent = `ìœ„ì¹˜: ${position.lat().toFixed(6)}, ${position.lng().toFixed(6)}`;
    }
    
    if (addressEl) {
      addressEl.textContent = 'í´ë¦­í•˜ì—¬ ì´ë™ ê°€ëŠ¥';
    }
  } catch (error) {
    console.error('âŒ ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
  }
}

// íŒŒë…¸ë¼ë§ˆ ë‹«ê¸° (ì§€ë„ë¡œ ëŒì•„ê°€ê¸°)
function closePanorama() {
  console.log('ğŸ”„ closePanorama í•¨ìˆ˜ í˜¸ì¶œë¨');
  try {
    const container = document.getElementById('roadviewContainer');
    console.log('ğŸ” roadviewContainer ì°¾ìŒ:', !!container);
    
    // ROADVIEW ê°ì²´ íƒ€ì… í™•ì¸ ë° ì•ˆì „í•œ ì •ë¦¬
    if (ROADVIEW) {
      console.log('ğŸ”„ ROADVIEW ì •ë¦¬ ì¤‘...');
      console.log('ğŸ” ROADVIEW íƒ€ì…:', typeof ROADVIEW);
      console.log('ğŸ” ROADVIEW ê°ì²´:', ROADVIEW);
      
      try {
        if (typeof ROADVIEW.setMap === 'function') {
          ROADVIEW.setMap(null);
        } else if (typeof ROADVIEW.destroy === 'function') {
          ROADVIEW.destroy();
        } else if (ROADVIEW.remove) {
          ROADVIEW.remove();
        }
      } catch (e) {
        console.warn('âš ï¸ ROADVIEW ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', e);
      }
      ROADVIEW = null;
    }
    
    // ROADVIEW_MINIMAP ê°ì²´ íƒ€ì… í™•ì¸ ë° ì•ˆì „í•œ ì •ë¦¬
    if (ROADVIEW_MINIMAP) {
      console.log('ğŸ”„ ROADVIEW_MINIMAP ì •ë¦¬ ì¤‘...');
      console.log('ğŸ” ROADVIEW_MINIMAP íƒ€ì…:', typeof ROADVIEW_MINIMAP);
      
      try {
        if (typeof ROADVIEW_MINIMAP.setMap === 'function') {
          ROADVIEW_MINIMAP.setMap(null);
        } else if (typeof ROADVIEW_MINIMAP.destroy === 'function') {
          ROADVIEW_MINIMAP.destroy();
        }
      } catch (e) {
        console.warn('âš ï¸ ROADVIEW_MINIMAP ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', e);
      }
      ROADVIEW_MINIMAP = null;
    }
    
    // ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸° - ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ê°•ì œ ìˆ¨ê¹€
    if (container) {
      container.classList.add('hidden');
      container.style.display = 'none';
      container.style.visibility = 'hidden';
      container.style.opacity = '0';
      container.style.pointerEvents = 'none';
      console.log('âœ… roadviewContainer ìˆ¨ê¹€ ì²˜ë¦¬ ì™„ë£Œ');
      console.log('ğŸ” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼:', container.style.display, container.style.visibility);
    } else {
      console.error('âŒ roadviewContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // ì§€ë„ ë‹¤ì‹œ ì´ˆê¸°í™”
    if (MAP) {
      naver.maps.Event.trigger(MAP, 'resize');
    }
    
    console.log('âœ… íŒŒë…¸ë¼ë§ˆê°€ ë‹«íˆê³  ì§€ë„ë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤.');
    showToast('ì§€ë„ë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤.', 'info');
  } catch (error) {
    console.error('âŒ íŒŒë…¸ë¼ë§ˆ ë‹«ê¸° ì¤‘ ì˜¤ë¥˜:', error);
    showToast('ë‹«ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ìœ„ì„±ì§€ë„ í† ê¸€ (ì§€ì í¸ì§‘ë„ëŠ” ë„¤ì´ë²„ì—ì„œ ì§€ì›í•˜ì§€ ì•ŠìŒ)
function toggleCadastralMap() {
  const cadastralBtn = document.getElementById('cadastralBtn');
  if (!cadastralBtn) return;
  
  try {
    if (cadastralBtn.classList.contains('active')) {
      // ìœ„ì„±ì§€ë„ ë¹„í™œì„±í™”
      cadastralBtn.classList.remove('active');
      MAP.setMapTypeId(naver.maps.MapTypeId.NORMAL);
      showToast('ì¼ë°˜ì§€ë„ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    } else {
      // ìœ„ì„±ì§€ë„ í™œì„±í™”
      cadastralBtn.classList.add('active');
      MAP.setMapTypeId(naver.maps.MapTypeId.SATELLITE);
      showToast('ìœ„ì„±ì§€ë„ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
  } catch (error) {
    console.error('âŒ ìœ„ì„±ì§€ë„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
    cadastralBtn.classList.remove('active');
    MAP.setMapTypeId(naver.maps.MapTypeId.NORMAL);
    showToast('ìœ„ì„±ì§€ë„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ê±°ë¦¬ì œê¸° í† ê¸€
function toggleDistanceMeasure() {
  const distanceBtn = document.getElementById('distanceBtn');
  if (!distanceBtn) return;
  
  if (IS_DISTANCE_MODE) {
    // ê±°ë¦¬ì œê¸° ëª¨ë“œ ë¹„í™œì„±í™”
    IS_DISTANCE_MODE = false;
    distanceBtn.classList.remove('active');
    clearDistanceMeasure();
    showToast('ê±°ë¦¬ì œê¸° ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
  } else {
    // ê±°ë¦¬ì œê¸° ëª¨ë“œ í™œì„±í™”
    IS_DISTANCE_MODE = true;
    distanceBtn.classList.add('active');
    showToast('ê±°ë¦¬ì œê¸° ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ê±°ë¦¬ë¥¼ ì¸¡ì •í•˜ì„¸ìš”.', 'info');
  }
}

// ê±°ë¦¬ì œê¸° ì´ˆê¸°í™”
function clearDistanceMeasure() {
  DISTANCE_POINTS = [];
  
  // í´ë¦¬ë¼ì¸ ì œê±°
  if (DISTANCE_POLYLINE) {
    DISTANCE_POLYLINE.setMap(null);
    DISTANCE_POLYLINE = null;
  }
  
  // ì •ë³´ì°½ ì œê±°
  if (DISTANCE_INFO_WINDOW) {
    DISTANCE_INFO_WINDOW.close();
    DISTANCE_INFO_WINDOW = null;
  }
  
  // ê±°ë¦¬ì œê¸° ê´€ë ¨ ë§ˆì»¤ë“¤ ì œê±°
  if (MAP._distanceMarkers) {
    MAP._distanceMarkers.forEach(marker => {
      marker.setMap(null);
    });
    MAP._distanceMarkers = [];
  }
  
  // ì „ì—­ ë§ˆì»¤ ë°°ì—´ë„ ì •ë¦¬
  DISTANCE_MARKERS.forEach(marker => {
    marker.setMap(null);
  });
  DISTANCE_MARKERS = [];
  
  DISTANCE_LABELS.forEach(label => {
    label.setMap(null);
  });
  DISTANCE_LABELS = [];
}

// ê±°ë¦¬ì œê¸° í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
function handleDistanceClick(e) {
  if (!IS_DISTANCE_MODE) return;
  
  const coord = e.coord;
  DISTANCE_POINTS.push(coord);
  
  // ê±°ë¦¬ì œê¸° ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”
  if (!MAP._distanceMarkers) {
    MAP._distanceMarkers = [];
  }
  
  // í´ë¦­í•œ ì§€ì ì— ë§ˆì»¤ í‘œì‹œ
  const marker = new naver.maps.Marker({
    position: coord,
    map: MAP,
    icon: {
      content: `<div style="width: 8px; height: 8px; background: #FF3B30; border: 2px solid white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>`,
      anchor: new naver.maps.Point(4, 4)
    }
  });
  
  // ë§ˆì»¤ì— ë²ˆí˜¸ í‘œì‹œ
  const label = new naver.maps.Marker({
    position: coord,
    map: MAP,
    icon: {
      content: `<div style="background: #FF3B30; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">${DISTANCE_POINTS.length}</div>`,
      anchor: new naver.maps.Point(10, 10)
    }
  });
  
  // ë§ˆì»¤ë“¤ì„ ë°°ì—´ì— ì €ì¥
  MAP._distanceMarkers.push(marker, label);
  DISTANCE_MARKERS.push(marker, label);
  
  // ë‘ ì  ì´ìƒì´ë©´ ì„  ê·¸ë¦¬ê¸°
  if (DISTANCE_POINTS.length >= 2) {
    if (DISTANCE_POLYLINE) {
      DISTANCE_POLYLINE.setMap(null);
    }
    
    DISTANCE_POLYLINE = new naver.maps.Polyline({
      path: DISTANCE_POINTS,
      strokeColor: '#FF3B30',
      strokeWeight: 3,
      strokeOpacity: 0.8,
      map: MAP
    });
    
    // ì´ ê±°ë¦¬ ê³„ì‚° ë° ì •ë³´ì°½ í‘œì‹œ
    updateDistanceInfo();
  }
}

// ê±°ë¦¬ ì •ë³´ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
function updateDistanceInfo() {
  if (DISTANCE_POINTS.length < 2) return;
  
  let totalDistance = 0;
  let segmentDistances = [];
  
  for (let i = 1; i < DISTANCE_POINTS.length; i++) {
    const segmentDistance = getDistanceMeters(DISTANCE_POINTS[i-1], DISTANCE_POINTS[i]);
    totalDistance += segmentDistance;
    segmentDistances.push(segmentDistance);
  }
  
  // ê¸°ì¡´ ì •ë³´ì°½ ì œê±°
  if (DISTANCE_INFO_WINDOW) {
    DISTANCE_INFO_WINDOW.close();
  }
  
  // ìƒˆë¡œìš´ ì •ë³´ì°½ ìƒì„±
  const infoContent = `
    <div style="padding: 10px; min-width: 200px;">
      <h4 style="margin: 0 0 8px 0; color: #FF3B30;">ğŸ“ ê±°ë¦¬ ì¸¡ì • ê²°ê³¼</h4>
      <div style="font-size: 12px; line-height: 1.4;">
        <div><strong>ì´ ê±°ë¦¬:</strong> ${(totalDistance / 1000).toFixed(2)}km</div>
        <div><strong>ì¸¡ì • ì§€ì :</strong> ${DISTANCE_POINTS.length}ê°œ</div>
        ${segmentDistances.map((dist, idx) => 
          `<div style="color: #666;">${idx + 1}â†’${idx + 2}: ${(dist / 1000).toFixed(2)}km</div>`
        ).join('')}
      </div>
      <div style="margin-top: 8px; font-size: 11px; color: #999;">
        ìš°í´ë¦­ìœ¼ë¡œ ì‚­ì œ ê°€ëŠ¥
      </div>
    </div>
  `;
  
  // ë§ˆì§€ë§‰ ì§€ì ì— ì •ë³´ì°½ í‘œì‹œ
  const lastPoint = DISTANCE_POINTS[DISTANCE_POINTS.length - 1];
  DISTANCE_INFO_WINDOW = new naver.maps.InfoWindow({
    content: infoContent,
    position: lastPoint,
    maxWidth: 250,
    backgroundColor: "#fff",
    borderColor: "#FF3B30",
    borderWidth: 2,
    anchorSize: new naver.maps.Size(10, 10),
    anchorColor: "#fff",
    pixelOffset: new naver.maps.Point(0, -10)
  });
  
  DISTANCE_INFO_WINDOW.open(MAP);
  
  showToast(`ì´ ê±°ë¦¬: ${(totalDistance / 1000).toFixed(2)}km (${DISTANCE_POINTS.length}ê°œ ì§€ì )`, 'info');
}

// ê±°ë¦¬ì œê¸° ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì¸¡ì • ì™„ë£Œ)
function handleDistanceDoubleClick(e) {
  if (!IS_DISTANCE_MODE) return;
  
  e.preventDefault();
  
  if (DISTANCE_POINTS.length >= 2) {
    let totalDistance = 0;
    for (let i = 1; i < DISTANCE_POINTS.length; i++) {
      totalDistance += getDistanceMeters(DISTANCE_POINTS[i-1], DISTANCE_POINTS[i]);
    }
    
    showToast(`ì¸¡ì • ì™„ë£Œ! ì´ ê±°ë¦¬: ${(totalDistance / 1000).toFixed(2)}km`, 'success');
    toggleDistanceMeasure(); // ëª¨ë“œ í•´ì œ
  }
}

// ê±°ë¦¬ì œê¸° ìš°í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì‚­ì œ)
function handleDistanceRightClick(e) {
  if (!IS_DISTANCE_MODE || DISTANCE_POINTS.length === 0) return;
  
  // ë„¤ì´ë²„ ì§€ë„ API ì´ë²¤íŠ¸ ê°ì²´ êµ¬ì¡°ì— ë§ê²Œ ì²˜ë¦¬
  try {
    if (e.preventDefault && typeof e.preventDefault === 'function') {
      e.preventDefault();
    }
  } catch (error) {
    console.log('âš ï¸ preventDefault í˜¸ì¶œ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', error);
  }
  
  if (confirm('í˜„ì¬ ì¸¡ì •ëœ ê±°ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    clearDistanceMeasure();
    showToast('ê±°ë¦¬ ì¸¡ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
  }
}