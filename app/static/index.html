<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>매물 프로토타입 v0.3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="/static/css/style.css?v=20250803">
  <script src="/static/js/main-new.js"></script>
  <script src="/static/js/listing-add.js"></script>
  <script>
    async function loadNaverMapsAPI() {
      return new Promise(async (resolve, reject) => {
        try {
          // 서버에서 API 키 가져오기
          console.log('🔑 API 설정 요청 중...');
          const response = await fetch('/api/config/maps');
          if (!response.ok) {
            throw new Error(`API 설정 요청 실패: ${response.status} ${response.statusText}`);
          }
          
          const config = await response.json();
          console.log('🔑 네이버 지도 API 설정 로드됨:', config);
          
          // API 키 유효성 검사
          if (!config.ncpKeyId) {
            throw new Error('API 키가 설정되지 않았습니다.');
          }
          
          // 인증 실패 처리 함수 정의
          window.navermap_authFailure = function () {
            console.error('❌ 네이버 지도 API 인증 실패');
            showToast('네이버 지도 API 인증에 실패했습니다. 관리자에게 문의해주세요.', 'error');
          };
          
          // 스크립트 생성 (문서에 따른 올바른 방식)
          const script = document.createElement('script');
          script.type = 'text/javascript';
          // ncpKeyId만 사용 (ncpClientId는 더 이상 사용하지 않음)
          const apiUrl = `https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${config.ncpKeyId}&submodules=geocoder,panorama`;
          script.src = apiUrl;
          console.log('🔗 네이버 지도 API URL:', apiUrl);
          
          // 로드 성공 시
          script.onload = function() {
            console.log('✅ 네이버 지도 API 스크립트 로드 완료');
            window.naverMapLoadStatus = 'loaded';
            
            // naver.maps API가 완전히 로드되었는지 확인
            const checkAPILoaded = () => {
              if (window.naver && window.naver.maps && 
                  typeof naver.maps.Map === 'function' && 
                  typeof naver.maps.LatLng === 'function' &&
                  typeof naver.maps.Size === 'function') {
                console.log('✅ 모든 naver.maps API가 로드됨');
                
                // initMap 함수가 정의될 때까지 대기
                const checkInitMap = () => {
                  if (typeof window.initMap === 'function') {
                    console.log('✅ initMap 함수 발견, 지도 초기화 시작');
                    // 약간의 지연을 두고 initMap 호출
                    setTimeout(() => {
                      try {
                        window.initMap();
                        resolve();
                      } catch (error) {
                        console.error('❌ initMap 실행 실패:', error);
                        reject(error);
                      }
                    }, 100);
                  } else {
                    console.log('🔄 initMap 함수 대기 중...');
                    setTimeout(checkInitMap, 100);
                  }
                };
                checkInitMap();
              } else {
                console.log('🔄 naver.maps API 로드 대기 중...');
                console.log('🔍 naver:', !!window.naver);
                console.log('🔍 naver.maps:', !!window.naver?.maps);
                console.log('🔍 naver.maps.Map:', typeof window.naver?.maps?.Map);
                console.log('🔍 naver.maps.LatLng:', typeof window.naver?.maps?.LatLng);
                console.log('🔍 naver.maps.Size:', typeof window.naver?.maps?.Size);
                setTimeout(checkAPILoaded, 100);
              }
            };
            
            // 즉시 체크 시작
            checkAPILoaded();
          };
          
          // 로드 실패 시
          script.onerror = function(error) {
            console.error('❌ 네이버 지도 API 로드 실패:', error);
            window.naverMapLoadStatus = 'error';
            reject(new Error('네이버 지도 API를 로드할 수 없습니다.'));
          };
          
          // 스크립트를 head에 추가
          document.head.appendChild(script);
          
        } catch (error) {
          console.error('❌ API 설정 로드 실패:', error);
          reject(error);
        }
      });
    }
    
    // 페이지 로드 시 네이버 지도 API 로드
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadNaverMapsAPI);
    } else {
      loadNaverMapsAPI();
    }
  </script>
</head>

<body>
      <!-- 로그인 필요 안내 화면 -->
    <div id="loginRequiredScreen" class="login-required-screen hidden">
      <div class="login-required-box">
        <h2 style="margin-bottom:16px;">로그인이 필요합니다</h2>
        <p style="margin-bottom:24px; color:#666;">매물 관리 시스템을 사용하려면 로그인해주세요.</p>
        
        <!-- 인라인 로그인 폼 -->
        <form id="inlineLoginForm" class="login-form">
          <div class="form-group">
            <label for="inlineLoginEmail">이메일</label>
            <input type="email" id="inlineLoginEmail" name="email" placeholder="email@example.com" required>
          </div>
          
          <div class="form-group">
            <label for="inlineLoginPassword">비밀번호</label>
            <input type="password" id="inlineLoginPassword" name="password" placeholder="비밀번호를 입력하세요" required>
          </div>
          
          <div id="inlineLoginErrorMsg" class="error-message"></div>
          
          <button type="submit" class="btn btn-primary">로그인</button>
          
          <div class="login-links">
            <a href="/register">회원가입</a>
            <a href="#" onclick="alert('관리자에게 문의하세요.')">비밀번호 찾기</a>
          </div>
        </form>
      </div>
    </div>

  <!-- 앱 종료 확인 다이얼로그 -->
  <div id="exitConfirmOverlay" class="exit-confirm-overlay hidden">
    <div class="exit-confirm-dialog">
      <div class="exit-confirm-header">
        <h3>앱 종료</h3>
      </div>
      <div class="exit-confirm-body">
        <div class="exit-confirm-message">
          앱을 종료하시겠습니까?
        </div>
        <div class="exit-confirm-buttons">
          <button type="button" class="exit-confirm-btn cancel" id="exitCancelBtn">취소</button>
          <button type="button" class="exit-confirm-btn confirm" id="exitConfirmBtn">확인</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 실제 앱 화면 -->
  <div id="appRoot" class="hidden">
    <!-- 상단바 -->
    <header id="topbar">
      <div class="office-info">
        <span id="officeName">SK공인중개사사무소</span>
        <span id="userRoleName" class="user-role-name">직책 / 사용자명</span>
        <!-- 모드 전환 버튼 -->
        <div class="mode-switch">
          <button id="modeToggleBtn" class="mode-toggle-btn" type="button">
            <span id="modeText">중개사</span>
            <span id="modeIcon">👥</span>
          </button>
        </div>
      </div>
      <div class="auth-links">
        <!-- 어드민 전용 메뉴 -->
        <div class="admin-only hidden">
          <button id="userManagementBtn" class="admin-btn" type="button">사용자 관리</button>
          <button id="adminStatsBtn" class="admin-btn" type="button">통계</button>
        </div>

        <a id="logoutBtn" href="/auth/logout" class="hidden">로그아웃</a>
      </div>
    </header>

    <!-- 상태카운트바 -->
    <div id="statusCounts">
      <div class="count-info">
        총 <span id="countTotal">0</span>건 / 필터 후 <span id="countFiltered">0</span>건
        <button id="addListingBtn" class="btn-add-listing">📝 매물등록</button>
      </div>
      <div class="sheet-controls">
        <div class="sheet-buttons">
          <!-- 매물장 버튼들이 여기에 동적으로 로드됩니다 -->
        </div>
        <button id="openGoogleSheetBtn" class="btn-sheet-open">
          선택된 시트 열기
        </button>
        
        <!-- 새로 추가: 새로고침 버튼 그룹 -->
        <div class="refresh-controls">
          <button id="refreshDataBtn" class="refresh-btn" title="매물 데이터 새로고침">
            🔄 새로고침
          </button>
          <span class="last-update">마지막 업데이트: <span id="lastUpdateTime">-</span></span>
        </div>
      </div>
    </div>
    
    <!-- 매물등록 모달 -->
    <div id="listingAddModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>매물등록</h2>
          <button class="modal-close" id="closeListingModal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="listingAddForm">
            <div class="form-row">
              <div class="form-group">
                <label for="접수날짜">접수날짜</label>
                <input type="text" id="접수날짜" name="접수날짜" placeholder="자동입력" readonly>
              </div>
              <div class="form-group">
                <label for="지역">지역</label>
                <input type="text" id="지역" name="지역" placeholder="예: 부평동">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="지번">지번</label>
                <input type="text" id="지번" name="지번" placeholder="예: 123-45">
              </div>
              <div class="form-group">
                <label for="건물명">건물명</label>
                <input type="text" id="건물명" name="건물명" placeholder="건물명">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="층수">층수</label>
                <input type="text" id="층수" name="층수" placeholder="예: 3층">
              </div>
              <div class="form-group">
                <label for="가게명">가게명</label>
                <input type="text" id="가게명" name="가게명" placeholder="가게명">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="분양">분양</label>
                <input type="text" id="분양" name="분양" placeholder="예: 임대">
              </div>
              <div class="form-group">
                <label for="실평수">실평수</label>
                <input type="text" id="실평수" name="실평수" placeholder="예: 15평">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="보증금">보증금</label>
                <input type="text" id="보증금" name="보증금" placeholder="숫자만 입력">
              </div>
              <div class="form-group">
                <label for="월세">월세</label>
                <input type="text" id="월세" name="월세" placeholder="숫자만 입력">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="권리금">권리금</label>
                <input type="text" id="권리금" name="권리금" placeholder="숫자만 입력">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group full-width">
                <label for="비고">비고</label>
                <textarea id="비고" name="비고" placeholder="비고사항" rows="3"></textarea>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="담당자">담당자</label>
                <input type="text" id="담당자" name="담당자" placeholder="담당자명">
              </div>
              <div class="form-group">
                <label for="연락처">연락처</label>
                <input type="text" id="연락처" name="연락처" placeholder="010-1234-5678" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="의뢰인">의뢰인</label>
                <input type="text" id="의뢰인" name="의뢰인" placeholder="의뢰인명">
              </div>
              <div class="form-group">
                <label for="비고3">비고3</label>
                <input type="text" id="비고3" name="비고3" placeholder="비고3">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="위반여부">위반여부</label>
                <input type="text" id="위반여부" name="위반여부" placeholder="예: 없음">
              </div>
              <div class="form-group">
                <label for="현수막번호">현수막번호</label>
                <input type="text" id="현수막번호" name="현수막번호" placeholder="예: A-001">
              </div>
            </div>
            
            <!-- 숨김 필드들 -->
            <input type="hidden" id="현황" name="현황" value="생">
            <input type="hidden" id="지역2" name="지역2" value="">
            <input type="hidden" id="간략한위치" name="간략한위치" value="">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" id="submitListing" class="btn-primary">등록</button>
          <button type="button" id="cancelListing" class="btn-secondary">취소</button>
        </div>
      </div>
    </div>

    <!-- 컨텍스트 메뉴 -->
    <div id="contextMenu" class="context-menu">
      <div class="context-menu-item" data-action="edit">
        <span>✏️</span> 수정
      </div>
      <div class="context-menu-separator"></div>
      <div class="context-menu-item danger" data-action="delete">
        <span>🗑️</span> 삭제
      </div>
    </div>

    <!-- 상단 필터바 -->
    <section id="topFilterBar" class="top-filter">
      <!-- 라벨 행 -->
      <div class="tf-row tf-labels">
        <div>지역</div><div>지번</div><div>건물명</div><div>층수</div><div>가게명</div>
        <div>분양</div><div>실평수</div><div>보증금</div><div>월세</div><div>권리금</div>
        <div>비고</div><div>담당자</div><div>지역2</div><div>연락처</div><div>의뢰인</div>
        <div>비고3</div><div class="tf-actions"></div>
      </div>
      <!-- 입력 행 -->
      <div class="tf-row tf-inputs">
        <input id="tf_region"    placeholder="쉼표로 복수검색">
        <input id="tf_jibun"     placeholder="예: 123-45, 12-3">
        <input id="tf_building"  placeholder="건물명">
        <input id="tf_floor"     placeholder="단일 또는 a-b">
        <input id="tf_store"     placeholder="가게명">
        <input id="tf_area_sale" placeholder="분양평 (>=값 또는 a‑b)">
        <input id="tf_area_real" placeholder="실평수 (>=값 또는 a‑b)">
        <input id="tf_deposit"   placeholder="보증금 (<=값 또는 a‑b)">
        <input id="tf_rent"      placeholder="월세 (<=값 또는 a‑b)">
        <input id="tf_premium"   placeholder="권리금 (<=값 또는 a‑b)">
        <input id="tf_note"      placeholder="비고">
        <input id="tf_manager"   placeholder="담당자">
        <input id="tf_region2"   placeholder="지역2">
        <input id="tf_phone"     placeholder="연락처">
        <input id="tf_client"    placeholder="의뢰인">
        <input id="tf_note3"     placeholder="비고3">
        <div class="tf-actions">
          <button id="topFilterApplyBtn" type="button">적용</button>
          <button id="topFilterResetBtn" type="button">초기화</button>
        </div>
      </div>
    </section>

    <!-- 본문 레이아웃 -->
    <div id="layout">
      <!-- 모바일 노치 (하단에 항상 보이는 노치) -->
      <div class="mobile-notch"></div>
      
      <!-- 1차 사이드바 -->
      <aside id="sidebar">
        <!-- 사이드바 토글 버튼 -->
        <div class="sidebar-toggle">
          <button id="sidebarToggleBtn" class="toggle-btn" title="사이드바 접기/펼치기">◀</button>
        </div>
        
        <!-- 고객 컨트롤 -->
        <div id="customerControls" class="block">
          <div class="button-row">
            <button id="customerListBtn" type="button">고객List</button>
            <button id="newCustomerBtn" type="button">신규등록</button>
          </div>
          
          <!-- 고객 목록 (고객List 클릭 시 표시) -->
          <div id="customerListContainer" class="customer-list-container hidden">
            <div id="customerListContent1">
              <!-- 고객 목록이 여기에 동적으로 로드됩니다 -->
            </div>
          </div>
          
          <!-- 선택된 고객 정보 (고객 선택 시 표시) -->
          <div id="selectedCustomerInfo" class="selected-customer-info hidden">
            <div id="customerInfoContent">
              <!-- 선택된 고객 정보가 여기에 표시됩니다 -->
            </div>
          </div>
        </div>



        <!-- 매물 리스트 컨트롤 -->
        <div id="listingControls" class="block">
          <div class="listing-header">
            <div class="listing-mode-buttons hidden">
              <button id="propertyListBtn" type="button" class="mode-btn active">매물리스트</button>
              <button id="briefingListBtn" type="button" class="mode-btn">브리핑리스트</button>
            </div>
          </div>
          <div class="listing-actions">
            <button id="viewAllBtn" type="button">전체보기</button>
            <button class="sortBtn" data-sort="latest" type="button">최신</button>
            <button class="sortBtn" data-sort="area"   type="button">면적</button>
            <button class="sortBtn" data-sort="deposit" type="button">보증금</button>
            <button class="sortBtn" data-sort="rent"    type="button">월세</button>
            <button class="sortBtn" data-sort="index"   type="button">색인</button>
          </div>
        </div>

        <!-- 매물 목록 -->
        <div id="listingSidebarWrap" class="block listings-block">
          <ul id="listingList"></ul>
          
          <!-- 클러스터 매물 목록 -->
          <div id="clusterList" class="cluster-list hidden">
            <div class="cluster-list-header">
              <label class="cluster-list-title">클러스터 매물 목록</label>
              <button id="clusterListCloseBtn" class="cluster-close-btn" type="button" title="닫기">×</button>
            </div>
            <ul id="clusterItemList"></ul>
          </div>
        </div>
      </aside>

      <!-- 2차 사이드바: panel-view 외 불필요한 div/컨테이너 제거, 구조 명확화 -->
      <aside id="secondaryPanel" class="sidepanel">
        <div class="panel-header">
          <span id="secondaryPanelTitle">상세정보</span>
          <div class="panel-controls">
            <button id="secondaryPanelToggleBtn" class="toggle-btn" title="2차 사이드바 접기/펼치기">◀</button>
            <button id="secondaryPanelClose" class="panel-close" type="button" onclick="closeSecondaryPanel(); return false;">×</button>
          </div>
        </div>
  <div class="panel-body" id="secondaryPanelBody">
    <div id="viewCustomerList" class="panel-view hidden">
      <div class="customer-list-container">
        <div id="customerListContent2"></div>
      </div>
    </div>
    <div id="viewCustomerDetail" class="panel-view hidden">
      <div class="customer-detail-container">
        <div id="customerDetailContent"></div>
      </div>
    </div>
    <div id="viewCustomerForm" class="panel-view hidden">
      <form id="customerForm"></form>
    </div>
    <div id="viewCustomerEdit" class="panel-view hidden">
      <form id="customerEditForm"></form>
    </div>
    <div id="viewListingDetail" class="panel-view hidden"></div>
  </div>
</aside>


      <!-- 메인 콘텐츠(지도) -->
      <main id="mainContent">
        <div id="mapWrap">
          <div id="map"></div>
          <div id="mapCenterCross"></div>
          
          <!-- 지도 컨트롤 -->
          <div id="mapControls" class="map-controls">
            <div class="map-control-group">
              <!-- 브리핑현황 필터 -->
              <div id="briefingFilter" class="briefing-filter map-control-briefing-filter">
                <button id="briefingFilterBtn" class="briefing-filter-btn" onclick="toggleBriefingFilter()">
                  브리핑
                </button>
                <div id="briefingFilterDropdown" class="briefing-filter-dropdown hidden">
                  <label class="briefing-option">
                    <input type="checkbox" id="filterNormal" checked>
                    <span class="briefing-status normal"></span>
                    <span class="briefing-text">일반</span>
                  </label>
                  <label class="briefing-option">
                    <input type="checkbox" id="filterPending" checked>
                    <span class="briefing-status pending"></span>
                    <span class="briefing-text">예정</span>
                  </label>
                  <label class="briefing-option">
                    <input type="checkbox" id="filterCompleted" checked>
                    <span class="briefing-status completed"></span>
                    <span class="briefing-text">완료</span>
                  </label>
                  <label class="briefing-option">
                    <input type="checkbox" id="filterOnHold" checked>
                    <span class="briefing-status onhold"></span>
                    <span class="briefing-text">보류</span>
                  </label>
                </div>
              </div>
              
              <button id="roadviewBtn" class="map-control-btn" title="로드뷰">
                <span class="control-icon">🛣️</span>
              </button>
              <button id="cadastralBtn" class="map-control-btn" title="위성지도">
                <span class="control-icon">🛰️</span>
              </button>
              <button id="distanceBtn" class="map-control-btn" title="거리제기">
                <span class="control-icon">📏</span>
              </button>
            </div>
          </div>
          
          <!-- 로드뷰 컨테이너 -->
          <div id="roadviewContainer" class="roadview-container hidden">
            <!-- 로드뷰 닫기 버튼 -->
            <button id="roadviewCloseBtn" class="roadview-close-btn">×</button>
            
            <!-- 로드뷰 메인 콘텐츠 -->
            <div id="roadview" class="roadview-content"></div>
            
            <!-- 주소 정보 박스 (미니맵 위에 배치) -->
            <div class="roadview-address-box">
              <div class="address-icon">📍</div>
              <div class="address-content">
                <div class="road-name">부평대로</div>
                <div class="address">인천 부평구 부평동</div>
              </div>
              <div class="address-actions">
                <span class="date-badge">2025년 05월(최신)</span>
                <span class="view-mode">3D</span>
              </div>
            </div>
            
            <!-- 로드뷰 미니맵 -->
            <div id="roadviewMiniMap" class="roadview-minimap">
              <div class="minimap-label">🗺️ 미니맵</div>
              <div class="minimap-header">
                <button class="minimap-menu-btn">☰</button>
              </div>
              <div class="minimap-content"></div>
              <div class="minimap-controls">
                <button class="minimap-expand-btn">⤢</button>
                <div class="minimap-zoom">
                  <button class="zoom-in">+</button>
                  <button class="zoom-out">-</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 전체보기 패널 -->
        <div id="fullListPanel" class="full-list-panel hidden">
          <div class="full-list-header">
            <span>전체보기</span>
            <button id="fullListCloseBtn" type="button" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: auto;">닫기</button>
          </div>
          <div id="fullListContent" class="full-list-body">
            <div style="padding:12px;color:#666;">(전체보기 내용이 여기 표시됩니다)</div>
          </div>
        </div>

        <!-- 전체 브리핑 리스트 패널 -->
        <div id="fullBriefingListPanel" class="full-list-panel hidden">
          <div class="full-list-header">
            <span>전체 브리핑 리스트</span>
            <button id="fullBriefingListCloseBtn" type="button" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: auto;">닫기</button>
          </div>
          <div id="fullBriefingListContent" class="full-list-body">
            <div style="padding:12px;color:#666;">(전체 브리핑 리스트 내용이 여기 표시됩니다)</div>
          </div>
        </div>
      </main>

    </div>

    <!-- 어드민 모달들 -->
    <!-- 사용자 관리 모달 -->
    <div id="userManagementModal" class="modal hidden">
      <div class="modal-content user-management-modal">
        <div class="modal-header">
          <h2>사용자 관리</h2>
          <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-container">
            <table class="user-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>이메일</th>
                  <th>이름</th>
                  <th>직책</th>
                  <th>역할</th>
                  <th>담당자명</th>
                  <th>상태</th>
                  <th>가입일</th>
                  <th>시트지정</th>
                  <th>작업</th>
                </tr>
              </thead>
              <tbody id="userListTableBody">
                <!-- 사용자 목록이 여기에 동적으로 로드됩니다 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 사용자 추가/편집 모달 -->
    <div id="userFormModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="userFormTitle">사용자 추가</h3>
          <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <div class="form-group">
              <label for="userEmail">이메일</label>
              <input type="email" id="userEmail" name="email" required>
            </div>
            <div class="form-group">
              <label for="userName">이름</label>
              <input type="text" id="userName" name="name" required>
            </div>
            <div class="form-group">
              <label for="userRole">역할</label>
              <select id="userRole" name="role">
                <option value="user">일반 사용자</option>
                <option value="manager">매니저</option>
                <option value="admin">관리자</option>
              </select>
            </div>
            <div class="form-group">
              <label for="userManagerName">담당자명</label>
              <input type="text" id="userManagerName" name="manager_name" placeholder="예: 남, 정, 오, 고문 등">
              <small style="color: #666; font-size: 12px;">
                일반 사용자의 경우 담당자명을 설정하면 해당 담당자 매물만 조회됩니다.
              </small>
            </div>
            <div class="form-group">
              <label>상태</label>
              <div id="userStatusGroup" class="radio-group">
                <label style="margin-right:12px;"><input type="radio" name="is_active" value="true"> 활성</label>
                <label><input type="radio" name="is_active" value="false"> 비활성</label>
              </div>
            </div>
            <div class="form-group">
              <label>비밀번호 재설정</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="password" id="userNewPassword" placeholder="새 비밀번호 (6자 이상)" style="flex: 1;">
                <button type="button" id="resetPasswordBtn" class="btn-secondary">재설정</button>
              </div>
              <small style="color: #666; font-size: 12px;">비밀번호를 잃어버린 경우에만 사용하세요.</small>
            </div>
            <div class="form-actions">
              <button type="submit" class="admin-btn">저장</button>
              <button type="button" id="userFormCancelBtn" class="btn-secondary">취소</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 통계 모달 -->
    <div id="adminStatsModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>관리자 통계</h3>
          <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div id="statsContent">
            <!-- 통계 내용이 여기에 동적으로 로드됩니다 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 시트지정 모달 -->
    <div id="sheetUrlModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>시트지정</h3>
          <button class="modal-close-btn" id="closeSheetUrlModal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="sheetUrlForm">
            <div class="form-group">
              <label for="sheetUrl">Google Sheets URL</label>
              <input type="url" id="sheetUrl" name="sheet_url" 
                     placeholder="https://docs.google.com/spreadsheets/d/..." required>
              <small style="color: #666; font-size: 12px;">
                사용자의 개인 매물장 시트 URL을 입력하세요.
              </small>
            </div>
            <div class="form-actions">
              <button type="submit" class="admin-btn">확인</button>
              <button type="button" id="sheetUrlCancelBtn" class="btn-secondary">취소</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // MarkerClustering 로딩 확인
      document.addEventListener('DOMContentLoaded', function() {
        console.log('🔍 초기 MarkerClustering 상태:', typeof MarkerClustering);
        if (typeof MarkerClustering !== 'undefined') {
          console.log('✅ MarkerClustering이 정상적으로 로드되었습니다.');
        } else {
          console.log('⏳ MarkerClustering이 아직 로드되지 않았습니다. 네이버 지도 API 로드 후 동적 로드됩니다.');
        }
      });

      // 뒤로가기 버튼 처리는 auth.js의 handlePopState에서 통합 관리
      // 기존 popstate 리스너 제거 - 중복 방지

      // 앱 종료 확인 다이얼로그 관련 함수들은 auth.js에서 통합 관리
      // 중복 제거 - auth.js의 showExitConfirmDialog 사용

      // 페이지 로드 시 히스토리 상태 설정 (모바일에서만)
      window.addEventListener('load', function() {
        // 모바일 환경에서만 히스토리 상태 설정
        if (window.location.pathname === '/' && typeof window.isMobileApp === 'function' && window.isMobileApp()) {
          window.history.replaceState({ page: 'main', preventBack: true }, '', '/');
          console.log('✅ 모바일 메인 페이지 히스토리 상태 설정 완료');
        }
      });

      // 페이지 초기 로드 시 히스토리 스택 정리 (모바일에서만)
      document.addEventListener('DOMContentLoaded', function() {
        // 모바일 환경에서만 히스토리 스택 정리
        if (window.location.pathname === '/' && typeof window.isMobileApp === 'function' && window.isMobileApp()) {
          // 현재 히스토리 상태를 메인 페이지로 설정
          window.history.replaceState({ page: 'main', preventBack: true }, '', '/');
          
          // 히스토리 길이가 1보다 크면 추가 히스토리 항목들을 제거
          if (window.history.length > 1) {
            console.log('📱 히스토리 스택 정리 중...');
            // 히스토리 스택을 정리하기 위해 현재 상태를 유지하면서 불필요한 항목들 제거
            window.history.go(-(window.history.length - 1));
            // 다시 메인 페이지 상태로 설정
            setTimeout(() => {
              window.history.replaceState({ page: 'main', preventBack: true }, '', '/');
              console.log('✅ 모바일 히스토리 스택 정리 완료');
            }, 100);
          }
        }
      });

      // 페이지 떠나기 방지 (모바일에서만)
      window.addEventListener('beforeunload', function(event) {
        // 모바일 환경에서만 페이지 떠나기 방지
        if (typeof window.isMobileApp === 'function' && window.isMobileApp()) {
          // 로그인 화면이 아닌 메인 앱 화면에서만 적용
          const loginScreen = document.getElementById('loginRequiredScreen');
          const appRoot = document.getElementById('appRoot');
          
          if (loginScreen && !loginScreen.classList.contains('hidden') && 
              appRoot && appRoot.classList.contains('hidden')) {
            // 로그인 화면에서는 기본 동작 허용
            return;
          }
          
          // 메인 앱 화면에서는 페이지 떠나기 방지
          console.log('📱 페이지 떠나기 시도 감지');
          event.preventDefault();
          event.returnValue = '앱을 종료하시겠습니까?';
          return '앱을 종료하시겠습니까?';
        }
      });

      // 히스토리 변경 감지 및 강제 복원 (모바일에서만)
      let isHistoryManipulation = false;
      
      function forceMainPage() {
        if (isHistoryManipulation) return;
        
        isHistoryManipulation = true;
        console.log('📱 강제 메인 페이지 복원');
        
        // URL이 메인 페이지가 아니면 강제로 변경
        if (window.location.pathname !== '/') {
          window.history.replaceState({ page: 'main', preventBack: true }, '', '/');
        }
        
        // 앱이 초기화되지 않았다면 초기화
        if (typeof window.initializeApp === 'function') {
          window.initializeApp();
        }
        
        setTimeout(() => {
          isHistoryManipulation = false;
        }, 100);
      }

      // URL 변경 감지 (모바일에서만)
      if (typeof window.isMobileApp === 'function' && window.isMobileApp()) {
        let currentUrl = window.location.href;
        setInterval(() => {
          if (window.location.href !== currentUrl) {
            currentUrl = window.location.href;
            if (window.location.pathname !== '/') {
              console.log('📱 URL 변경 감지:', window.location.pathname);
              forceMainPage();
            }
          }
        }, 100);
      }

      // 인라인 로그인 폼 이벤트 리스너
      document.addEventListener('DOMContentLoaded', function() {
        const inlineLoginForm = document.getElementById('inlineLoginForm');
        if (inlineLoginForm) {
          inlineLoginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('inlineLoginEmail').value.trim();
            const password = document.getElementById('inlineLoginPassword').value;
            const errorMsg = document.getElementById('inlineLoginErrorMsg');
            const loginBtn = e.target.querySelector('button[type="submit"]');
            
            // 입력 검증
            if (!email || !password) {
              showInlineError('이메일과 비밀번호를 모두 입력해주세요.');
              return;
            }
            
            const EMAIL_RE = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
            if (!EMAIL_RE.test(email)) {
              showInlineError('올바른 이메일 형식이 아닙니다.');
              return;
            }
            
            if (password.length < 6) {
              showInlineError('비밀번호는 최소 6자 이상이어야 합니다.');
              return;
            }
            
            // 로그인 버튼 비활성화
            const originalText = loginBtn.textContent;
            loginBtn.disabled = true;
            loginBtn.textContent = '로그인 중...';
            
            try {
              const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                  email: email,
                  password: password
                })
              });
              
              const data = await response.json();
              
              if (response.ok) {
                console.log('인라인 로그인 성공:', data);
                
                // localStorage에 사용자 정보 저장
                try {
                  const userEmail = (data && data.user && data.user.email) ? data.user.email : email;
                  const isAdmin = !!(data && data.user && data.user.role === 'admin');
                  localStorage.setItem('X-USER', userEmail);
                  if (isAdmin) {
                    localStorage.setItem('X-USER-ADMIN', 'true');
                  } else {
                    localStorage.removeItem('X-USER-ADMIN');
                  }
                } catch (e) {
                  console.warn('localStorage 저장 중 경고:', e);
                }

                // 사용자 정보 설정 및 로그인 화면 숨기기
                if (window.setCurrentUser) {
                  window.setCurrentUser(email);
                }
                if (window.hideLoginScreen) {
                  window.hideLoginScreen();
                }
                
                // 히스토리 초기화 및 고정
                if (window.initializeHistory && window.fixHistoryAfterLogin) {
                  window.initializeHistory();
                  window.fixHistoryAfterLogin();
                }
                
              } else {
                console.log('인라인 로그인 실패:', data.error);
                showInlineError(data.error || '로그인에 실패했습니다.');
              }
              
            } catch (error) {
              console.error('인라인 로그인 요청 중 오류:', error);
              showInlineError('서버 연결에 실패했습니다.');
            } finally {
              // 로그인 버튼 다시 활성화
              loginBtn.disabled = false;
              loginBtn.textContent = originalText;
            }
          });
        }
        
        function showInlineError(message) {
          const errorMsg = document.getElementById('inlineLoginErrorMsg');
          if (errorMsg) {
            errorMsg.textContent = message;
            errorMsg.classList.add('show');
            setTimeout(() => {
              errorMsg.classList.remove('show');
            }, 5000);
          }
        }
      });
    </script>
  </div>
</body>
</html>
